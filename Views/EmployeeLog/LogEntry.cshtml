@model VCashApp.Models.ViewModels.EmployeeLog.EmployeeLogEntryViewModel
@using VCashApp.Services
@using System.Globalization

@{
    Layout = "_Layout";
    ViewData["Title"] = "Registro de Empleados";

    string userName = ViewBag.UserName ?? "N/A";
    string pageName = ViewBag.PageName ?? "Crear";
    string unitName = ViewBag.UnidadName ?? "N/A";
    string branchName = ViewBag.BranchName ?? "N/A";
    string fullName = ViewBag.FullName ?? "N/A";

    bool canCreateLog = ViewBag.CanCreateLog ?? false;
    bool canEditLog = ViewBag.CanEditLog ?? false;
}

<style>
    /* estado resaltado para teclado */
    .autocomplete-item.highlight {
        background: var(--bs-light);
    }
    /* ancho mínimo para evitar “saltos” entre estados */
    .autocomplete-results {
        min-width: 420px;
    }
    /* cursor coherente */
    .autocomplete-item {
        cursor: pointer;
    }
</style>

<div class="form-container">
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info" id="statusMessage" style="display:none;"></div>
            <div class="alert alert-warning" id="confirmationMessage" style="display:none;"></div>
        </div>
    </div>

    <form id="employeeLogForm">
        @Html.AntiForgeryToken()
        <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="ri-user-search-fill"></i> Buscar empleado</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="autocomplete-container form-floating">
                            <input type="text"
                                   class="form-control"
                                   id="employeeSearchInput"
                                   placeholder="Cédula o Nombre"
                                   autocomplete="off"
                                   required>
                            <label for="employeeSearchInput">Buscar empleado (Cédula o Nombre)</label>

                            <div id="employeeSearchResults" class="autocomplete-results" 
                                role="listbox" aria-label="Resultados de empleados" aria-live="polite" style="display:none;">
                            </div>
                        </div>

                        <small class="form-text text-muted">Ejemplo: 12345 o Juan Pérez</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3" id="cardDatosEmpleado">
            <div class="card-header"><h5 class="mb-0"><i class="ri-account-box-fill"></i> Datos del empleado</h5></div>
            <div class="card-body">
                <div class="row d-flex justify-content-center align-items-center" id="employeeDetailsSection">
                    <div class="col-md-2">
                        <div class="reg-preview-container mt-2">
                            <img id="photo-preview" src="~/assets/profile-img/default-profile.jpg" alt="Vista Previa de Foto">
                        </div>
                    </div>
                    <div class="col-md-10">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="employeeIdDisplay" readonly placeholder="Número de Cédula">
                                    <label for="employeeIdDisplay">Número de Cédula</label>
                                </div>

                                <!-- hidden (se quedan igual) -->
                                <input type="hidden" id="hdnEmployeeId" name="EmployeeId" />
                                <input type="hidden" id="hdnFirstName" name="FirstName" />
                                <input type="hidden" id="hdnMiddleName" name="MiddleName" />
                                <input type="hidden" id="hdnLastName" name="LastName" />
                                <input type="hidden" id="hdnSecondLastName" name="SecondLastName" />
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="fullNameDisplay" readonly placeholder="Nombre del Empleado">
                                    <label for="fullNameDisplay">Nombre del Empleado</label>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="cargoNameDisplay" readonly placeholder="Cargo">
                                    <label for="cargoNameDisplay">Cargo</label>
                                </div>
                                <input type="hidden" id="hdnCargoId" name="CargoId">
                                <input type="hidden" id="hdnCargoName" name="CargoName">
                            </div>

                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="unitNameDisplay" readonly placeholder="Unidad">
                                    <label for="unitNameDisplay">Unidad</label>
                                </div>
                                <input type="hidden" id="hdnUnitId" name="UnitId">
                                <input type="hidden" id="hdnUnitName" name="UnitName">
                                <input type="hidden" id="hdnUnitType" name="UnitType">
                            </div>

                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="branchNameDisplay" readonly placeholder="Sucursal">
                                    <label for="branchNameDisplay">Sucursal</label>
                                </div>
                                <input type="hidden" id="hdnBranchId" name="BranchId">
                                <input type="hidden" id="hdnBranchName" name="BranchName">
                            </div>
                        </div>

                        <div class="small text-muted mt-2" id="empHint" style="display:none;">
                            Verifica que la información del empleado sea correcta.
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="card mt-3" id="cardRegistro">
            <div class="card-header"><h5 class="mb-0"><i class="ri-time-fill"></i> Registro</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="entryDateInput" name="EntryDate" readonly placeholder="YYYY-MM-DD">
                            <label for="entryDateInput">Fecha de Entrada</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="time" class="form-control" id="entryTimeInput" name="EntryTime" readonly placeholder="HH:MM">
                            <label for="entryTimeInput">Hora de Entrada</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="exitDateInput" name="ExitDate" readonly placeholder="YYYY-MM-DD">
                            <label for="exitDateInput">Fecha de Salida</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="time" class="form-control" id="exitTimeInput" name="ExitTime" readonly placeholder="HH:MM">
                            <label for="exitTimeInput">Hora de Salida</label>
                        </div>
                    </div>
                </div>

                <!-- Hidden -->
                <input type="hidden" id="hdnIsEntryRecorded" name="IsEntryRecorded" value="false" />
                <input type="hidden" id="hdnIsExitRecorded" name="IsExitRecorded" value="false" />
                <input type="hidden" id="hdnLogId" name="LogId" value="0" />
                <input type="hidden" id="hdnConfirmedValidation" name="ConfirmedValidation" />
            </div>
        </div>

        <div class="submit-container-reg form-group col-md-12 mt-4">
            <button type="button" class="btn btn-primary" id="btnRecordEntry" disabled>Registrar Entrada</button>
            <button type="button" class="btn btn-danger" id="btnRecordExit" disabled>Registrar Salida</button>
            <a asp-action="EmployeeLog" asp-controller="EmployeeLog" class="btn btn-exit">Cancelar</a>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            const employeeSearchInput   = $('#employeeSearchInput');
            const employeeSearchResults = $('#employeeSearchResults');

            const cardDatosEmpleado = $('#cardDatosEmpleado');
            const cardRegistro      = $('#cardRegistro');
            const employeeDetailsSection = $('#employeeDetailsSection');
            const empHint = $('#empHint');

            const photoPreview = $('#photo-preview');
            const fullNameDisplay = $('#fullNameDisplay');
            const employeeIdDisplay = $('#employeeIdDisplay');
            const cargoNameDisplay = $('#cargoNameDisplay');
            const unitNameDisplay = $('#unitNameDisplay');
            const branchNameDisplay = $('#branchNameDisplay');

            const entryDateInput = $('#entryDateInput');
            const entryTimeInput = $('#entryTimeInput');
            const exitDateInput = $('#exitDateInput');
            const exitTimeInput = $('#exitTimeInput');

            const btnRecordEntry = $('#btnRecordEntry');
            const btnRecordExit = $('#btnRecordExit');

            // Hidden fields
            const hdnEmployeeId = $('#hdnEmployeeId');
            const hdnFirstName = $('#hdnFirstName');
            const hdnMiddleName = $('#hdnMiddleName');
            const hdnLastName = $('#hdnLastName');
            const hdnSecondLastName = $('#hdnSecondLastName');
            const hdnCargoId = $('#hdnCargoId');
            const hdnCargoName = $('#hdnCargoName');
            const hdnUnitId = $('#hdnUnitId');
            const hdnUnitName = $('#hdnUnitName');
            const hdnBranchId = $('#hdnBranchId');
            const hdnBranchName = $('#hdnBranchName');
            const hdnUnitType = $('#hdnUnitType');
            const hdnIsEntryRecorded = $('#hdnIsEntryRecorded');
            const hdnIsExitRecorded = $('#hdnIsExitRecorded');
            const hdnLogId = $('#hdnLogId');
            const hdnConfirmedValidation = $('#hdnConfirmedValidation');

            // ===== Helpers búsqueda segura =====
            const SAFE_SEARCH = {
              seq: 0,
              ctrl: null,
              cache: new Map(),
              store: new Map(),
              highlighted: -1
            };

            function debounce(fn, delay){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); }; }
            function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

            function mergeAbort(controller, externalSignal){
              if (!externalSignal) return;
              if (externalSignal.aborted) controller.abort();
              else externalSignal.addEventListener('abort', () => controller.abort(), { once: true });
            }

            async function fetchWithTimeout(url, { timeout=5000, signal } = {}){
              const ctrl = new AbortController();
              const tid = setTimeout(()=> ctrl.abort(), timeout);
              mergeAbort(ctrl, signal);
              try {
                const res = await fetch(url, { signal: ctrl.signal, headers: { 'Accept':'application/json' }});
                return res;
              } finally { clearTimeout(tid); }
            }

            function isRetryableStatus(s){ return [408,429,500,502,503,504].includes(s); }

            async function fetchJsonSafe(url, { timeout = 5000, retries = 0, signal } = {}) {
              let attempt = 0;
              while (true) {
                try {
                  const res = await fetchWithTimeout(url, { timeout, signal });
                  if (res.status === 401 || res.status === 403){
                    window.location.href = '/Identity/Account/Login';
                    throw new Error('AuthRequired');
                  }
                  if (!res.ok) {
                    const text = await res.text().catch(()=> '');
                    const err = new Error(`HTTP ${res.status} ${res.statusText} ${text ? '- '+text : ''}`);
                    err.status = res.status;
                    throw err;
                  }
                  if (res.status === 204) return [];
                  return await res.json();
                } catch (err) {
                  if (signal?.aborted) throw err;
                  const status = err.status || 0;
                  const networkish = err.name === 'TypeError' || err.name === 'AbortError';
                  if (attempt < retries && (networkish || isRetryableStatus(status))) {
                    await wait(300 + Math.random()*300);
                    attempt++;
                    continue;
                  }
                  throw err;
                }
              }
            }

            function renderMessage(text, css='no-results-message'){
              employeeSearchResults
                .attr('aria-busy','false')
                .html(`<div class="autocomplete-item ${css}" role="option" aria-disabled="true">${text}</div>`)
                .show();
              SAFE_SEARCH.highlighted = -1;
            }

            function setLoadingUI(){
              employeeSearchResults
                .attr('aria-busy','true')
                .html(`<div class="autocomplete-item loading" role="option" aria-disabled="true">Buscando…</div>`)
                .show();
              SAFE_SEARCH.highlighted = -1;
            }

            function sanitize(text){
              return String(text ?? '').replace(/[<>&"]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[s]));
            }

            function renderResults(list){
              employeeSearchResults.empty().attr('aria-busy','false');

              if (list?.error){
                renderMessage(sanitize(list.error));
                return;
              }
              if (!Array.isArray(list) || list.length === 0){
                renderMessage('No se encontraron empleados.');
                return;
              }

              SAFE_SEARCH.store.clear();
              SAFE_SEARCH.highlighted = -1;

              const html = list.map((emp, idx) => {
                const key = `${Date.now()}_${idx}_${emp.employeeId}`;
                SAFE_SEARCH.store.set(key, emp);
                const img = (emp.photoThumbUrl && emp.photoThumbUrl.trim() !== '')
                  ? emp.photoThumbUrl
                  : '/assets/profile-img/default-profile.jpg';
                const displayName = sanitize(emp.employeeName);
                const displayDet  = `(${sanitize(emp.employeeId)}) - ${sanitize(emp.branchName || 'N/A')}`;
                return `
                  <div class="autocomplete-item"
                       role="option"
                       id="empopt_${idx}"
                       data-key="${key}"
                       aria-selected="false"
                       tabindex="-1">
                    <img src="${img}" class="autocomplete-item-icon" alt="">
                    <span class="autocomplete-item-text">${displayName}</span>
                    <span class="autocomplete-item-details">${displayDet}</span>
                  </div>`;
              }).join('');

              employeeSearchResults.html(html).show();
            }

            function highlight(indexDelta){
              const $items = employeeSearchResults.find('.autocomplete-item').not('.no-results-message,.loading');
              if ($items.length === 0) return;

              // quitar anterior
              if (SAFE_SEARCH.highlighted >= 0 && SAFE_SEARCH.highlighted < $items.length){
                const $prev = $items.eq(SAFE_SEARCH.highlighted);
                $prev.removeClass('highlight').attr('aria-selected','false');
              }

              // calcular nuevo
              if (indexDelta === 'reset'){ SAFE_SEARCH.highlighted = -1; return; }
              if (SAFE_SEARCH.highlighted === -1 && indexDelta > 0) SAFE_SEARCH.highlighted = 0;
              else SAFE_SEARCH.highlighted = (SAFE_SEARCH.highlighted + indexDelta + $items.length) % $items.length;

              const $cur = $items.eq(SAFE_SEARCH.highlighted);
              $cur.addClass('highlight').attr('aria-selected','true')[0]?.scrollIntoView({ block:'nearest' });
            }

            function pickHighlighted(){
              const $items = employeeSearchResults.find('.autocomplete-item').not('.no-results-message,.loading');
              if ($items.length === 0 || SAFE_SEARCH.highlighted < 0) return;
              const key = $items.eq(SAFE_SEARCH.highlighted).data('key');
              const emp = SAFE_SEARCH.store.get(key);
              if (emp) selectEmployee(emp);
            }

            function resetForm() {
                employeeSearchInput.val('');
                employeeSearchResults.hide().empty();

                cardDatosEmpleado.show();
                cardRegistro.show();
                employeeDetailsSection.show();
                empHint.hide();

                const fallback = '/assets/profile-img/default-profile.jpg';
                photoPreview.attr('src', fallback);
                const dzImg = document.querySelector('#log-photo-dropzone-preview img');
                if (dzImg) dzImg.src = fallback;

                fullNameDisplay.val('');
                employeeIdDisplay.val('');
                cargoNameDisplay.val('');
                unitNameDisplay.val('');
                branchNameDisplay.val('');

                entryDateInput.val('');
                entryTimeInput.val('');
                exitDateInput.val('');
                exitTimeInput.val('');
                entryDateInput.prop('readonly', true);
                entryTimeInput.prop('readonly', true);
                exitDateInput.prop('readonly', true);
                exitTimeInput.prop('readonly', true);

                hdnEmployeeId.val('');
                hdnFirstName.val('');
                hdnMiddleName.val('');
                hdnLastName.val('');
                hdnSecondLastName.val('');
                hdnCargoId.val('');
                hdnCargoName.val('');
                hdnUnitId.val('');
                hdnUnitName.val('');
                hdnBranchId.val('');
                hdnBranchName.val('');
                hdnUnitType.val('');
                hdnIsEntryRecorded.val('false');
                hdnIsExitRecorded.val('false');
                hdnLogId.val('0');
                hdnConfirmedValidation.val('');

                btnRecordEntry.prop('disabled', true);
                btnRecordExit.prop('disabled', true);
            }

            async function selectEmployee(employeeData) {
                hdnEmployeeId.val(employeeData.employeeId);
                hdnFirstName.val(employeeData.firstName);
                hdnMiddleName.val(employeeData.middleName);
                hdnLastName.val(employeeData.lastName);
                hdnSecondLastName.val(employeeData.secondLastName);
                hdnCargoId.val(employeeData.cargoId);
                hdnCargoName.val(employeeData.cargoName);
                hdnUnitId.val(employeeData.unitId);
                hdnUnitName.val(employeeData.unitName);
                hdnBranchId.val(employeeData.branchId);
                hdnBranchName.val(employeeData.branchName);
                hdnUnitType.val(employeeData.unitType);

                fullNameDisplay.val(employeeData.employeeName);
                employeeIdDisplay.val(employeeData.employeeId);
                cargoNameDisplay.val(employeeData.cargoName);
                unitNameDisplay.val(employeeData.unitName);
                branchNameDisplay.val(employeeData.branchName);

                const fallback = '/assets/profile-img/default-profile.jpg';
                const thumb = employeeData.photoThumbUrl && employeeData.photoThumbUrl.trim() !== ''
                    ? employeeData.photoThumbUrl
                    : fallback;

                photoPreview.attr('src', thumb);

                const dzImg = document.querySelector('#log-photo-dropzone-preview img');
                if (dzImg) dzImg.src = thumb;

                employeeSearchResults.hide();
                employeeSearchInput.val('');
                employeeDetailsSection.show();
                cardDatosEmpleado.show();
                cardRegistro.show();
                empHint.show();

                await getEmployeeLogStatus(employeeData.employeeId);
            }

            async function getEmployeeLogStatus(employeeId) {
              btnRecordEntry.prop('disabled', true);
              btnRecordExit.prop('disabled', true);
              hdnConfirmedValidation.val('');
              hdnLogId.val('0');

              entryDateInput.prop('readonly', true).val('');
              entryTimeInput.prop('readonly', true).val('');
              exitDateInput.prop('readonly', true).val('');
              exitTimeInput.prop('readonly', true).val('');

              const url = `@Url.Action("GetEmployeeLogStatus", "EmployeeLog")?employeeId=${employeeId}`;

              try {
                const data = await fetchJsonSafe(url, { timeout: 5000, retries: 0 });
                if (data.status === 'error') {
                  Swal.fire({ icon: 'error', title: 'Error', text: data.errorMessage || 'No se pudo obtener el estado.' });
                  return;
                }

                if (data.status === 'noEntry') {
                  btnRecordEntry.prop('disabled', false);
                  hdnIsEntryRecorded.val('true');
                  hdnIsExitRecorded.val('false');
                  entryDateInput.val(data.currentDate || '');
                  entryTimeInput.val(data.currentTime || '');
                  exitDateInput.val('').prop('readonly', true);
                  exitTimeInput.val('').prop('readonly', true);
                  return;
                }

                if (data.status === 'openEntry' || data.status === 'openEntryYesterday') {
                  btnRecordExit.prop('disabled', false);
                  hdnIsEntryRecorded.val('true');
                  hdnIsExitRecorded.val('true');
                  hdnLogId.val(data.openLogId);

                  entryDateInput.val(data.entryDate || '');
                  entryTimeInput.val(data.entryTime || '');

                  exitDateInput.val(data.currentDate || '').prop('readonly', false);
                  exitTimeInput.val(data.currentTime || '').prop('readonly', false);
                  return;
                }

                if (data.status === 'completeEntry') {
                  Swal.fire({ icon: 'warning', title: 'Estado del Registro', text: 'Este empleado ya tiene un registro completo para hoy.' });
                  btnRecordEntry.prop('disabled', true);
                  btnRecordExit.prop('disabled', true);

                  entryDateInput.val(data.entryDate || '');
                  entryTimeInput.val(data.entryTime || '');
                  exitDateInput.val(data.exitDate || '');
                  exitTimeInput.val(data.exitTime || '');
                  return;
                }
              } catch (err) {
                console.error('Estado log:', err);
                const msg = err.name === 'AbortError'
                  ? 'Consulta cancelada.'
                  : (err.message?.includes('HTTP 408') ? 'Tiempo de espera agotado.' : 'Error al obtener el estado del empleado.');
                Swal.fire({ icon: 'error', title: 'Error', text: msg });
              }
            }

            async function sendLogData(actionName, data, logIdForUpdate = null) {
                const isConfirmationRetry = data.ConfirmedValidation !== undefined && data.ConfirmedValidation !== null && data.ConfirmedValidation !== '';

                let url;
                if (actionName === "UpdateLog" && logIdForUpdate !== null) {
                    url = `/EmployeeLog/UpdateLog/${logIdForUpdate}`;
                } else if (actionName === "RecordEntryExit") {
                    url = `/EmployeeLog/RecordEntryExit`;
                } else {
                    Swal.close();
                    Swal.fire({ icon: 'error', title: 'Error Interno', text: 'Acción o ID de log no válidos.' });
                    return { success: false, message: 'Error interno: Acción o ID de log no válidos.' };
                }

                Swal.fire({
                    title: 'Procesando...',
                    text: 'Por favor, espere.',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Error HTTP: ${response.status} ${response.statusText} - ${errorText}`);
                        Swal.close();
                        Swal.fire({ icon: 'error', title: 'Error del Servidor', text: `Error del servidor: ${response.status} ${response.statusText}` });
                        return { success: false };
                    }

                    const result = await response.json();

                    if (result.needsConfirmation && !isConfirmationRetry) {
                        Swal.close();
                        Swal.fire({
                            title: 'Confirmación Requerida',
                            text: result.message + " ¿Desea continuar con el registro?",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Sí, Continuar',
                            cancelButtonText: 'Cancelar'
                        }).then(async (swalResult) => {
                            if (swalResult.isConfirmed) {
                                const currentLogDto = { ...data };
                                currentLogDto.ConfirmedValidation = result.validationType;
                                await sendLogData(actionName, currentLogDto, logIdForUpdate);
                            } else {
                                Swal.close();
                                Swal.fire('Cancelado', 'La operación ha sido cancelada.', 'info');
                            }
                        });
                        return { success: false, needsConfirmation: true };
                    } else {
                        if (result.success) {
                            Swal.close();
                            await Swal.fire({ icon: 'success', title: '¡Éxito!', text: result.message });
                            window.location.href = '@Url.Action("LogEntry", "EmployeeLog")';
                            return result;
                        } else {
                            Swal.close();
                            Swal.fire({ icon: 'error', title: 'Error', text: result.message });
                            hdnConfirmedValidation.val('');
                            return result;
                        }
                    }
                } catch (error) {
                    console.error('Error al enviar datos de registro:', error);
                    Swal.close();
                    Swal.fire({ icon: 'error', title: 'Error Inesperado', text: 'Ocurrió un error inesperado. Por favor, revise la consola.' });
                    hdnConfirmedValidation.val('');
                    return { success: false };
                }
            }

            // ==== Búsqueda (debounce + cancel + timeout + retry) ====
            const runSafeSearch = debounce(async function () {
              const term = employeeSearchInput.val().trim();

              if (!term){
                employeeSearchResults.hide().empty();
                resetCoreFields();
                SAFE_SEARCH.ctrl?.abort(); SAFE_SEARCH.ctrl=null;
                return;
              }

              const isNumber = /^\d+$/.test(term);
              const isTextSearchValid = term.length >= 2 && !isNumber;
              if (!(isNumber || isTextSearchValid)){
                employeeSearchResults.hide().empty();
                return;
              }

              const cached = SAFE_SEARCH.cache.get(term);
              if (cached){ renderResults(cached); }

              if (!navigator.onLine){
                if (!cached) renderMessage('Sin conexión. Intenta nuevamente.');
                return;
              }

              SAFE_SEARCH.ctrl?.abort();
              const ctrl = new AbortController();
              SAFE_SEARCH.ctrl = ctrl;
              const mySeq = ++SAFE_SEARCH.seq;

              if (!cached) setLoadingUI();

              const url = `@Url.Action("GetEmployeeInfo", "EmployeeLog")?searchInput=${encodeURIComponent(term)}`;

              try {
                const data = await fetchJsonSafe(url, { timeout: 5000, retries: 0, signal: ctrl.signal });

                if (mySeq !== SAFE_SEARCH.seq) return;
                SAFE_SEARCH.cache.set(term, data);
                if (SAFE_SEARCH.cache.size > 40) {
                  const firstKey = SAFE_SEARCH.cache.keys().next().value;
                  SAFE_SEARCH.cache.delete(firstKey);
                }

                renderResults(data);

              } catch (err) {
                if (ctrl.signal.aborted && mySeq !== SAFE_SEARCH.seq) return;
                if (!ctrl.signal.aborted){
                  console.error('Buscar empleados:', err);
                  const msg = (err.name === 'AbortError')
                    ? 'Búsqueda cancelada.'
                    : (err.message?.includes('HTTP 408') ? 'Tiempo de espera agotado.' : 'No se pudo completar la búsqueda. Intenta de nuevo.');
                  if (!cached) renderMessage(msg);
                }
              }
            }, 150);

            employeeSearchInput.on('input', runSafeSearch);
            employeeSearchInput.on('keydown', function(e){
              const hasItems = employeeSearchResults.is(':visible') && employeeSearchResults.find('.autocomplete-item').length>0;
              if (e.key === 'ArrowDown' && hasItems){ e.preventDefault(); highlight(+1); }
              else if (e.key === 'ArrowUp' && hasItems){ e.preventDefault(); highlight(-1); }
              else if (e.key === 'Enter' && hasItems){
                e.preventDefault();
                const $items = employeeSearchResults.find('.autocomplete-item').not('.no-results-message,.loading');
                if ($items.length === 1){
                  const key = $items.first().data('key'); const emp = SAFE_SEARCH.store.get(key);
                  if (emp) selectEmployee(emp);
                } else {
                  pickHighlighted();
                }
              } else if (e.key === 'Escape'){
                employeeSearchResults.hide().empty();
                SAFE_SEARCH.highlighted = -1;
              }
            });
            employeeSearchInput.on('blur', () => {
              setTimeout(()=> { employeeSearchResults.hide(); }, 150);
              SAFE_SEARCH.ctrl?.abort();
            });

            employeeSearchResults.on('mousedown', '.autocomplete-item', function(e){
              e.preventDefault();
              const $item = $(this);
              if ($item.hasClass('no-results-message') || $item.hasClass('loading')) return;
              const key = $item.data('key'); const emp = SAFE_SEARCH.store.get(key);
              if (emp){ SAFE_SEARCH.ctrl?.abort(); selectEmployee(emp); }
            });

            // === Botones ===
            btnRecordEntry.on('click', async function() {
                if (!hdnEmployeeId.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'Por favor, seleccione un empleado primero.' });
                    return;
                }
                if (!entryDateInput.val() || !entryTimeInput.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'La fecha y hora de entrada son obligatorias.' });
                    return;
                }
                const logDto = {
                    EmployeeId: parseInt(hdnEmployeeId.val()),
                    FirstName: hdnFirstName.val(),
                    MiddleName: hdnMiddleName.val(),
                    LastName: hdnLastName.val(),
                    SecondLastName: hdnSecondLastName.val(),
                    CargoId: parseInt(hdnCargoId.val()),
                    CargoName: hdnCargoName.val(),
                    UnitId: hdnUnitId.val(),
                    UnitName: hdnUnitName.val(),
                    BranchId: parseInt(hdnBranchId.val()),
                    BranchName: hdnBranchName.val(),
                    EntryDate: entryDateInput.val(),
                    EntryTime: entryTimeInput.val(),
                    ExitDate: null,
                    ExitTime: null,
                    IsEntryRecorded: true,
                    IsExitRecorded: false
                };
                await sendLogData('RecordEntryExit', logDto);
            });

            btnRecordExit.on('click', async function() {
                if (!hdnEmployeeId.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'Por favor, seleccione un empleado primero.' });
                    return;
                }
                if (!hdnLogId.val() || hdnLogId.val() === '0') {
                    Swal.fire({ icon:'error', title:'Error', text:'No se encontró un registro abierto para registrar la salida.' });
                    return;
                }
                if (!exitDateInput.val() || !exitTimeInput.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'La fecha y hora de salida son obligatorias.' });
                    return;
                }
                if (!entryDateInput.val() || !entryTimeInput.val()) {
                    Swal.fire({ icon:'error', title:'Error Interno', text:'La fecha u hora de entrada del registro original no está disponible. Intente seleccionar el empleado de nuevo.' });
                    return;
                }
                const logDto = {
                    EmployeeId: parseInt(hdnEmployeeId.val()),
                    FirstName: hdnFirstName.val(),
                    MiddleName: hdnMiddleName.val(),
                    LastName: hdnLastName.val(),
                    SecondLastName: hdnSecondLastName.val(),
                    CargoId: parseInt(hdnCargoId.val()),
                    CargoName: hdnCargoName.val(),
                    UnitId: hdnUnitId.val(),
                    UnitName: hdnUnitName.val(),
                    BranchId: parseInt(hdnBranchId.val()),
                    BranchName: hdnBranchName.val(),
                    EntryDate: entryDateInput.val(),
                    EntryTime: entryTimeInput.val(),
                    ExitDate: exitDateInput.val(),
                    ExitTime: exitTimeInput.val(),
                    IsEntryRecorded: true,
                    IsExitRecorded: true
                };
                if (hdnConfirmedValidation.val() !== '') {
                    logDto.ConfirmedValidation = hdnConfirmedValidation.val();
                }
                await sendLogData('UpdateLog', logDto, parseInt(hdnLogId.val()));
            });

            function resetCoreFields(){
                hdnEmployeeId.val('');
                fullNameDisplay.val('');
                employeeIdDisplay.val('');
                branchNameDisplay.val('');
                btnRecordEntry.prop('disabled', true);
                btnRecordExit.prop('disabled', true);
            }

            // Init
            resetForm();
        });
    </script>
}
