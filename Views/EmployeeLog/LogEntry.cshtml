@model VCashApp.Models.Entities.SegRegistroEmpleado
@using VCashApp.Services
@using VCashApp.Models.Entities
@using System.Globalization

@{
    Layout = "_Layout";
    ViewData["Title"] = "Registro de Empleados";

    string userName = ViewBag.UserName ?? "N/A";
    string pageName = ViewBag.PageName ?? "Crear";
    string unitName = ViewBag.UnidadName ?? "N/A";
    string branchName = ViewBag.BranchName ?? "N/A";
    string fullName = ViewBag.FullName ?? "N/A";

    bool canCreateLog = ViewBag.CanCreateLog ?? false;
    bool canEditLog = ViewBag.CanEditLog ?? false;
}

<div class="form-container">
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info" id="statusMessage" style="display:none;"></div>
            <div class="alert alert-warning" id="confirmationMessage" style="display:none;"></div>
        </div>
    </div>

    <form id="employeeLogForm">
        @Html.AntiForgeryToken()
        <div class="card">
            <div class="card-header"><h5 class="mb-0">🔎 Buscar empleado</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="autocomplete-container form-floating">
                            <input type="text"
                                   class="form-control"
                                   id="employeeSearchInput"
                                   placeholder="Cédula o Nombre"
                                   autocomplete="off"
                                   required>
                            <label for="employeeSearchInput">Buscar empleado (Cédula o Nombre)</label>

                            <div id="employeeSearchResults" class="autocomplete-results" style="display:none;"></div>
                        </div>

                        <small class="form-text text-muted">Ejemplo: 12345 o Juan Pérez</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3" id="cardDatosEmpleado">
            <div class="card-header"><h5 class="mb-0">👤 Datos del empleado</h5></div>
            <div class="card-body">
                <div class="row d-flex justify-content-center align-items-center" id="employeeDetailsSection">
                    <div class="col-md-2">
                        <div class="reg-preview-container">
                            <img id="photo-preview" src="~/assets/profile-img/default-profile.jpg" alt="Vista Previa de Foto">
                        </div>
                    </div>
                    <div class="col-md-10">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="employeeIdDisplay" readonly placeholder="Número de Cédula">
                                    <label for="employeeIdDisplay">Número de Cédula</label>
                                </div>

                                <!-- hidden (se quedan igual) -->
                                <input type="hidden" id="hdnEmployeeId" name="EmployeeId" />
                                <input type="hidden" id="hdnFirstName" name="FirstName" />
                                <input type="hidden" id="hdnMiddleName" name="MiddleName" />
                                <input type="hidden" id="hdnLastName" name="LastName" />
                                <input type="hidden" id="hdnSecondLastName" name="SecondLastName" />
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="fullNameDisplay" readonly placeholder="Nombre del Empleado">
                                    <label for="fullNameDisplay">Nombre del Empleado</label>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="cargoNameDisplay" readonly placeholder="Cargo">
                                    <label for="cargoNameDisplay">Cargo</label>
                                </div>
                                <input type="hidden" id="hdnCargoId" name="CargoId">
                                <input type="hidden" id="hdnCargoName" name="CargoName">
                            </div>

                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="unitNameDisplay" readonly placeholder="Unidad">
                                    <label for="unitNameDisplay">Unidad</label>
                                </div>
                                <input type="hidden" id="hdnUnitId" name="UnitId">
                                <input type="hidden" id="hdnUnitName" name="UnitName">
                                <input type="hidden" id="hdnUnitType" name="UnitType">
                            </div>

                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="branchNameDisplay" readonly placeholder="Sucursal">
                                    <label for="branchNameDisplay">Sucursal</label>
                                </div>
                                <input type="hidden" id="hdnBranchId" name="BranchId">
                                <input type="hidden" id="hdnBranchName" name="BranchName">
                            </div>
                        </div>

                        <div class="small text-muted mt-2" id="empHint" style="display:none;">
                            Verifica que la información del empleado sea correcta.
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="card mt-3" id="cardRegistro">
            <div class="card-header"><h5 class="mb-0">⏱️ Registro</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="entryDateInput" name="EntryDate" readonly placeholder="YYYY-MM-DD">
                            <label for="entryDateInput">Fecha de Entrada</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="time" class="form-control" id="entryTimeInput" name="EntryTime" readonly placeholder="HH:MM">
                            <label for="entryTimeInput">Hora de Entrada</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="exitDateInput" name="ExitDate" readonly placeholder="YYYY-MM-DD">
                            <label for="exitDateInput">Fecha de Salida</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="time" class="form-control" id="exitTimeInput" name="ExitTime" readonly placeholder="HH:MM">
                            <label for="exitTimeInput">Hora de Salida</label>
                        </div>
                    </div>
                </div>

                <!-- Hidden -->
                <input type="hidden" id="hdnIsEntryRecorded" name="IsEntryRecorded" value="false" />
                <input type="hidden" id="hdnIsExitRecorded" name="IsExitRecorded" value="false" />
                <input type="hidden" id="hdnLogId" name="LogId" value="0" />
                <input type="hidden" id="hdnConfirmedValidation" name="ConfirmedValidation" />
            </div>
        </div>

        <div class="submit-container-reg form-group col-md-12 mt-4">
            <button type="button" class="btn btn-primary" id="btnRecordEntry" disabled>Registrar Entrada</button>
            <button type="button" class="btn btn-danger" id="btnRecordExit" disabled>Registrar Salida</button>
            <button type="button" class="btn btn-exit" id="btnCancel">Cancelar</button>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            const employeeSearchInput   = $('#employeeSearchInput');
            const employeeSearchResults = $('#employeeSearchResults');

            const cardDatosEmpleado = $('#cardDatosEmpleado');
            const cardRegistro      = $('#cardRegistro');
            const employeeDetailsSection = $('#employeeDetailsSection');
            const empHint = $('#empHint');

            const photoPreview = $('#photo-preview');
            const fullNameDisplay = $('#fullNameDisplay');
            const employeeIdDisplay = $('#employeeIdDisplay');
            const cargoNameDisplay = $('#cargoNameDisplay');
            const unitNameDisplay = $('#unitNameDisplay');
            const branchNameDisplay = $('#branchNameDisplay');

            const entryDateInput = $('#entryDateInput');
            const entryTimeInput = $('#entryTimeInput');
            const exitDateInput = $('#exitDateInput');
            const exitTimeInput = $('#exitTimeInput');

            const btnRecordEntry = $('#btnRecordEntry');
            const btnRecordExit = $('#btnRecordExit');
            const btnCancel = $('#btnCancel');

            // Hidden fields
            const hdnEmployeeId = $('#hdnEmployeeId');
            const hdnFirstName = $('#hdnFirstName');
            const hdnMiddleName = $('#hdnMiddleName');
            const hdnLastName = $('#hdnLastName');
            const hdnSecondLastName = $('#hdnSecondLastName');
            const hdnCargoId = $('#hdnCargoId');
            const hdnCargoName = $('#hdnCargoName');
            const hdnUnitId = $('#hdnUnitId');
            const hdnUnitName = $('#hdnUnitName');
            const hdnBranchId = $('#hdnBranchId');
            const hdnBranchName = $('#hdnBranchName');
            const hdnUnitType = $('#hdnUnitType');
            const hdnIsEntryRecorded = $('#hdnIsEntryRecorded');
            const hdnIsExitRecorded = $('#hdnIsExitRecorded');
            const hdnLogId = $('#hdnLogId');
            const hdnConfirmedValidation = $('#hdnConfirmedValidation');

            // ===== Helpers búsqueda segura =====
            const SAFE_SEARCH = {
              seq: 0,
              ctrl: null
            };

            function debounce(fn, delay) {
              let t; return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(null, args), delay);
              };
            }

            function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

            function mergeAbort(controller, externalSignal){
              if (!externalSignal) return;
              if (externalSignal.aborted) controller.abort();
              else externalSignal.addEventListener('abort', () => controller.abort(), { once: true });
            }

            async function fetchWithTimeout(url, { timeout = 8000, signal } = {}) {
              const ctrl = new AbortController();
              const tid = setTimeout(() => ctrl.abort(), timeout);
              mergeAbort(ctrl, signal);
              try {
                const res = await fetch(url, { signal: ctrl.signal });
                return res;
              } finally {
                clearTimeout(tid);
              }
            }

            function isRetryableStatus(status){
              return [408, 429, 500, 502, 503, 504].includes(status);
            }

            async function fetchJsonSafe(url, { timeout = 8000, retries = 1, signal } = {}) {
              let attempt = 0;
              while (true) {
                try {
                  const res = await fetchWithTimeout(url, { timeout, signal });
                  if (!res.ok) {
                    const text = await res.text().catch(()=> '');
                    const err = new Error(`HTTP ${res.status} ${res.statusText} ${text ? '- '+text : ''}`);
                    err.status = res.status;
                    throw err;
                  }
                  return await res.json();
                } catch (err) {
                  // Si nos cancelaron, salimos silenciosamente
                  if (signal?.aborted) throw err;
                  const status = err.status || 0;
                  const networkish = err.name === 'TypeError' || err.name === 'AbortError';
                  if (attempt < retries && (networkish || isRetryableStatus(status))) {
                    await wait(300 * Math.pow(2, attempt)); // backoff
                    attempt++;
                    continue;
                  }
                  throw err;
                }
              }
            }

            function renderSearchMessage($results, text, extraClass = 'no-results-message'){
              $results
                .html(`<div class="autocomplete-item ${extraClass}">${text}</div>`)
                .show();
            }

            function setSearchingUI($results){
              renderSearchMessage($results, 'Buscando…', 'loading');
            }

            function resetForm() {
                employeeSearchInput.val('');
                employeeSearchResults.hide().empty();

                cardDatosEmpleado.show();
                cardRegistro.show();
                employeeDetailsSection.show(); // con placeholders
                empHint.hide();

                photoPreview.attr('src', '/assets/profile-img/default-profile.jpg');
                fullNameDisplay.val('');
                employeeIdDisplay.val('');
                cargoNameDisplay.val('');
                unitNameDisplay.val('');
                branchNameDisplay.val('');

                entryDateInput.val('');
                entryTimeInput.val('');
                exitDateInput.val('');
                exitTimeInput.val('');
                entryDateInput.prop('readonly', true);
                entryTimeInput.prop('readonly', true);
                exitDateInput.prop('readonly', true);
                exitTimeInput.prop('readonly', true);

                hdnEmployeeId.val('');
                hdnFirstName.val('');
                hdnMiddleName.val('');
                hdnLastName.val('');
                hdnSecondLastName.val('');
                hdnCargoId.val('');
                hdnCargoName.val('');
                hdnUnitId.val('');
                hdnUnitName.val('');
                hdnBranchId.val('');
                hdnBranchName.val('');
                hdnUnitType.val('');
                hdnIsEntryRecorded.val('false');
                hdnIsExitRecorded.val('false');
                hdnLogId.val('0');
                hdnConfirmedValidation.val('');

                btnRecordEntry.prop('disabled', true);
                btnRecordExit.prop('disabled', true);
            }

            async function selectEmployee(employeeData) {
                hdnEmployeeId.val(employeeData.employeeId);
                hdnFirstName.val(employeeData.firstName);
                hdnMiddleName.val(employeeData.middleName);
                hdnLastName.val(employeeData.lastName);
                hdnSecondLastName.val(employeeData.secondLastName);
                hdnCargoId.val(employeeData.cargoId);
                hdnCargoName.val(employeeData.cargoName);
                hdnUnitId.val(employeeData.unitId);
                hdnUnitName.val(employeeData.unitName);
                hdnBranchId.val(employeeData.branchId);
                hdnBranchName.val(employeeData.branchName);
                hdnUnitType.val(employeeData.unitType);

                fullNameDisplay.val(employeeData.employeeName);
                employeeIdDisplay.val(employeeData.employeeId);
                cargoNameDisplay.val(employeeData.cargoName);
                unitNameDisplay.val(employeeData.unitName);
                branchNameDisplay.val(employeeData.branchName);

                const photoSrc = employeeData.photoUrl ? `/${employeeData.photoUrl.startsWith('/') ? employeeData.photoUrl.substring(1) : employeeData.photoUrl}` : '/assets/profile-img/default-profile.jpg';
                photoPreview.attr('src', photoSrc);

                employeeSearchResults.hide();
                employeeSearchInput.val('');

                // Muestra bloques 2 y 3
                employeeDetailsSection.show();
                cardDatosEmpleado.show();
                cardRegistro.show();
                empHint.show();

                await getEmployeeLogStatus(employeeData.employeeId);
            }

            async function getEmployeeLogStatus(employeeId) {
                btnRecordEntry.prop('disabled', true);
                btnRecordExit.prop('disabled', true);
                hdnConfirmedValidation.val('');
                hdnLogId.val('0');

                entryDateInput.prop('readonly', true).val('');
                entryTimeInput.prop('readonly', true).val('');
                exitDateInput.prop('readonly', true).val('');
                exitTimeInput.prop('readonly', true).val('');

                try {
                    const response = await fetch(`@Url.Action("GetEmployeeLogStatus", "EmployeeLog")?employeeId=${employeeId}`);
                    const data = await response.json();

                    if (data.status === 'error') {
                        Swal.fire({ icon: 'error', title: 'Error', text: data.errorMessage });
                        return;
                    }

                    if (data.status === 'noEntry') {
                        btnRecordEntry.prop('disabled', false);
                        hdnIsEntryRecorded.val('true');
                        hdnIsExitRecorded.val('false');

                        entryDateInput.val(data.currentDate);
                        entryTimeInput.val(data.currentTime);
                        exitDateInput.val('');
                        exitTimeInput.val('');
                        exitDateInput.prop('readonly', true);
                        exitTimeInput.prop('readonly', true);

                    } else if (data.status === 'openEntry' || data.status === 'openEntryYesterday') {
                        btnRecordExit.prop('disabled', false);
                        hdnIsEntryRecorded.val('true');
                        hdnIsExitRecorded.val('true');
                        hdnLogId.val(data.openLogId);

                        entryDateInput.val(data.entryDate || '');
                        entryTimeInput.val(data.entryTime || '');

                        exitDateInput.val(data.currentDate || '');
                        exitTimeInput.val(data.currentTime || '');
                        exitDateInput.prop('readonly', false);
                        exitTimeInput.prop('readonly', false);

                    } else if (data.status === 'completeEntry') {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Estado del Registro',
                            text: 'Este empleado ya tiene un registro completo (entrada y salida) para hoy.'
                        });
                        btnRecordEntry.prop('disabled', true);
                        btnRecordExit.prop('disabled', true);

                        entryDateInput.val(data.entryDate);
                        entryTimeInput.val(data.entryTime);
                        exitDateInput.val(data.exitDate);
                        exitTimeInput.val(data.exitTime);

                        entryDateInput.prop('readonly', true);
                        entryTimeInput.prop('readonly', true);
                        exitDateInput.prop('readonly', true);
                        exitTimeInput.prop('readonly', true);
                    }
                } catch (error) {
                    console.error('Error al obtener estado del registro de empleado:', error);
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Error al obtener el estado del empleado.' });
                }
            }

            async function sendLogData(actionName, data, logIdForUpdate = null) {
                const isConfirmationRetry = data.ConfirmedValidation !== undefined && data.ConfirmedValidation !== null && data.ConfirmedValidation !== '';

                let url;
                if (actionName === "UpdateLog" && logIdForUpdate !== null) {
                    url = `/EmployeeLog/UpdateLog/${logIdForUpdate}`;
                } else if (actionName === "RecordEntryExit") {
                    url = `/EmployeeLog/RecordEntryExit`;
                } else {
                    Swal.close();
                    Swal.fire({ icon: 'error', title: 'Error Interno', text: 'Acción o ID de log no válidos.' });
                    return { success: false, message: 'Error interno: Acción o ID de log no válidos.' };
                }

                Swal.fire({
                    title: 'Procesando...',
                    text: 'Por favor, espere.',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Error HTTP: ${response.status} ${response.statusText} - ${errorText}`);
                        Swal.close();
                        Swal.fire({ icon: 'error', title: 'Error del Servidor', text: `Error del servidor: ${response.status} ${response.statusText}` });
                        return { success: false };
                    }

                    const result = await response.json();

                    if (result.needsConfirmation && !isConfirmationRetry) {
                        Swal.close();
                        Swal.fire({
                            title: 'Confirmación Requerida',
                            text: result.message + " ¿Desea continuar con el registro?",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Sí, Continuar',
                            cancelButtonText: 'Cancelar'
                        }).then(async (swalResult) => {
                            if (swalResult.isConfirmed) {
                                const currentLogDto = { ...data };
                                currentLogDto.ConfirmedValidation = result.validationType;
                                await sendLogData(actionName, currentLogDto, logIdForUpdate);
                            } else {
                                Swal.close();
                                Swal.fire('Cancelado', 'La operación ha sido cancelada.', 'info');
                            }
                        });
                        return { success: false, needsConfirmation: true };
                    } else {
                        if (result.success) {
                            Swal.close();
                            await Swal.fire({ icon: 'success', title: '¡Éxito!', text: result.message });
                            window.location.href = '@Url.Action("LogEntry", "EmployeeLog")';
                            return result;
                        } else {
                            Swal.close();
                            Swal.fire({ icon: 'error', title: 'Error', text: result.message });
                            hdnConfirmedValidation.val('');
                            return result;
                        }
                    }
                } catch (error) {
                    console.error('Error al enviar datos de registro:', error);
                    Swal.close();
                    Swal.fire({ icon: 'error', title: 'Error Inesperado', text: 'Ocurrió un error inesperado. Por favor, revise la consola.' });
                    hdnConfirmedValidation.val('');
                    return { success: false };
                }
            }

            // ==== Búsqueda (debounce + cancel + timeout + retry) ====
            const runSafeSearch = debounce(async function () {
              const term = employeeSearchInput.val().trim();

              // limpiar si vacío
              if (!term) {
                employeeSearchResults.hide().empty();
                resetCoreFields();
                // cancela cualquier request previo
                SAFE_SEARCH.ctrl?.abort();
                SAFE_SEARCH.ctrl = null;
                return;
              }

              // regla mínima de búsqueda (número completo o texto >= 2)
              const isNumber = /^\d+$/.test(term);
              const isTextSearchValid = term.length >= 2 && !isNumber;
              if (!(isNumber || isTextSearchValid)) {
                employeeSearchResults.hide().empty();
                return;
              }

              // sin conexión -> mensaje inmediato
              if (!navigator.onLine) {
                renderSearchMessage(employeeSearchResults, 'Sin conexión. Intenta nuevamente.', 'no-results-message');
                return;
              }

              // cancelar request previo, iniciar nuevo
              SAFE_SEARCH.ctrl?.abort();
              const ctrl = new AbortController();
              SAFE_SEARCH.ctrl = ctrl;
              const mySeq = ++SAFE_SEARCH.seq;

              // UI: buscando…
              setSearchingUI(employeeSearchResults);

              const url = `@Url.Action("GetEmployeeInfo", "EmployeeLog")?searchInput=${encodeURIComponent(term)}`;

              try {
                const data = await fetchJsonSafe(url, { timeout: 8000, retries: 1, signal: ctrl.signal });

                // si llegó fuera de orden, ignorar
                if (mySeq !== SAFE_SEARCH.seq) return;
                employeeSearchResults.empty();

                if (data?.error) {
                  renderSearchMessage(employeeSearchResults, data.error);
                  return;
                }

                if (Array.isArray(data) && data.length > 0) {
                  const frag = document.createDocumentFragment();

                  data.forEach(emp => {
                    const $item = $('<div class="autocomplete-item"></div>');

                    $item.data('employee', emp);

                    $item.html(`
                      <img src="${emp.photoUrl ? `/${emp.photoUrl.startsWith('/') ? emp.photoUrl.substring(1) : emp.photoUrl}` : '/assets/profile-img/default-profile.jpg'}"
                           class="autocomplete-item-icon" alt="Foto">
                      <span class="autocomplete-item-text">${emp.employeeName}</span>
                      <span class="autocomplete-item-details">(${emp.employeeId}) - ${emp.branchName || 'N/A'}</span>
                    `);

                    frag.appendChild($item[0]);
                  });

                  employeeSearchResults.append(frag).show();
                } else {
                  renderSearchMessage(employeeSearchResults, 'No se encontraron empleados.');
                }
              } catch (err) {
                // si fue cancelación por nueva búsqueda, no mostrar error
                if (ctrl.signal.aborted) return;

                console.error('Error al buscar empleados:', err);
                const msg = err.name === 'AbortError'
                  ? 'La búsqueda fue cancelada.'
                  : (err.message?.includes('HTTP') ? 'Error del servidor. Inténtalo de nuevo.' : 'Error al buscar. Verifica tu conexión.');
                renderSearchMessage(employeeSearchResults, msg);
              }
            }, 300);

            // input listener
            employeeSearchInput.on('input', runSafeSearch);

            // Enter: si hay un único resultado, seleccionarlo rápido
            employeeSearchInput.on('keydown', function(e){
              if (e.key === 'Enter') {
                const $items = employeeSearchResults.find('.autocomplete-item').not('.no-results-message,.loading');
                if ($items.length === 1) {
                  const employeeData = $items.first().data('employee');
                  if (employeeData) selectEmployee(employeeData);
                  e.preventDefault();
                }
              }
            });

            // Antes: .on('click', '.autocomplete-item', ...
            employeeSearchResults.on('mousedown', '.autocomplete-item', function (e) {
              e.preventDefault(); // evita que el input pierda foco antes de leer el dato

              let employeeData = $(this).data('employee');

              // por si viniera como string (defensa extra)
              if (typeof employeeData === 'string') {
                try { employeeData = JSON.parse(employeeData); } catch (_) {}
              }

              if (employeeData && employeeData.employeeId) {
                selectEmployee(employeeData);
              } else {
                console.warn('Item sin datos válidos', employeeData);
              }
            });

            // === Botones ===
            btnRecordEntry.on('click', async function() {
                if (!hdnEmployeeId.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'Por favor, seleccione un empleado primero.' });
                    return;
                }
                if (!entryDateInput.val() || !entryTimeInput.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'La fecha y hora de entrada son obligatorias.' });
                    return;
                }
                const logDto = {
                    EmployeeId: parseInt(hdnEmployeeId.val()),
                    FirstName: hdnFirstName.val(),
                    MiddleName: hdnMiddleName.val(),
                    LastName: hdnLastName.val(),
                    SecondLastName: hdnSecondLastName.val(),
                    CargoId: parseInt(hdnCargoId.val()),
                    CargoName: hdnCargoName.val(),
                    UnitId: hdnUnitId.val(),
                    UnitName: hdnUnitName.val(),
                    BranchId: parseInt(hdnBranchId.val()),
                    BranchName: hdnBranchName.val(),
                    EntryDate: entryDateInput.val(),
                    EntryTime: entryTimeInput.val(),
                    ExitDate: null,
                    ExitTime: null,
                    IsEntryRecorded: true,
                    IsExitRecorded: false
                };
                await sendLogData('RecordEntryExit', logDto);
            });

            btnRecordExit.on('click', async function() {
                if (!hdnEmployeeId.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'Por favor, seleccione un empleado primero.' });
                    return;
                }
                if (!hdnLogId.val() || hdnLogId.val() === '0') {
                    Swal.fire({ icon:'error', title:'Error', text:'No se encontró un registro abierto para registrar la salida.' });
                    return;
                }
                if (!exitDateInput.val() || !exitTimeInput.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'La fecha y hora de salida son obligatorias.' });
                    return;
                }
                if (!entryDateInput.val() || !entryTimeInput.val()) {
                    Swal.fire({ icon:'error', title:'Error Interno', text:'La fecha u hora de entrada del registro original no está disponible. Intente seleccionar el empleado de nuevo.' });
                    return;
                }
                const logDto = {
                    EmployeeId: parseInt(hdnEmployeeId.val()),
                    FirstName: hdnFirstName.val(),
                    MiddleName: hdnMiddleName.val(),
                    LastName: hdnLastName.val(),
                    SecondLastName: hdnSecondLastName.val(),
                    CargoId: parseInt(hdnCargoId.val()),
                    CargoName: hdnCargoName.val(),
                    UnitId: hdnUnitId.val(),
                    UnitName: hdnUnitName.val(),
                    BranchId: parseInt(hdnBranchId.val()),
                    BranchName: hdnBranchName.val(),
                    EntryDate: entryDateInput.val(),
                    EntryTime: entryTimeInput.val(),
                    ExitDate: exitDateInput.val(),
                    ExitTime: exitTimeInput.val(),
                    IsEntryRecorded: true,
                    IsExitRecorded: true
                };
                if (hdnConfirmedValidation.val() !== '') {
                    logDto.ConfirmedValidation = hdnConfirmedValidation.val();
                }
                await sendLogData('UpdateLog', logDto, parseInt(hdnLogId.val()));
            });

            btnCancel.on('click', function() {
                window.history.back();
            });

            function resetCoreFields(){
                hdnEmployeeId.val('');
                fullNameDisplay.val('');
                employeeIdDisplay.val('');
                branchNameDisplay.val('');
                btnRecordEntry.prop('disabled', true);
                btnRecordExit.prop('disabled', true);
            }

            // Init
            resetForm();
        });
    </script>
}
