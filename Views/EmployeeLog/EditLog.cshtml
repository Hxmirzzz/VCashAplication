@model VCashApp.Models.ViewModels.EmployeeLog.EmployeeLogEditViewModel
@using System.Globalization

@{
    Layout = "_Layout";
    ViewData["Title"] = "Editar Registro de Empleado";
    bool canEditLog = Model.CanEditLog;

    string entryDateVal = Model.EntryDate.ToString("yyyy-MM-dd");
    string entryTimeVal = Model.EntryTime.ToString(@"hh\:mm");
    string exitDateVal = Model.ExitDate?.ToString("yyyy-MM-dd") ?? "";
    string exitTimeVal = Model.ExitTime?.ToString(@"hh\:mm") ?? "";

    string fullName = Model.EmployeeFullName ?? "";
}

<div class="form-container">
    <form id="editEmployeeLogForm">
        @Html.AntiForgeryToken()

        <!-- Hidden base -->
        <input type="hidden" id="hdnLogId" name="Id" value="@Model.Id" />
        <input type="hidden" id="hdnEmployeeId" name="EmployeeId" value="@Model.EmployeeId" />
        <input type="hidden" id="hdnCargoId" name="CargoId" value="@Model.CargoId" />
        <input type="hidden" id="hdnUnitId" name="UnitId" value="@Model.UnitId" />
        <input type="hidden" id="hdnBranchId" name="BranchId" value="@Model.BranchId" />
        <input type="hidden" id="hdnConfirmedValidation" name="ConfirmedValidation" value="" />

        <!-- Hidden extra para paridad con Create -->
        <input type="hidden" id="hdnFirstName" name="FirstName" value="" />
        <input type="hidden" id="hdnMiddleName" name="MiddleName" value="" />
        <input type="hidden" id="hdnLastName" name="LastName" value="" />
        <input type="hidden" id="hdnSecondLastName" name="SecondLastName" value="" />
        <input type="hidden" id="hdnCargoName" name="CargoName" value="@Model.CargoName" />
        <input type="hidden" id="hdnUnitName" name="UnitName" value="@Model.UnitName" />
        <input type="hidden" id="hdnUnitType" name="UnitType" value="@Model.UnitType" />
        <input type="hidden" id="hdnBranchName" name="BranchName" value="@Model.BranchName" />

        <!-- 👤 Datos del empleado -->
        <div class="card mt-3" id="cardDatosEmpleado">
            <div class="card-header"><h5 class="mb-0">👤 Datos del empleado</h5></div>
            <div class="card-body">
                <div class="row d-flex justify-content-center align-items-center" id="employeeDetailsSection">
                    <div class="col-md-2">
                        <div class="reg-preview-container">
                            <img id="photo-preview" src="" alt="Vista Previa de Foto">
                        </div>
                    </div>
                    <div class="col-md-10">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="employeeIdDisplay" readonly value="@Model.EmployeeId">
                                    <label for="employeeIdDisplay">Número de Cédula</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="fullNameDisplay" readonly value="@fullName">
                                    <label for="fullNameDisplay">Nombre del Empleado</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="cargoNameDisplay" readonly value="@Model.CargoName">
                                    <label for="cargoNameDisplay">Cargo</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="unitNameDisplay" readonly value="@Model.UnitName">
                                    <label for="unitNameDisplay">Unidad</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="branchNameDisplay" readonly value="@Model.BranchName">
                                    <label for="branchNameDisplay">Sucursal</label>
                                </div>
                            </div>
                        </div>
                        <div class="small text-muted mt-2">Estos datos son informativos y no se editan aquí.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ⏱️ Registro -->
        <div class="card mt-3" id="cardRegistro">
            <div class="card-header"><h5 class="mb-0">⏱️ Registro</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="entryDateInput" name="EntryDate" value="@ViewBag.EntryDateVal">
                            <label for="entryDateInput">Fecha de Entrada</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="time" class="form-control" id="entryTimeInput" name="EntryTime" value="@ViewBag.EntryTimeVal">
                            <label for="entryTimeInput">Hora de Entrada</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="exitDateInput" name="ExitDate" value="@ViewBag.ExitDateVal">
                            <label for="exitDateInput">Fecha de Salida</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="time" class="form-control" id="exitTimeInput" name="ExitTime" value="@ViewBag.ExitTimeVal">
                            <label for="exitTimeInput">Hora de Salida</label>
                        </div>
                    </div>
                </div>

                <!-- Flags como en Create -->
                <input type="hidden" id="hdnIsEntryRecorded" name="IsEntryRecorded" value="true" />
                <input type="hidden" id="hdnIsExitRecorded" name="IsExitRecorded" value="@(string.IsNullOrWhiteSpace(exitDateVal) || string.IsNullOrWhiteSpace(exitTimeVal) ? "false" : "true")" />
            </div>
        </div>

        <div class="submit-container form-group col-md-12 mt-4">
            <button type="submit" class="btn btn-primary" id="btnSave" @(canEditLog ? "" : "disabled")>Guardar</button>
            <button type="button" class="btn btn-exit" id="btnCancel">Cancelar</button>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(function () {
            const hdnLogId = $('#hdnLogId');
            const hdnEmployeeId = $('#hdnEmployeeId');
            const hdnConfirmedValidation = $('#hdnConfirmedValidation');

            const entryDateInput = $('#entryDateInput');
            const entryTimeInput = $('#entryTimeInput');
            const exitDateInput  = $('#exitDateInput');
            const exitTimeInput  = $('#exitTimeInput');

            const hdnCargoId = $('#hdnCargoId');
            const hdnCargoName = $('#hdnCargoName');
            const hdnUnitId = $('#hdnUnitId');
            const hdnUnitName = $('#hdnUnitName');
            const hdnUnitType = $('#hdnUnitType');
            const hdnBranchId = $('#hdnBranchId');
            const hdnBranchName = $('#hdnBranchName');

            const hdnFirstName = $('#hdnFirstName');
            const hdnMiddleName = $('#hdnMiddleName');
            const hdnLastName = $('#hdnLastName');
            const hdnSecondLastName = $('#hdnSecondLastName');

            const btnCancel = $('#btnCancel');

            function buildDto() {
                return {
                    EmployeeId: parseInt(hdnEmployeeId.val() || '0'),
                    FirstName: hdnFirstName.val(), MiddleName: hdnMiddleName.val(),
                    LastName: hdnLastName.val(), SecondLastName: hdnSecondLastName.val(),

                    CargoId: parseInt(hdnCargoId.val() || '0'), CargoName: hdnCargoName.val(),
                    UnitId: hdnUnitId.val(), UnitName: hdnUnitName.val(), UnitType: hdnUnitType.val(),
                    BranchId: parseInt(hdnBranchId.val() || '0'), BranchName: hdnBranchName.val(),

                    EntryDate: entryDateInput.val(), EntryTime: entryTimeInput.val(),
                    ExitDate:  exitDateInput.val() || null, ExitTime: exitTimeInput.val() || null,

                    IsEntryRecorded: true,
                    IsExitRecorded: !!(exitDateInput.val() && exitTimeInput.val()),
                    ConfirmedValidation: hdnConfirmedValidation.val()
                };
            }

            async function sendUpdate(logId, dto) {
                Swal.fire({ title:'Procesando...', text:'Por favor, espere.', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
                try {
                    const res = await fetch(`/EmployeeLog/UpdateLog/${logId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        body: JSON.stringify(dto)
                    });

                    if (!res.ok) {
                        const msg = `Error del servidor: ${res.status} ${res.statusText}`;
                        console.error('HTTP', res.status, res.statusText, await res.text().catch(()=>''));
                        Swal.close();
                        await Swal.fire({icon:'error', title:'Error del Servidor', text: msg});
                        return { success:false };
                    }

                    const result = await res.json();

                    if (result.needsConfirmation && !dto.ConfirmedValidation) {
                        Swal.close();
                        const conf = await Swal.fire({
                            title: 'Confirmación Requerida',
                            text: result.message + " ¿Desea continuar?",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Sí, Continuar',
                            cancelButtonText: 'Cancelar'
                        });
                        if (conf.isConfirmed) {
                            return await sendUpdate(logId, { ...dto, ConfirmedValidation: result.validationType });
                        } else {
                            await Swal.fire('Cancelado', 'La operación ha sido cancelada.', 'info');
                            return { success:false };
                        }
                    }

                    if (result.success) {
                        Swal.close();
                        await Swal.fire({ icon:'success', title:'¡Guardado!', text: result.message });
                        window.history.back();
                        return result;
                    } else {
                        Swal.close();
                        await Swal.fire({ icon:'error', title:'Error', text: result.message || 'No se pudo guardar.' });
                        return { success:false };
                    }
                } catch (err) {
                    console.error('Update error', err);
                    Swal.close();
                    await Swal.fire({ icon:'error', title:'Error Inesperado', text:'Revisa tu conexión e inténtalo de nuevo.' });
                    return { success:false };
                }
            }

            // Submit Edit
            $('#editEmployeeLogForm').on('submit', async function (e) {
                e.preventDefault();
                const logId = parseInt(hdnLogId.val() || '0');
                if (!logId) {
                    Swal.fire({ icon:'error', title:'Falta ID', text:'No se encontró el identificador del registro.' });
                    return;
                }
                if (!hdnEmployeeId.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'El registro no tiene empleado asociado.' });
                    return;
                }
                if (!entryDateInput.val() || !entryTimeInput.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'Entrada (fecha y hora) es obligatoria.' });
                    return;
                }
                const dto = buildDto();
                await sendUpdate(logId, dto);
            });

            btnCancel.on('click', () => window.history.back());
        });
    </script>
}
