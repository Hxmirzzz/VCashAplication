@model VCashApp.Models.ViewModels.EmployeeLog.EmployeeLogManualExitViewModel
@using System.Globalization
@using System.IO

@{
    Layout = "_Layout";
    ViewData["Title"] = "Salida";

    bool canEditLog = Model.CanEditLog;
    bool canCreateLog = Model.CanCreateLog;

    string entryDateVal = Model.EntryDate.ToString("yyyy-MM-dd");
    string entryTimeVal = Model.EntryTime.ToString(@"hh\:mm");
    string exitDateVal = Model.ExitDate?.ToString("yyyy-MM-dd") ?? "";
    string exitTimeVal = Model.ExitTime?.ToString(@"hh\:mm") ?? "";

    string fullName = Model.EmployeeFullName ?? "";
}

<div class="form-container">
    <form id="recordManualExitForm">
        @Html.AntiForgeryToken()

        <input type="hidden" id="hdnLogId" name="Id" value="@Model.Id" />
        <input type="hidden" id="hdnEmployeeId" name="EmployeeId" value="@Model.EmployeeId" />
        <input type="hidden" id="hdnConfirmedValidation" name="ConfirmedValidation" value="" />

        <input type="hidden" id="hdnFirstName" name="FirstName" value="" />
        <input type="hidden" id="hdnMiddleName" name="MiddleName" value="" />
        <input type="hidden" id="hdnLastName" name="LastName" value="" />
        <input type="hidden" id="hdnSecondLastName" name="SecondLastName" value="" />

        <input type="hidden" id="hdnCargoId" name="CargoId" value="@Model.CargoId" />
        <input type="hidden" id="hdnCargoName" name="CargoName" value="@Model.CargoName" />
        <input type="hidden" id="hdnUnitId" name="UnitId" value="@Model.UnitId" />
        <input type="hidden" id="hdnUnitName" name="UnitName" value="@Model.UnitName" />
        <input type="hidden" id="hdnUnitType" name="UnitType" value="@Model.UnitType" />
        <input type="hidden" id="hdnBranchId" name="BranchId" value="@Model.BranchId" />
        <input type="hidden" id="hdnBranchName" name="BranchName" value="@Model.BranchName" />
    
        <div class="card mt-3" id="cardDatosEmpleado">
            <div class="card-header"><h5 class="mb-0">👤 Datos del empleado</h5></div>
            <div class="card-body">
                <div class="row d-flex justify-content-center align-items-center" id="employeeDetailsSection">
                    <div class="col-md-2">
                        <div class="reg-preview-container">
                            <img id="photo-preview" src="" alt="Vista Previa de Foto">
                        </div>
                    </div>
                    <div class="col-md-10">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="employeeIdDisplay" readonly value="@Model.EmployeeId">
                                    <label for="employeeIdDisplay">Número de Cédula</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="fullNameDisplay" readonly value="@fullName">
                                    <label for="fullNameDisplay">Nombre del Empleado</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="cargoNameDisplay" readonly value="@Model.CargoName">
                                    <label for="cargoNameDisplay">Cargo</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="unitNameDisplay" readonly value="@Model.UnitName">
                                    <label for="unitNameDisplay">Unidad</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="branchNameDisplay" readonly value="@Model.BranchName">
                                    <label for="branchNameDisplay">Sucursal</label>
                                </div>
                            </div>
                        </div>
                        <div class="small text-muted mt-2">Estos datos son informativos y no se editan aquí.</div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- ⏱️ Registro -->
        <div class="card mt-3" id="cardRegistro">
            <div class="card-header"><h5 class="mb-0">⏱️ Registro</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Entrada (solo lectura) -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="entryDateDisplay" readonly value="@ViewBag.EntryDateVal">
                            <label for="entryDateDisplay">Fecha de Entrada</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="time" class="form-control" id="entryTimeDisplay" readonly value="@ViewBag.EntryTimeVal">
                            <label for="entryTimeDisplay">Hora de Entrada</label>
                        </div>
                    </div>
    
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="exitDateInput" name="ExitDate" value="@ViewBag.ExitDateVal">
                            <label for="exitDateInput">Fecha de Salida</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="time" class="form-control" id="exitTimeInput" name="ExitTime" value="@ViewBag.ExitTimeVal">
                            <label for="exitTimeInput">Hora de Salida</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <div class="submit-container form-group col-md-12 mt-4">
            <button type="submit" class="btn btn-primary" id="btnRecordManualExit" @(canCreateLog ? "" : "disabled")>Guardar</button>
            <button type="button" class="btn btn-exit" id="btnCancel">Cancelar</button>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            const hdnLogId = $('#hdnLogId');
            const hdnEmployeeId = $('#hdnEmployeeId');
            const hdnConfirmedValidation = $('#hdnConfirmedValidation');

            const entryDateDisplay = $('#entryDateDisplay');
            const entryTimeDisplay = $('#entryTimeDisplay');
            const exitDateInput = $('#exitDateInput');
            const exitTimeInput = $('#exitTimeInput');

            const hdnFirstName = $('#hdnFirstName');
            const hdnMiddleName = $('#hdnMiddleName');
            const hdnLastName = $('#hdnLastName');
            const hdnSecondLastName = $('#hdnSecondLastName');

            const hdnCargoId = $('#hdnCargoId');
            const hdnCargoName = $('#hdnCargoName');

            const hdnUnitId = $('#hdnUnitId');
            const hdnUnitName = $('#hdnUnitName');
            const hdnUnitType = $('#hdnUnitType');

            const hdnBranchId = $('#hdnBranchId');
            const hdnBranchName = $('#hdnBranchName');

            const btnRecordManualExit = $('#btnRecordManualExit');
            const btnCancel = $('#btnCancel');

            hdnConfirmedValidation.val('');

            async function sendManualExitData(data) {
                const logId = hdnLogId.val();
                const isConfirmationRetry = data.ConfirmedValidation !== undefined && data.ConfirmedValidation !== null && data.ConfirmedValidation !== '';

                if (!logId || logId === '0') {
                    Swal.fire({ icon:'error', title:'Error Interno', text:'ID de registro no válido para la salida manual.' });
                    return { success: false, message: 'ID de registro no válido.' };
                }

                Swal.fire({ title:'Registrando Salida...', text:'Por favor, espere.', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });

                try {
                    const response = await fetch(`/EmployeeLog/RecordManualExit/${logId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Error HTTP de AJAX: ${response.status} ${response.statusText} - ${errorText}`);
                        const msg = `Error del servidor: ${response.status} ${response.statusText}`;
                        Swal.close();
                        Swal.fire({ icon:'error', title:'Error del Servidor', text: msg });
                        return { success: false, message: msg };
                    }

                    const result = await response.json();

                    if (result.needsConfirmation && !isConfirmationRetry) {
                        Swal.close();
                        Swal.fire({
                            title: 'Confirmación Requerida',
                            text: result.message + " ¿Desea continuar con el registro de salida manual?",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Sí, Continuar',
                            cancelButtonText: 'Cancelar'
                        }).then(async (swalResult) => {
                            if (swalResult.isConfirmed) {
                                const currentLogDto = { ...data, ConfirmedValidation: result.validationType };
                                await sendManualExitData(currentLogDto);
                            } else {
                                Swal.close();
                                Swal.fire('Cancelado', 'La operación de salida manual ha sido cancelada.', 'info');
                            }
                        });
                        return { success: false, needsConfirmation: true };
                    } else {
                        if (result.success) {
                            Swal.close();
                            await Swal.fire({ icon:'success', title:'¡Éxito!', text: result.message });
                            window.location.href = '@Url.Action("EmployeeLog", "EmployeeLog")';
                            return result;
                        } else {
                            Swal.close();
                            Swal.fire({ icon:'error', title:'Error', text: result.message });
                            hdnConfirmedValidation.val('');
                            return result;
                        }
                    }
                } catch (error) {
                    console.error('Error al enviar datos de salida manual:', error);
                    Swal.close();
                    Swal.fire({ icon:'error', title:'Error Inesperado', text:'Ocurrió un error inesperado. Por favor, revise la consola para más detalles.' });
                    hdnConfirmedValidation.val('');
                    return { success: false, message: "Ocurrió un error inesperado. Por favor, revise la consola." };
                }
            }

            // Submit
            btnRecordManualExit.on('click', async function(e) {
                e.preventDefault();

                if (!exitDateInput.val() || !exitTimeInput.val()) {
                    Swal.fire({ icon:'warning', title:'Validación', text:'La fecha y hora de salida son obligatorias para registrar la salida manual.' });
                    return;
                }

                const logDto = {
                    Id: parseInt(hdnLogId.val() || '0'),
                    EmployeeId: parseInt(hdnEmployeeId.val() || '0'),

                    FirstName: hdnFirstName.val(),
                    MiddleName: hdnMiddleName.val(),
                    LastName: hdnLastName.val(),
                    SecondLastName: hdnSecondLastName.val(),

                    CargoId: parseInt(hdnCargoId.val() || '0'),
                    CargoName: hdnCargoName.val(),

                    UnitId: hdnUnitId.val(),
                    UnitName: hdnUnitName.val(),
                    UnitType: hdnUnitType.val(),

                    BranchId: parseInt(hdnBranchId.val() || '0'),
                    BranchName: hdnBranchName.val(),

                    EntryDate: entryDateDisplay.val(),
                    EntryTime: entryTimeDisplay.val(),

                    ExitDate: exitDateInput.val(),
                    ExitTime: exitTimeInput.val(),

                    IsEntryRecorded: true,
                    IsExitRecorded: true,

                    ConfirmedValidation: hdnConfirmedValidation.val()
                };

                await sendManualExitData(logDto);
            });

            btnCancel.on('click', function() {
                window.location.href = '@Url.Action("EmployeeLog", "EmployeeLog")';
            });
        });
    </script>
}