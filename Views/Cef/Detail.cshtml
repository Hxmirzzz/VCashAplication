@model VCashApp.Models.ViewModels.CentroEfectivo.CefTransactionDetailViewModel
@{
    Layout = "_Layout";
    var diffClass = Model.NetDiff < 0 ? "text-danger" : "text-success";
    var diffIconClass = Model.NetDiff < 0 ? "ri-arrow-down-s-line" : "ri-arrow-up-s-line";
    var diffIconMod = Model.NetDiff < 0 ? "metric-icon--diff-down" : "metric-icon--diff-up";
    var statusColor = Model.CurrentStatus == "Completado" ? "success" :
                      Model.CurrentStatus == "En proceso" ? "warning" : "secondary";
}

<div class="transaction-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <div class="d-flex align-items-center gap-3 mb-2">
                <h2 class="mb-0">Transacción @Model.SlipNumber</h2>
                <span class="status-badge">
                    <span class="badge bg-@statusColor">@Model.CurrentStatus</span>
                </span>
            </div>
            <p class="mb-0 opacity-75">Orden de Servicio: <strong>@Model.ServiceOrderId</strong></p>
        </div>
        <div class="action-buttons">
            <button class="btn btn-outline-modern btn-modern">Exportar</button>
            <a class="btn btn-outline-modern btn-modern" asp-action="Index">← Volver</a>
        </div>
    </div>

    <div class="transaction-meta">
        <div class="meta-item">
            <div class="meta-label">Concepto</div>
            <div class="meta-value">@Model.ServiceConcept</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Sucursal</div>
            <div class="meta-value">@Model.BranchName</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Fecha Registro</div>
            <div class="meta-value">@((Model.RegistrationDate.ToString("dd/MM/yyyy HH:mm")) ?? "—")</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Registrado por</div>
            <div class="meta-value">@(!string.IsNullOrWhiteSpace(Model.RegisteredByName) ? Model.RegisteredByName : "—")</div>
        </div>
    </div>
</div>

<!-- Métricas Principales -->
<div class="row g-3 mb-4">
    <div class="col-12 col-lg-4">
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-label">Declarado</span>
                <div class="metric-icon"><i class="ri-money-dollar-circle-fill"></i></div>
            </div>
            <div class="metric-value"><span style="opacity:.8;margin-right:4px">$</span>@Model.TotalDeclared.ToString("N0")</div>
            <div class="metric-comparison">Monto esperado</div>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-label">Contado</span>
                <div class="metric-icon"><i class="ri-checkbox-circle-fill"></i></div>
            </div>
            <div class="metric-value"><span style="opacity:.8;margin-right:4px">$</span>@Model.TotalCounted.ToString("N0")</div>
            <div class="metric-comparison">Monto verificado</div>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="metric-card highlight">
            <div class="metric-header">
                <span class="metric-label">Diferencia Neta</span>
                <div class="metric-icon @diffIconMod">
                    <i class="@diffIconClass"></i>
                </div>
            </div>
            <div class="metric-value @diffClass">
                @((Model.NetDiff >= 0 ? "+" : "") + "$" + Model.NetDiff.ToString("N0"))
            </div>
            <div class="metric-comparison @(Model.NetDiff >= 0 ? "positive" : "negative")">
                @if (Model.NetDiff == 0)      { <text>✓ Balance perfecto</text>; }
                else if (Model.NetDiff > 0)   { <text>⬆ Excedente detectado</text>; }
                else                          { <text>⬇ Faltante detectado</text>; }
            </div>
        </div>
    </div>
</div>

<!-- Detalle por Tipo -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="detail-grid">
            <div class="detail-grid-title">Composición del Efectivo</div>

            <div class="detail-row">
                <div class="detail-label">Billetes Alta Denominación</div>
                <div class="detail-value">$@Model.BillsHigh.ToString("N0")</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Billetes Baja Denominación</div>
                <div class="detail-value">$@Model.BillsLow.ToString("N0")</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Monedas</div>
                <div class="detail-value">$@Model.CoinsTotal.ToString("N0")</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Documentos / Vouchers</div>
                <div class="detail-value">$@Model.DocsTotal.ToString("N0")</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Cheques</div>
                <div class="detail-value">$@Model.ChecksTotal.ToString("N0")</div>
            </div>

            <div class="detail-row" style="border-top: 2px solid #e5e7eb; margin-top: 0.5rem; padding-top: 1rem;">
                <div class="detail-label">Total Bolsas</div>
                <div class="detail-value" style="color:#667eea;">@Model.Containers.Count</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Novedades Registradas</div>
                <div class="detail-value" style="color:#ef4444;">@Model.Incidents.Count</div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs Modernos -->
<div class="tabs-modern">
    <button class="tab-modern active" onclick="switchTab(event,'contenedores')">Bolsas y Sobres (@Model.Containers.Count)</button>
    <button class="tab-modern" onclick="switchTab(event,'novedades')">Novedades (@Model.Incidents.Count)</button>
</div>

<!-- Contenido Tabs -->
<div id="tab-contenedores" class="tab-content-modern">
    @if (Model.Containers?.Any() == true)
    {
        var bagCounter = 0;
        foreach (var c in Model.Containers)
        {
            var isBag = c.ContainerType == "Bolsa";
            var contIconClass = isBag ? "ri-shopping-bag-3-line" : "ri-mail-open-line";
            var contIconMod = isBag ? "container-icon--bag" : "container-icon--env";
            if (isBag) bagCounter++;

            <div class="container-card @(isBag ? "" : "envelope")" onclick="toggleContainer(this)">
                <div class="container-header">
                    <div class="container-title">
                        <div class="container-icon @contIconMod">
                            <i class="@contIconClass"></i>
                        </div>                        <div>
                            <div style="font-weight:600;">
                                @(isBag ? $"Bolsa {bagCounter}" : "Sobre")
                            </div>
                            <div style="font-size:.875rem;color:#6b7280;">@c.ContainerCode</div>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(c.ParentLabel))
                        {
                            <span class="container-badge">@c.ParentLabel</span>
                        }
                    </div>
                    <div class="container-amount">$@c.Subtotal.ToString("N0")</div>
                </div>

                <div class="container-details">
                    @await Html.PartialAsync("_ContainerSummaryReadOnly", c)
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <div class="empty-state-icon"><i class="ri-shopping-bag-3-fill"></i></div>
            <p>No hay bolsas registradas en esta transacción</p>
        </div>
    }
</div>

<div id="tab-novedades" class="tab-content-modern" style="display:none;">
    @if (Model.Incidents?.Any() == true)
    {
        foreach (var inc in Model.Incidents)
        {
            <div class="incident-card">
                <div class="incident-header">
                    <div class="incident-type">
                        <div class="incident-icon"><i class="ri-alert-fill"></i></div>
                        <div>
                            <div>@inc.Code</div>
                            <div style="font-size:.75rem;color:#9ca3af;font-weight:normal;">
                                @inc.ReportedAt.ToString("dd/MM/yyyy HH:mm")
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="incident-status">@inc.Status</span>
                        <span class="incident-amount">$@inc.AffectedAmount.ToString("N0")</span>
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(inc.Description))
                {
                    <div class="incident-description">@inc.Description</div>
                }

                <div class="incident-footer">
                    <span><i class="ri-user-fill"></i> @(string.IsNullOrWhiteSpace(inc.ReportedBy) ? "Sin asignar" : inc.ReportedBy)</span>
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <div class="empty-state-icon"><i class="ri-checkbox-circle-fill"></i></div>
            <p>No hay novedades registradas en esta transacción</p>
        </div>
    }
</div>

<script>
    function switchTab(e, tabName) {
        // Actualizar botones
        document.querySelectorAll('.tab-modern').forEach(t => t.classList.remove('active'));
        if (e && e.currentTarget) e.currentTarget.classList.add('active');

        // Mostrar contenido
        document.querySelectorAll('.tab-content-modern').forEach(c => c.style.display = 'none');
        document.getElementById('tab-' + tabName).style.display = 'block';
    }
    function toggleContainer(el) { el.classList.toggle('expanded'); }
</script>