@model VCashApp.Models.ViewModels.CentroEfectivo.CefTransactionDetailViewModel
@{
    Layout = "_Layout";
    var diffClass = Model.NetDiff < 0 ? "title-diff negative" : "title-diff positive";
}

<div class="card mb-3">
    <div class="card-body d-flex align-items-center justify-content-between">
        <div>
            <h4 class="mb-1">Transacción @Model.SlipNumber</h4>
            <ul class="meta-list">
                <li class="meta-k">OS: </li><li class="meta-v">@Model.ServiceOrderId</li>
                <li class="meta-k">Concepto: </li><li class="meta-v">@Model.ServiceConcept</li>
                <li class="meta-k">Sucursal: </li><li class="meta-v">@Model.BranchName</li>
                <li class="meta-k">Registro: </li><li class="meta-v">@Model.RegistrationDate.ToString("yyyy-MM-dd HH:mm")</li>
                <li class="meta-k">Registrado por: </li><li class="meta-v">@(!string.IsNullOrWhiteSpace(Model.RegisteredByName) ? Model.RegisteredByName : "—")</li>
            </ul>
        </div>
        <div class="d-flex align-items gap-2">
            <span class="badge bg-secondary">Estado: @Model.CurrentStatus</span>
            <a class="btn btn-outline-secondary" asp-action="Index">Volver</a>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-12 col-xl-4 order-xl-2">

        <ul class="nav nav-tabs" id="detailTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-resumen" type="button" role="tab">Resumen</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-contenedores" type="button" role="tab">Bolsas y Sobres</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-novedades" type="button" role="tab">Novedades</button>
            </li>
        </ul>

        <div class="tab-content border border-top-0 rounded-bottom p-3">
            <!-- Resumen -->
            <div class="tab-pane fade show active" id="tab-resumen" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="text-uppercase text-muted">Totales</h6>
                                <div class="d-flex justify-content-between"><span>Declarado</span><strong>@Model.TotalDeclared.ToString("N0")</strong></div>
                                <div class="d-flex justify-content-between"><span>Contado</span><strong>@Model.TotalCounted.ToString("N0")</strong></div>
                                <hr />
                                <div class="d-flex justify-content-between">
                                    <span>Diferencia neta</span>
                                    <strong class="@(Model.NetDiff < 0 ? "text-danger" : "text-success")">
                                        @((Model.NetDiff >= 0 ? "+" : "") + Model.NetDiff.ToString("N0"))
                                    </strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="text-uppercase text-muted">Fechas & Usuarios</h6>
                                <div class="mb-1">
                                    <small class="text-muted d-block">Registrado por</small>
                                    <strong>@(Model.RegisteredByName ?? "—")</strong>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Fecha de registro</small>
                                    <strong>@Model.RegistrationDate.ToString("yyyy-MM-dd HH:mm")</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-3" />

                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-uppercase text-muted">Desglose efectivo</h6>
                                <div class="d-flex justify-content-between"><span>Billete Alto</span><strong>@Model.BillsHigh.ToString("N0")</strong></div>
                                <div class="d-flex justify-content-between"><span>Billete Bajo</span><strong>@Model.BillsLow.ToString("N0")</strong></div>
                                <div class="d-flex justify-content-between"><span>Monedas</span><strong>@Model.CoinsTotal.ToString("N0")</strong></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-uppercase text-muted">Otros</h6>
                                <div class="d-flex justify-content-between"><span>Documentos/Voucher</span><strong>@Model.DocsTotal.ToString("N0")</strong></div>
                                <div class="d-flex justify-content-between"><span>Cheques</span><strong>@Model.ChecksTotal.ToString("N0")</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bolsas y Sobres -->
            <div class="tab-pane fade" id="tab-contenedores" role="tabpanel">
                @if (Model.Containers?.Any() == true)
                {
                    <div class="accordion" id="accBags">
                        @for (int i = 0; i < Model.Containers.Count; i++)
                        {
                            var bag = Model.Containers[i];
                            var accId = $"bag{i}";
                            <div class="accordion-item mb-2">
                                <h2 class="accordion-header" id="h-@accId">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c-@accId">
                                        @((bag.ContainerType?.Equals("Bolsa", StringComparison.OrdinalIgnoreCase) ?? false) ? $"Bolsa {i + 1}" : "Sobre")
                                        — @bag.ContainerCode
                                        @if (!string.IsNullOrWhiteSpace(bag.ParentLabel))
                                        {
                                            <span class="ms-2 small text-muted">(@bag.ParentLabel)</span>
                                        }
                                        <span class="ms-auto badge bg-info">Subtotal: @bag.Subtotal.ToString("N0")</span>
                                    </button>
                                </h2>
                                <div id="c-@accId" class="accordion-collapse collapse" data-bs-parent="#accBags">
                                    <div class="accordion-body">
                                        @await Html.PartialAsync("_ContainerSummaryReadOnly", bag)
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-muted">Sin contenedores registrados.</div>
                }
            </div>

            <!-- Novedades -->
            <div class="tab-pane fade" id="tab-novedades" role="tabpanel">
                @if (Model.Incidents?.Any() == true)
                {
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Descripción</th>
                                    <th class="text-end">Monto afectado</th>
                                    <th>Estado</th>
                                    <th>Reportado por</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var inc in Model.Incidents)
                                {
                                    <tr>
                                        <td>@inc.ReportedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td>@inc.Code</td>
                                        <td>@inc.Description</td>
                                        <td class="text-end">@inc.AffectedAmount.ToString("N0")</td>
                                        <td><span class="badge bg-secondary">@inc.Status</span></td>
                                        <td>@(inc.ReportedBy ?? "—")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-muted">Sin novedades registradas.</div>
                }
            </div>
        </div>

    </div>

    <!-- Sidebar con KPIs -->
    <div class="col-12 col-lg-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-uppercase text-muted">KPIs Rápidos</h6>
                <div class="d-flex justify-content-between"><span>Contenedores</span><strong>@(Model.Containers?.Count ?? 0)</strong></div>
                <div class="d-flex justify-content-between"><span>Novedades</span><strong>@(Model.Incidents?.Count ?? 0)</strong></div>
                <hr />
                <div class="small text-muted">Solo lectura • Para editar, usa “Procesar Contenedores”.</div>
            </div>
        </div>
    </div>
</div>