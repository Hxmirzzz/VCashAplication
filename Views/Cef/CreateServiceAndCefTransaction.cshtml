@model VCashApp.Models.ViewModels.CentroEfectivo.Shared.CefServiceCreationViewModel
@{
    ViewData["Title"] = "Recepción de Servicios";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="form-container">
    <div class="card">
        <div class="card-body">
            <form id="cefServiceCreationForm" asp-action="CreateServiceAndCefTransaction" asp-controller="Cef" method="post" novalidate>
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="progress-stepper" id="progressStepper">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Información General</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Origen y Destino</div>
                    </div>
                </div>

                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="info-general" role="tabpanel" aria-labelledby="info-general-tab" data-step="1">
                        <div class="step-content">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5><i class="ri-survey-fill"></i> Información General</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating has-validation">
                                                <select asp-for="ServiceConceptCode" asp-items="Model.AvailableServiceConcepts" class="form-select" id="serviceConceptCode" required aria-required="true">
                                                    <option value="">Seleccionar concepto...</option>
                                                </select>
                                                <label for="serviceConceptCode" class="required">Concepto del Servicio</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="ServiceConceptCode" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating has-validation">
                                                <input asp-for="SlipNumber" class="form-control" placeholder="Número de planilla" required aria-required="true" />
                                                <label for="SlipNumber" class="required">Número de planilla</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating has-validation">
                                                <input asp-for="ClientOrderNumber" class="form-control" placeholder="Número de Orden Cliente" required aria-required="true" />
                                                <label for="ClientOrderNumber" class="required">Número de Orden Cliente</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="ClientOrderNumber" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input asp-for="ClientServiceOrderCode" class="form-control" placeholder="Código Orden Servicio Cliente" />
                                                <label for="ClientServiceOrderCode">Código Orden Servicio Cliente</label>
                                            </div>
                                            <span asp-validation-for="ClientServiceOrderCode" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating has-validation">
                                                <select asp-for="BranchId" asp-items="Model.AvailableBranches" class="form-select" id="branchId" required aria-required="true">
                                                    <option value="">Seleccionar sucursal...</option>
                                                </select>
                                                <label for="branchId" class="required">Sucursal</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="BranchId" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating has-validation">
                                                <select asp-for="Currency" asp-items="Model.AvailableCurrencies" class="form-control">
                                                    <option value="">-- Selecciona --</option>
                                                </select>
                                                <label class="required">Divisa</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-2">
                                            <div class="form-floating has-validation">
                                                <input asp-for="RequestDate" type="date" class="form-control" placeholder="Fecha de Solicitud" required aria-required="true" />
                                                <label for="RequestDate" class="required">Fecha de Solicitud</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="RequestDate" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-2">
                                            <div class="form-floating has-validation">
                                                <input asp-for="RequestTime" type="time" class="form-control" placeholder="Hora de Solicitud" required aria-required="true" />
                                                <label for="RequestTime" class="required">Hora de Solicitud</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="RequestTime" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-2">
                                            <div class="form-floating has-validation">
                                                <input asp-for="ProgrammingDate" type="date" class="form-control" placeholder="Fecha de Servicio" required aria-required="true" />
                                                <label for="ProgrammingDate" class="required">Fecha de Servicio</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="ProgrammingDate" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-2">
                                            <div class="form-floating has-validation">
                                                <input asp-for="ProgrammingTime" type="time" class="form-control" placeholder="Hora de Servicio" required aria-required="true" />
                                                <label for="ProgrammingTime" class="required">Hora de Servicio</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="ProgrammingTime" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating has-validation">
                                                <select asp-for="ServiceModality" asp-items="Model.AvailableServiceModalities" class="form-select" id="serviceModality" required aria-required="true">
                                                    <option value="">Seleccionar modalidad...</option>
                                                </select>
                                                <label for="serviceModality" class="required">Modalidad de Servicio</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="ServiceModality" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating has-validation">
                                                <select asp-for="DeliveryResponsible" class="form-select" id="deliveryResponsible" required aria-required="true">
                                                    <option value="">Seleccionar responsable...</option>
                                                </select>
                                                <label for="deliveryResponsible" class="required">Responsable de Entrega</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="DeliveryResponsible" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating has-validation">
                                                <select asp-for="ReceptionResponsible" class="form-select" id="receptionResponsible" required aria-required="true">
                                                    <option value="">Seleccionar responsable...</option>
                                                </select>
                                                <label for="receptionResponsible" class="required">Responsable de Recepción</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="ReceptionResponsible" class="text-danger"></span>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-floating">
                                                <textarea asp-for="ServiceObservations" class="form-control" placeholder="Observaciones del Servicio" style="height: 100px;"></textarea>
                                                <label for="serviceObservations">Observaciones del Servicio</label>
                                            </div>
                                            <span asp-validation-for="ServiceObservations" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-check form-switch">
                                                <input asp-for="IsFailed" class="form-check-input" type="checkbox" id="isFailedSwitch" />
                                                <label class="form-check-label" for="isFailedSwitch">Marcar como Fallido</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="origen-destino" role="tabpanel" aria-labelledby="origen-destino-tab" data-step="2">
                        <div class="step-content">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Origen</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating has-validation">
                                                <select asp-for="OriginClientId" asp-items="Model.AvailableClients" class="form-select" id="originClientId" required aria-required="true">
                                                    <option value="">Seleccionar cliente origen...</option>
                                                </select>
                                                <label for="originClientId" class="required">Cliente Origen</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="OriginClientId" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-2">
                                            <div class="form-floating has-validation">
                                                <select asp-for="OriginType" asp-items="Html.GetEnumSelectList<VCashApp.Enums.LocationTypeEnum>()" class="form-select" id="originType" required aria-required="true">
                                                    <option value="">Seleccionar tipo origen...</option>
                                                </select>
                                                <label for="originType" class="required">Tipo Origen</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="OriginType" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating has-validation">
                                                <select asp-for="OriginCode" class="form-select is-loading" id="originCode" required aria-required="true">
                                                    <option value="">🔄 Cargando opciones...</option>
                                                </select>
                                                <label for="originCode" class="required">Código de Origen</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="OriginCode" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="OriginCityName" class="form-control" placeholder="Ciudad Origen" readonly />
                                                <label for="originCityName">Ciudad Origen</label>
                                                <input type="hidden" asp-for="OriginCityId" />
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="OriginBranchId" class="form-control" placeholder="Sucursal Origen" readonly />
                                                <label for="originBranchId">Sucursal Origen</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="OriginRangeCode" class="form-control" placeholder="Código Rango Origen" readonly />
                                                <label for="originRangeCode">Código Rango Origen</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="OriginRangeDetails" class="form-control" placeholder="Detalles Rango Origen" readonly />
                                                <label for="originRangeDetails">Detalles Rango Origen</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Destino</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating has-validation">
                                                <select asp-for="DestinationClientId" asp-items="Model.AvailableClients" class="form-select" id="destinationClientId" required aria-required="true">
                                                    <option value="">Seleccionar cliente destino...</option>
                                                </select>
                                                <label for="destinationClientId" class="required">Cliente Destino</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="DestinationClientId" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-2">
                                            <div class="form-floating has-validation">
                                                <select asp-for="DestinationType" asp-items="Html.GetEnumSelectList<VCashApp.Enums.LocationTypeEnum>()" class="form-select" id="destinationType" required aria-required="true">
                                                    <option value="">Seleccionar tipo destino...</option>
                                                </select>
                                                <label for="destinationType" class="required">Tipo Destino</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="DestinationType" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating has-validation">
                                                <select asp-for="DestinationCode" class="form-select is-loading" id="destinationCode" required aria-required="true">
                                                    <option value="">🔄 Cargando opciones...</option>
                                                </select>
                                                <label for="destinationCode" class="required">Código de Destino</label>
                                                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                            <span asp-validation-for="DestinationCode" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="DestinationCityName" class="form-control" placeholder="Ciudad Destino" readonly />
                                                <label for="destinationCityName">Ciudad Destino</label>
                                                <input type="hidden" asp-for="DestinationCityId" />
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="DestinationBranchId" class="form-control" placeholder="Sucursal Destino" readonly />
                                                <label for="destinationBranchId">Sucursal Destino</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="DestinationRangeCode" class="form-control" placeholder="Código Rango Destino" readonly />
                                                <label for="destinationRangeCode">Código Rango Destino</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="DestinationRangeDetails" class="form-control" placeholder="Detalles Rango Destino" readonly />
                                                <label for="destinationRangeDetails">Detalles Rango Destino</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5><i class="ri-money-dollar-circle-fill"></i> Cantidades y Valores Declarados</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="ExchangeKitCount" type="number" class="form-control" placeholder="Cantidad Kit de Cambio" />
                                                <label for="NumberOfChangeKits">Cantidad Kit de Cambio</label>
                                            </div>
                                            <span asp-validation-for="ExchangeKitCount" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="DeclaredBagCount" type="number" class="form-control" placeholder="Cantidad Bolsa de Moneda" />
                                                <label for="NumberOfCoinBags">Cantidad Bolsa de Moneda</label>
                                            </div>
                                            <span asp-validation-for="DeclaredBagCount" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-3" style="display: none;">
                                            <div class="form-floating">
                                                <input asp-for="DeclaredBillValue" type="number" step="1" class="form-control calculate-total-declared" placeholder="Valor Billetes Declarados" />
                                                <label for="BillValue">Valor Billetes Declarados</label>
                                            </div>
                                            <span asp-validation-for="DeclaredBillValue" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-3" style="display: none;">
                                            <div class="form-floating">
                                                <input asp-for="DeclaredCoinValue" type="number" step="1" class="form-control calculate-total-declared" placeholder="Valor Monedas Declaradas" />
                                                <label for="CoinValue">Valor Monedas Declaradas</label>
                                            </div>
                                            <span asp-validation-for="DeclaredCoinValue" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="ServiceValue" type="number" class="form-control calculate-total-declared" placeholder="Valor Total" />
                                                <label for="ServiceValue">Valor Total</label>
                                            </div>
                                            <span asp-validation-for="ServiceValue" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-3">
                                        <div class="col-12">
                                            <div class="calculation-panel mt-3">
                                                <h6>💰 Resumen</h6>
                                                <div class="calculation-total">
                                                    <span>Total Declarado:</span>
                                                    <span class="total-value" id="totalValue">$0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step-content" id="failedReasonSection" style="display:none;">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="ri-error-warning-fill"></i> Detalles del Fallo</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12 col-lg-6">
                                    <div class="form-floating has-validation">
                                        <select asp-for="FailedResponsible" asp-items="Model.AvailableFailedResponsibles" class="form-select" id="failedResponsible" required aria-required="true">
                                            <option value="">Seleccionar responsable...</option>
                                        </select>
                                        <label for="failedResponsible" class="required">Responsable del Fallo</label>
                                        <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                        <div class="valid-feedback">✓ Correcto</div>
                                    </div>
                                    <span asp-validation-for="FailedResponsible" class="text-danger"></span>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating has-validation">
                                        <textarea asp-for="FailedReason" class="form-control" placeholder="Razón del Fallo" style="height: 100px;" required aria-required="true"></textarea>
                                        <label for="failedReason" class="required">Razón del Fallo</label>
                                        <div class="invalid-feedback">⚠ Este campo es requerido</div>
                                        <div class="valid-feedback">✓ Correcto</div>
                                    </div>
                                    <span asp-validation-for="FailedReason" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="ri-account-circle-fill"></i> Datos del Operador</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12 col-lg-4">
                                    <div class="form-floating">
                                        <input asp-for="RegistrationDate" type="datetime-local" class="form-control" readonly />
                                        <label for="registrationDate">Fecha de Registro</label>
                                    </div>
                                </div>
                                <div class="col-12 col-lg-4">
                                    <div class="form-floating">
                                        <input asp-for="RegistrationUserName" class="form-control" readonly />
                                        <label for="registrationUserName">Usuario de Registro</label>
                                    </div>
                                </div>
                                <div class="col-12 col-lg-4">
                                    <div class="form-floating">
                                        <input asp-for="IPAddress" class="form-control" readonly />
                                        <label for="ipAddress">Dirección IP</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="submit-container form-group col-12 mt-4">
                    <button type="button" class="btn btn-secondary" data-step-action="prev" style="display: none;">Anterior</button>
                    <button type="button" class="btn btn-primary" data-step-action="next" style="display: none;">Continuar</button>
                    <button type="submit" class="btn btn-primary" data-step-action="submit-final" style="display: none;">Registrar</button>
                    <a asp-action="Index" class="btn btn-danger">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            // =========================
            // Config / Helpers
            // =========================
            let currentStep = 1;
            const totalSteps = 2;
            const $form = $('#cefServiceCreationForm');

            const $nextButton = $('button[data-step-action="next"]');
            const $prevButton = $('button[data-step-action="prev"]');
            const $submitFinalButton = $('button[data-step-action="submit-final"]');

            // Helpers que aceptan string o jQuery object
            const get$ = (sel) => (sel && sel.jquery) ? sel : $(sel);

            function showFieldLoading(selector, defaultText = 'Cargando opciones...') {
                const $el = get$(selector);
                $el.addClass('is-loading').prop('disabled', true);
                $el.html(`<option value="">🔄 ${defaultText}</option>`);
            }
            function hideFieldLoading(selector) {
                const $el = get$(selector);
                $el.removeClass('is-loading').prop('disabled', false);
                // valida solo si el usuario ya lo tocó
                if ($el.data('touched')) validateField($el);
            }
            function fillDropdown(selector, data) {
                const $el = get$(selector);
                let options = '<option value="">-- Seleccionar --</option>';
                $.each(data, function (i, item) {
                    const selected = item.selected ? ' selected' : '';
                    options += `<option value="${item.value}"${selected}>${item.text}</option>`;
                });
                $el.html(options);
            }

            // Obtener el value de un <select> a partir del texto visible (por robustez ante enums)
            function getOptionValueByText(selectSelector, textWanted) {
                const $sel = get$(selectSelector);
                let val = null;
                $sel.find('option').each(function () {
                    if ($(this).text().trim() === textWanted) {
                        val = $(this).val();
                        return false;
                    }
                });
                return val;
            }

            // Des/activar selects y espejar en hidden (porque disabled no postea)
            function setAndLockSelect(selectSelector, valueOrText) {
                const $sel = get$(selectSelector);
                let targetVal = valueOrText;

                // Si no existe por value, busca por texto
                if ($sel.find(`option[value="${valueOrText}"]`).length === 0) {
                    const byText = getOptionValueByText($sel, valueOrText);
                    if (byText !== null) targetVal = byText;
                }

                $sel.val(targetVal).prop('disabled', true).trigger('change');
                const name = $sel.attr('name');
                const hiddenId = ($sel.attr('id') || name) + '_hidden';
                if ($('#' + hiddenId).length === 0) {
                    $('<input>', { type: 'hidden', id: hiddenId, name: name, value: targetVal }).insertAfter($sel);
                } else {
                    $('#' + hiddenId).val(targetVal);
                }
            }
            function unlockSelect(selectSelector) {
                const $sel = get$(selectSelector);
                $sel.prop('disabled', false);
                const hiddenId = ($sel.attr('id') || $sel.attr('name')) + '_hidden';
                $('#' + hiddenId).remove();
            }

            // =========================
            // Stepper / Validación
            // =========================
            function updateStepper() {
                $('.progress-stepper .step').removeClass('active completed');
                for (let i = 1; i <= totalSteps; i++) {
                    const $step = $(`.step[data-step="${i}"]`);
                    if (i < currentStep) {
                        $step.addClass('completed');
                        $step.find('.step-number').html('&#10003;');
                    } else if (i === currentStep) {
                        $step.addClass('active');
                        $step.find('.step-number').text(i);
                    } else {
                        $step.find('.step-number').text(i);
                    }
                }
                showCurrentStepContent();
            }
            function showCurrentStepContent() {
                $('.tab-pane').removeClass('show active');
                $(`#myTabContent div[data-step="${currentStep}"]`).addClass('show active');

                $nextButton.hide();
                $prevButton.hide();
                $submitFinalButton.hide();

                if (currentStep === 2) {
                    if (!$('#originType').val()) {
                        $('#originCode').prop('disabled', true).html('<option value="">Seleccionar tipo de origen primero</option>');
                    }
                    if (!$('#destinationType').val()) {
                        $('#destinationCode').prop('disabled', true).html('<option value="">Seleccionar tipo de destino primero</option>');
                    }
                }
                if (currentStep === 1) {
                    $nextButton.show();
                } else if (currentStep === totalSteps) {
                    $prevButton.show();
                    $submitFinalButton.show();
                } else {
                    $nextButton.show();
                    $prevButton.show();
                }
            }
            function validateField($field) {
                if (!$field.prop('required') || $field.prop('disabled') || $field.prop('readonly')) {
                    $field.removeClass('is-valid is-invalid');
                    $field.siblings('.invalid-feedback').hide();
                    $field.siblings('.valid-feedback').hide();
                    return true;
                }
                const isValid = $field[0].checkValidity();
                $field.toggleClass('is-valid', isValid);
                $field.toggleClass('is-invalid', !isValid);
                const feedback = $field.siblings('.invalid-feedback');
                const validFeedback = $field.siblings('.valid-feedback');
                if (!isValid) { feedback.show(); validFeedback.hide(); }
                else { feedback.hide(); validFeedback.show(); }
                return isValid;
            }
            function validateCurrentStep() {
                let isValid = true;
                const $currentTabPane = $(`#myTabContent .tab-pane.active`);
                $currentTabPane.find('[required]').each(function () {
                    if (!$(this).prop('disabled') && !validateField($(this))) {
                        isValid = false;
                    }
                });
                return isValid;
            }

            $nextButton.on('click', function () {
                if (validateCurrentStep()) {
                    if (currentStep < totalSteps) {
                        currentStep++;
                        updateStepper();
                    }
                } else {
                    Swal.fire({
                        title: 'Campos Incompletos',
                        text: 'Por favor, complete todos los campos requeridos antes de continuar.',
                        icon: 'warning',
                        confirmButtonColor: '#3085d6'
                    });
                }
            });
            $prevButton.on('click', function () {
                if (currentStep > 1) {
                    currentStep--;
                    updateStepper();
                }
            });
            $('.progress-stepper .step').on('click', function () {
                const targetStep = parseInt($(this).data('step'));
                if (targetStep < currentStep) {
                    currentStep = targetStep;
                    updateStepper();
                } else if (targetStep > currentStep) {
                    if (validateCurrentStep()) {
                        currentStep = targetStep;
                        updateStepper();
                    } else {
                        Swal.fire({
                            title: 'Campos Incompletos',
                            text: 'Por favor, complete los campos requeridos del paso actual antes de avanzar.',
                            icon: 'warning',
                            confirmButtonColor: '#3085d6'
                        });
                    }
                }
            });
            $('form :input[required]').on('blur change keyup', function () {
                $(this).data('touched', true);
                validateField($(this));
            });
            $('form select[required]').on('change', function () {
                $(this).data('touched', true);
                validateField($(this));
            });

            // =========================
            // Responsables (entrega/recepción)
            // =========================
            async function loadResponsibleDropdowns() {
                const branchId = $('#branchId').val();
                const serviceConceptCode = $('#serviceConceptCode').val();
                const deliverySelector = '#deliveryResponsible';
                const receptionSelector = '#receptionResponsible';

                showFieldLoading(deliverySelector, 'Cargando responsables...');
                showFieldLoading(receptionSelector, 'Cargando responsables...');

                if (branchId && serviceConceptCode) {
                    try {
                        const deliveryData = await $.get('@Url.Action("GetResponsibleUsers", "Cef")', {
                            branchId: branchId, serviceConceptCode: serviceConceptCode, isDelivery: true
                        });
                        const receptionData = await $.get('@Url.Action("GetResponsibleUsers", "Cef")', {
                            branchId: branchId, serviceConceptCode: serviceConceptCode, isDelivery: false
                        });
                        fillDropdown(deliverySelector, deliveryData);
                        fillDropdown(receptionSelector, receptionData);
                    } catch (error) {
                        console.error('Error al cargar responsables:', error);
                        $(deliverySelector).html('<option value="">Error al cargar opciones</option>');
                        $(receptionSelector).html('<option value="">Error al cargar opciones</option>');
                    } finally {
                        hideFieldLoading(deliverySelector);
                        hideFieldLoading(receptionSelector);
                    }
                } else {
                    $(deliverySelector).html('<option value="">-- Seleccionar --</option>');
                    $(receptionSelector).html('<option value="">-- Seleccionar --</option>');
                    hideFieldLoading(deliverySelector);
                    hideFieldLoading(receptionSelector);
                }
            }

            // =========================
            // Clientes / Nombres de cliente
            // =========================
            function loadClientName(clientId, clientNameFieldId, callback) {
                if (clientId) {
                    $.get('@Url.Action("GetClientName", "Cef")', { clientId: clientId }, function (data) {
                        $(`#${clientNameFieldId}`).val(data.clientName);
                        if (callback) callback();
                    }).fail(function () {
                        console.error("Error al cargar el nombre del cliente.");
                        $(`#${clientNameFieldId}`).val('');
                        if (callback) callback();
                    });
                } else {
                    $(`#${clientNameFieldId}`).val('');
                    if (callback) callback();
                }
            }

            // =========================
            // Ubicaciones Origen/Destino
            // =========================
            async function loadAndFillLocationDropdown(clientIdSelector, typeSelector, codeSelector, serviceConceptCode) {
                const clientId = $(clientIdSelector).val();
                const type = $(typeSelector).val();
                const branchId = $('#branchId').val();
                const $codeDropdown = get$(codeSelector);

                showFieldLoading($codeDropdown);

                const isOrigin = (String(codeSelector).indexOf('originCode') !== -1);
                const prefix = isOrigin ? 'Origin' : 'Destination';

                // Limpia info derivada
                $(`#${prefix}Name`).val('');
                $(`#${prefix}CityName`).val('');
                $(`#${prefix}CityId`).val('');
                $(`#${prefix}BranchId`).val('');
                $(`#${prefix}RangeCode`).val('');
                $(`#${prefix}RangeDetails`).val('');

                if (clientId && type) {
                    $codeDropdown.prop('disabled', false);
                    try {
                        const data = await $.get('@Url.Action("GetPointsOrFundsForDropdown", "Cef")', {
                            clientId: clientId,
                            branchId: branchId,
                            locationType: type, // el backend acepta el value del enum
                            serviceConceptCode: serviceConceptCode
                        });
                        let options = '<option value="">-- Seleccionar --</option>';
                        $.each(data, function (i, item) {
                            options += `<option value="${item.value}">${item.text}</option>`;
                        });
                        $codeDropdown.html(options);
                    } catch (error) {
                        console.error("Error al cargar ubicaciones:", error);
                        $codeDropdown.html('<option value="">Error al cargar opciones</option>');
                    } finally {
                        hideFieldLoading($codeDropdown);
                    }
                } else {
                    $codeDropdown.html('<option value="">-- Seleccionar --</option>');
                    hideFieldLoading($codeDropdown);
                }
            }

            async function loadLocationDetails(codeFieldId, nameFieldId, cityFieldId, cityIdFieldId, branchIdFieldId, rangeCodeFieldId, rangeDetailsFieldId, isOrigin) {
                const code = $(`#${codeFieldId}`).val();
                const clientId = isOrigin ? $('#originClientId').val() : $('#destinationClientId').val();
                const type = isOrigin ? $('#originType').val() : $('#destinationType').val();

                if (code && clientId && type) {
                    const isPoint = (type === '0' || type === '1'); // 0=Punto, 1=ATM, 2=Fondo (según tu enum)
                    try {
                        const response = await $.get('@Url.Action("GetLocationDetails", "Cef")', { code: code, clientId: clientId, isPoint: isPoint });
                        if (response && response.success && response.data) {
                            const data = response.data;
                            $(`#${nameFieldId}`).val(data.name);
                            $(`#${cityFieldId}`).val(data.cityName);
                            $(`#${cityIdFieldId}`).val(data.cityId);
                            $(`#${branchIdFieldId}`).val(data.branchId);
                            $(`#${rangeCodeFieldId}`).val(data.rangeCode);
                            $(`#${rangeDetailsFieldId}`).val(data.rangeDetails);
                        } else {
                            $(`#${nameFieldId}, #${cityFieldId}, #${cityIdFieldId}, #${branchIdFieldId}, #${rangeCodeFieldId}, #${rangeDetailsFieldId}`).val('');
                        }
                    } catch (error) {
                        console.error("Error cargando detalles de ubicación:", error);
                        Swal.fire('Error', 'No se pudieron cargar los detalles de la ubicación.', 'error');
                        $(`#${nameFieldId}, #${cityFieldId}, #${cityIdFieldId}, #${branchIdFieldId}, #${rangeCodeFieldId}, #${rangeDetailsFieldId}`).val('');
                    }
                } else {
                    $(`#${nameFieldId}, #${cityFieldId}, #${cityIdFieldId}, #${branchIdFieldId}, #${rangeCodeFieldId}, #${rangeDetailsFieldId}`).val('');
                }
            }

            function loadOriginLocationDetails() {
                // FIX: corregido 'OriginCityId|' -> 'OriginCityId'
                loadLocationDetails('originCode', 'OriginName', 'OriginCityName', 'OriginCityId', 'OriginBranchId', 'OriginRangeCode', 'OriginRangeDetails', true);
            }
            function loadDestinationLocationDetails() {
                loadLocationDetails('destinationCode', 'DestinationName', 'DestinationCityName', 'DestinationCityId', 'DestinationBranchId', 'DestinationRangeCode', 'DestinationRangeDetails', false);
            }

            // =========================
            // Reglas de Concepto: autoselección Step 2
            // =========================
            const LOCKED_CONCEPTS_SAME_CLIENT = ['RC', 'PV', 'PR', 'ET']; // Ajusta si es necesario

            function syncDestinationClientAndLock() {
                const concept = $('#serviceConceptCode').val();
                const originClient = $('#originClientId').val();

                if (originClient && LOCKED_CONCEPTS_SAME_CLIENT.includes(concept)) {
                    setAndLockSelect('#destinationClientId', originClient);
                    loadClientName(originClient, 'DestinationClientName', function () {
                        loadAndFillLocationDropdown('#destinationClientId', '#destinationType', '#destinationCode', concept);
                    });
                } else {
                    unlockSelect('#destinationClientId');
                }
            }

            function applyConceptAutoRules(concept) {
                // Detecta los valores apropiados del enum (texto → value) de manera robusta
                const vPunto = getOptionValueByText('#originType', 'Punto');
                const vFondo = getOptionValueByText('#originType', 'Fondo');
                const vATM   = getOptionValueByText('#originType', 'ATM');

                // Mapeo por defecto (ajusta si tu negocio requiere ATM en destino u origen)
                if (['RC', 'PV'].includes(concept)) {
                    setAndLockSelect('#originType', vPunto ?? '0');
                    setAndLockSelect('#destinationType', vFondo ?? '2');
                } else if (['PR', 'ET'].includes(concept)) {
                    setAndLockSelect('#originType', vFondo ?? '2');
                    setAndLockSelect('#destinationType', vPunto ?? '0');
                    // Si quisieras ATM en alguno:
                    // setAndLockSelect('#destinationType', vATM ?? '1');
                } else {
                    unlockSelect('#originType');
                    unlockSelect('#destinationType');
                }

                // Recargar combos de códigos según lo elegido y clientes actuales
                const code = concept;
                if ($('#originClientId').val()) {
                    loadAndFillLocationDropdown('#originClientId', '#originType', '#originCode', code);
                }
                if ($('#destinationClientId').val()) {
                    loadAndFillLocationDropdown('#destinationClientId', '#destinationType', '#destinationCode', code);
                }

                // Cliente destino = cliente origen si aplica
                syncDestinationClientAndLock();

                // Mostrar/ocultar Kit de Cambio por concepto (opcional)
                toggleExchangeKitField(concept);
            }

            function toggleExchangeKitField(concept) {
                // Ejemplo: mostrar para PR/ET (ATM), ocultar para RC/PV (recolección/provisión)
                const showFor = ['PR', 'ET'];
                const $section = $('#ExchangeKitCount').closest('.col-12.col-lg-4');
                if (showFor.includes(concept)) {
                    $section.show();
                } else {
                    $section.hide();
                    $('#ExchangeKitCount').val('');
                }
            }

            // =========================
            // Totales declarados
            // =========================
            function calculateTotalDeclared() {
                const billValue = parseFloat($('#DeclaredBillValue').val()) || 0;
                const coinValue = parseFloat($('#DeclaredCoinValue').val()) || 0;
                const docValue  = parseFloat($('#DeclaredDocumentValue').val()) || 0;
                const total = billValue + coinValue + docValue;

                $('#billValue').text(`$${billValue.toLocaleString('es-CO')}`);
                $('#coinValue').text(`$${coinValue.toLocaleString('es-CO')}`);
                $('#totalValue').text(`$${total.toLocaleString('es-CO')}`);
            }

            // =========================
            // Listeners de negocio
            // =========================
            $('#branchId').on('change', function () {
                if ($('#originClientId').val()) {
                    loadAndFillLocationDropdown('#originClientId', '#originType', '#originCode', $('#serviceConceptCode').val());
                }
                if ($('#destinationClientId').val()) {
                    // FIX: aquí antes llamaba mal con origin; ahora carga destino
                    loadAndFillLocationDropdown('#destinationClientId', '#destinationType', '#destinationCode', $('#serviceConceptCode').val());
                }
                loadResponsibleDropdowns();
            });

            $('#serviceConceptCode').on('change', function () {
                const concept = $(this).val();
                applyConceptAutoRules(concept);
                loadResponsibleDropdowns();
                toggleExchangeKitFieldForConcept(concept);
                calculateTotalDeclared();
            });

            $('#originClientId').on('change', function () {
                const clientId = $(this).val();
                loadClientName(clientId, 'OriginClientName', function () {
                    // Carga ORIGEN bien (antes estaba mal apuntando a destino)
                    loadAndFillLocationDropdown('#originClientId', '#originType', '#originCode', $('#serviceConceptCode').val());
                    // Sincroniza destino si aplica
                    syncDestinationClientAndLock();
                });
            });

            $('#originType').on('change', function () {
                loadAndFillLocationDropdown('#originClientId', '#originType', '#originCode', $('#serviceConceptCode').val());
            });
            $('#originCode').on('change', loadOriginLocationDetails);

            $('#destinationClientId').on('change', function () {
                const clientId = $(this).val();
                loadClientName(clientId, 'DestinationClientName', function () {
                    loadAndFillLocationDropdown('#destinationClientId', '#destinationType', '#destinationCode', $('#serviceConceptCode').val());
                });
            });
            $('#destinationType').on('change', function () {
                loadAndFillLocationDropdown('#destinationClientId', '#destinationType', '#destinationCode', $('#serviceConceptCode').val());
            });
            $('#destinationCode').on('change', loadDestinationLocationDetails);

            $('.calculate-total-declared').on('input', calculateTotalDeclared);

            // =========================
            // Fallo (show/hide)
            // =========================
            $('#isFailedSwitch').on('change', function () {
                const isFailed = $(this).is(':checked');
                const $section = $('#failedReasonSection');
                if (isFailed) {
                    $section.show();
                    $('#failedResponsible').prop('required', true).closest('.form-floating').addClass('has-validation');
                    $('#failedReason').prop('required', true).closest('.form-floating').addClass('has-validation');
                } else {
                    $section.hide();
                    $('#failedResponsible').prop('required', false).removeClass('is-invalid is-valid').val('');
                    $('#failedReason').prop('required', false).removeClass('is-invalid is-valid').val('');
                }
            });

            function isProvisionOrRecoleccion(concept) {
              return ['PV', 'RC', '1', '4'].includes(concept);
            }

            function toggleExchangeKitFieldForConcept(concept) {
              const $section = $('#ExchangeKitCount').closest('.col-12.col-lg-3');
              if (isProvisionOrRecoleccion(concept)) {
                // Ocultar y limpiar si es Provisión/Recolección
                $section.hide();
                $('#ExchangeKitCount').val('');
              } else {
                // Mostrar para los demás conceptos (p.ej. PR/ET)
                $section.show();
              }
            }
            function calculateTotalDeclared() {
              const total = parseFloat($('#ServiceValue').val()) || 0;
              $('#totalValue').text('$' + total.toLocaleString('es-CO'));
            }

            // =========================
            // Submit
            // =========================
            $('button[data-step-action="submit-final"]').on('click', function (e) {
                e.preventDefault();
                if (!validateCurrentStep()) {
                    Swal.fire({
                        title: 'Campos Incompletos',
                        text: 'Por favor, complete todos los campos requeridos en este paso antes de registrar.',
                        icon: 'warning',
                        confirmButtonColor: '#3085d6'
                    });
                    return;
                }
                Swal.fire({
                    title: '¿Está seguro?',
                    text: '¿Desea registrar este nuevo servicio?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, registrar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Registrando servicio...',
                            text: 'Por favor, espere.',
                            allowOutsideClick: false,
                            didOpen: () => { Swal.showLoading(); }
                        });
                        const formData = $form.serialize();
                        const url = $form.attr('action');
                        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                        $.ajax({
                            url: url,
                            type: 'POST',
                            data: formData,
                            headers: { 'RequestVerificationToken': token },
                            success: function (response) {
                                Swal.close();
                                if (response.success) {
                                    Swal.fire('¡Éxito!', response.message, 'success')
                                        .then(() => { window.location.href = '@Url.Action("Reception", "Cef")'; });
                                } else {
                                    let errorText = response.message || "Por favor, corrija los errores en el formulario.";
                                    if (response.errors) {
                                        $('.field-validation-error').text('');
                                        $('input, select, textarea').removeClass('is-invalid is-valid');
                                        $('.invalid-feedback, .valid-feedback').hide();
                                        $.each(response.errors, function (key, value) {
                                            const $field = $(`[name="${key}"]`);
                                            $field.addClass('is-invalid');
                                            let errorSpan = $field.siblings(`[data-valmsg-for="${key}"]`);
                                            if (errorSpan.length === 0) {
                                                errorSpan = $('<span>').addClass('text-danger field-validation-error').attr('data-valmsg-for', key);
                                                $field.after(errorSpan);
                                            }
                                            errorSpan.text(value.join(', ')).show();
                                            const bsFeedback = $field.siblings('.invalid-feedback');
                                            if (bsFeedback.length > 0) { bsFeedback.text(value.join(', ')).show(); }
                                        });
                                        errorText = "Se encontraron errores. Por favor, revise los campos marcados.";
                                    }
                                    Swal.fire('Error', errorText, 'error');
                                }
                            },
                            error: function (xhr, status, error) {
                                Swal.close();
                                console.error('Error al enviar formulario:', xhr.responseText);
                                Swal.fire('Error', `Ocurrió un error al intentar registrar el servicio: ${xhr.statusText || error}.`, 'error');
                            }
                        });
                    }
                });
            });

            // =========================
            // Init (autoselección Paso 2)
            // =========================
            calculateTotalDeclared();
            loadResponsibleDropdowns();
            applyConceptAutoRules($('#serviceConceptCode').val() || '');
            updateStepper();
            toggleExchangeKitFieldForConcept($('#serviceConceptCode').val() || '');
            calculateTotalDeclared();
        });
    </script>
}