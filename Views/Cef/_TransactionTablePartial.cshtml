@model IEnumerable<VCashApp.Models.ViewModels.CentroEfectivo.CefTransactionSummaryViewModel>
@{
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int totalData = ViewBag.TotalData ?? 0;
    int pageSize = ViewBag.PageSize ?? 15;

    bool canEdit = ViewBag.HasEdit ?? false;

    const int maxPagesToShow = 5;
    int halfPagesToShow = (maxPagesToShow - 1) / 2;

    int startPage = Math.Max(1, currentPage - halfPagesToShow);
    int endPage = Math.Min(totalPages, currentPage + halfPagesToShow);

    if (endPage - startPage + 1 < maxPagesToShow)
    {
        if (startPage == 1)
        {
            endPage = Math.Min(totalPages, startPage + maxPagesToShow - 1);
        }
        else if (endPage == totalPages)
        {
            startPage = Math.Max(1, endPage - maxPagesToShow + 1);
        }
    }
}

<div class="table-section">
    <div class="table-container">
        <div class="table-wrapper">
            <table class="table" id="dataTable">
                <thead>
                    <tr>
                        <th>Orden Servicio</th>
                        <th>Planilla</th>
                        <th>Divisa</th>
                        <th>Tipo Transacción</th>
                        <th>Valor Declarado</th>
                        <th>Valor Contado</th>
                        <th>Diferencia</th>
                        <th class="status-column-header">Estado</th>
                        <th>Fecha Registro</th>
                        <th><i class="ri-list-settings-fill"></i></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var transaction in Model)
                        {
                            <tr>
                                <td>@transaction.ServiceOrderId</td>
                                <td>@transaction.SlipNumber</td>
                                <td>@transaction.Currency</td>
                                <td>@transaction.TransactionType.Replace("_", " ")</td>
                                <td>@transaction.TotalDeclaredValue.ToString("N0")</td>
                                <td>@transaction.TotalCountedValue.ToString("N0")</td>
                                <td class="@(transaction.ValueDifference != 0 ? "text-danger" : "")">@transaction.ValueDifference.ToString("N0")</td>
                                <td class="status-column">
                                    @{
                                        string statusText = transaction.TransactionStatus.Replace("_", " ");
                                        string badgeClass = "badge";
                                        switch (transaction.TransactionStatus)
                                        {
                                            case nameof(VCashApp.Enums.CefTransactionStatusEnum.RegistroTesoreria): badgeClass += " bg-primary"; break;
                                            case nameof(VCashApp.Enums.CefTransactionStatusEnum.EncoladoParaConteo): badgeClass += " bg-secondary"; break;
                                            case nameof(VCashApp.Enums.CefTransactionStatusEnum.ConteoBilletes):
                                            case nameof(VCashApp.Enums.CefTransactionStatusEnum.ConteoMonedas):
                                            case nameof(VCashApp.Enums.CefTransactionStatusEnum.ConteoCheques):
                                            case nameof(VCashApp.Enums.CefTransactionStatusEnum.ConteoDocumentos): badgeClass += " bg-info"; break;
                                            case nameof(VCashApp.Enums.CefTransactionStatusEnum.PendienteRevision): badgeClass += " bg-warning text-dark"; break;
                                            case nameof(VCashApp.Enums.CefTransactionStatusEnum.Aprobado): badgeClass += " bg-success"; break;
                                            case nameof(VCashApp.Enums.CefTransactionStatusEnum.Rechazado): badgeClass += " bg-danger"; break;
                                            case nameof(VCashApp.Enums.CefTransactionStatusEnum.Cancelado): badgeClass += " bg-dark"; break;
                                            default: badgeClass += " bg-secondary"; break;
                                        }
                                    }
                                    <span class="badge @badgeClass">@statusText</span>
                                </td>
                                <td>@transaction.RegistrationDate.ToShortDateString() @transaction.RegistrationDate.ToShortTimeString()</td>
                                <td>
                                    <div class="action-buttons d-flex align-items-center justify-content-center">
                                        <a href="@Url.Action("Detail", "Cef", new { transactionId = transaction.Id })" class="btn-detail" title="Ver Detalles">
                                            <i class="ri-eye-fill"></i>
                                        </a>
                                        @if (canEdit)
                                        {
                                            @if (transaction.TransactionStatus == nameof(VCashApp.Enums.CefTransactionStatusEnum.RegistroTesoreria))
                                            {
                                                <a asp-controller="Cef" asp-action="Checkin" asp-route-serviceOrderId="@transaction.ServiceOrderId" class="btn-edit" title="Editar">
                                                    <i class="ri-pencil-fill"></i>
                                                </a>
                                            }
                                            @if (transaction.TransactionStatus == nameof(VCashApp.Enums.CefTransactionStatusEnum.EncoladoParaConteo) ||
                                                transaction.TransactionStatus == nameof(VCashApp.Enums.CefTransactionStatusEnum.ConteoBilletes) ||
                                                transaction.TransactionStatus == nameof(VCashApp.Enums.CefTransactionStatusEnum.ConteoMonedas) ||
                                                transaction.TransactionStatus == nameof(VCashApp.Enums.CefTransactionStatusEnum.ConteoCheques) ||
                                                transaction.TransactionStatus == nameof(VCashApp.Enums.CefTransactionStatusEnum.ConteoDocumentos))
                                            {
                                                <a asp-action="ProcessContainers" asp-route-transactionId="@transaction.Id" class="btn-detail" title="Procesar Contenedores">
                                                    <i class="ri-money-dollar-circle-fill"></i>
                                                </a>
                                            }
                                            @if (transaction.TransactionStatus == nameof(VCashApp.Enums.CefTransactionStatusEnum.PendienteRevision))
                                            {
                                                <a asp-action="ReviewTransaction" asp-route-transactionId="@transaction.Id" class="btn-edit ml-1" title="Revisar Transacción">
                                                    <i class="ri-check-double-line"></i>
                                                </a>
                                            }
                                            <a asp-action="ReviewTransaction" asp-route-transactionId="@transaction.Id" class="btn-edit ml-1" title="Revisar Transacción">
                                                <i class="ri-check-double-line"></i>
                                            </a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="10" class="text-center">No se encontraron transacciones de Centro de Efectivo.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="table-footer">
        <div class="page-message">Página @currentPage de @totalPages (Total: @totalData registros)</div>
        <div class="pagination">
            <button class="page-link" data-page="1" @(currentPage == 1 ? "disabled" : "")>&laquo;</button>

            <button class="page-link" data-page="@(currentPage - 1)" @(currentPage == 1 ? "disabled" : "")>&lt;</button>

            @if (startPage > 1)
            {
                <button class="page-link" data-page="@(startPage - 1)">...</button>
            }

            @for (int i = startPage; i <= endPage; i++)
            {
                <button class="page-link @(currentPage == i ? "active-page" : "")" data-page="@i">@i</button>
            }

            @if (endPage < totalPages)
            {
                <button class="page-link" data-page="@(endPage + 1)">...</button>
            }

            <button class="page-link" data-page="@(currentPage + 1)" @(currentPage == totalPages ? "disabled" : "")>&gt;</button>

            <button class="page-link" data-page="@totalPages" @(currentPage == totalPages ? "disabled" : "")>&raquo;</button>
        </div>
    </div>
</div>