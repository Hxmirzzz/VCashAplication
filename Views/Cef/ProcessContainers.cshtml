@model VCashApp.Models.ViewModels.CentroEfectivo.CefProcessContainersPageViewModel
@{
    ViewData["Title"] = "Procesar Contenedores";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="form-container">
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Procesamiento de Contenedores</h4>
        </div>
        <div class="card-body">
            <form id="cefContainersForm" asp-action="ProcessContainers" asp-controller="Cef" method="post" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="CefTransactionId" />

                <!-- Stepper principal -->
                <div class="progress-stepper" id="progressStepper">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Información General</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Conteo y Detalles</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Resumen</div>
                    </div>
                </div>

                <div class="tab-content" id="myTabContent">

                    <!-- PASO 1: info general (solo lectura) -->
                    <div class="tab-pane fade show active" role="tabpanel" data-step="1">
                        <div class="step-content">
                            <div class="card mb-4">
                                <div class="card-header"><h5>📋 Cabecera del Servicio</h5></div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Transaction.SlipNumber" readonly />
                                                <label>Número de Planilla</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.ServiceOrderId" readonly />
                                                <label>Orden de Servicio</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.BranchName" readonly />
                                                <label>Sucursal</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input class="form-control" value="@(Model.Service.ServiceDate?.ToString("yyyy-MM-dd") ?? "N/A")" readonly />
                                                <label>Fecha de Servicio</label>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.ClientName" readonly />
                                                <label>Cliente</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.ConceptName" readonly />
                                                <label>Concepto</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Transaction.Currency" readonly />
                                                <label>Divisa</label>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.OriginName" readonly />
                                                <label>Origen</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.DestinationName" readonly />
                                                <label>Destino</label>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Transaction.TransactionType" readonly />
                                                <label>Tipo de Transacción</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Transaction.Status" readonly />
                                                <label>Estado</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Transaction.RegistrationDate.ToString("yyyy-MM-dd HH:mm")" readonly />
                                                <label>Fecha Registro Transacción</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>                            
                        </div>
                    </div>

                    <!-- PASO 2: pestañas de contenedores -->
                    <div class="tab-pane fade" role="tabpanel" data-step="2">
                        <div class="step-content">
                            <div class="card mb-3">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <h5 class="mb-0">🧰 Contenedores (Bolsas / Sobres)</h5>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-primary" id="btnAddContainer">+ Agregar</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <ul class="nav nav-tabs" id="containersTabs" role="tablist">
                                        @for (var i = 0; i < Model.Containers.Count; i++)
                                        {
                                            var tabId = $"c-tab-{i}";
                                            var typeLabel = Model.Containers[i].ContainerType.ToString();
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link @(i == 0 ? "active" : "")"
                                                        id="@($"{tabId}-btn")"
                                                        data-bs-toggle="tab"
                                                        data-bs-target="@($"#{tabId}")"
                                                        type="button" role="tab">
                                                    Contenedor @(i + 1) - @typeLabel
                                                </button>
                                            </li>
                                        }
                                    </ul>
                                    <div class="tab-content mt-3" id="containersTabContent">
                                        @for (var i = 0; i < Model.Containers.Count; i++)
                                        {
                                            var tabId = $"c-tab-{i}";
                                            <div class="tab-pane fade @(i==0?"show active":"")" id="@tabId" role="tabpanel">
                                                @{
                                                    var vdd = new ViewDataDictionary(ViewData);
                                                    vdd.TemplateInfo.HtmlFieldPrefix = $"Containers[{i}]";
                                                }
                                                @Html.Partial("_ContainerEditorPartial", Model.Containers[i], vdd)
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="card mt-4">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <h5 class="mb-0">🧾 Novedades (Opcional)</h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="toggleIncidents">
                                        <label class="form-check-label" for="toggleIncidents">Reportar novedades</label>
                                    </div>
                                </div>

                                <div class="card-body" id="incidentsPanel" style="display:none;">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating has-validation">
                                                <select id="incidentContainerSelector" class="form-select">
                                                    <option value="">Seleccionar bolsa/sobre...</option>
                                                    @for (var i = 0; i < Model.Containers.Count; i++)
                                                    {
                                                        var label = $"#{i + 1} - {Model.Containers[i].ContainerType} - {Model.Containers[i].ContainerCode}";
                                                        <option value="@i">@label</option>
                                                    }
                                                </select>
                                                <label for="incidentContainerSelector">Aplicar a</label>
                                                <div class="invalid-feedback">⚠ Seleccione un contenedor</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-6 d-flex align-items-end">
                                            <button type="button" id="btnAddIncident" class="btn btn-outline-primary">
                                                + Agregar novedad
                                            </button>
                                        </div>
                                    </div>

                                    @for (var i = 0; i < Model.Containers.Count; i++)
                                    {
                                        <div id="inc-list-c@i" class="mt-3"></div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 3: Resumen -->
                    <div class="tab-pane fade" role="tabpanel" data-step="3">
                        <div class="step-content">
                            <div class="card">
                                <div class="card-header"><h5>📊 Resumen</h5></div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" id="sumDeclaredAll" value="@Model.TotalDeclaredAll.ToString("N0")" readonly />
                                                <label>Total Declarado</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" id="sumCountedAll" value="@Model.TotalCountedAll.ToString("N0")" readonly />
                                                <label>Total Contado</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" id="sumDiffAll" value="@Model.DifferenceAll.ToString("N0")" readonly />
                                                <label>Diferencia</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-info mt-3">
                                        Este resumen se recalcula al guardar los contenedores (veremos el multipost luego).
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Botonera -->
                <div class="submit-container form-group col-12 mt-4">
                    <button type="button" class="btn btn-secondary" data-step-action="prev" style="display:none;">Anterior</button>
                    <button type="button" class="btn btn-primary" data-step-action="next">Continuar</button>
                    <button type="submit" class="btn btn-primary" data-step-action="submit-final" style="display:none;">Guardar</button>
                    <a asp-action="Index" class="btn btn-danger">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="container-template" class="d-none">
    @{
        var vddT = new ViewDataDictionary(ViewData);
        vddT.TemplateInfo.HtmlFieldPrefix = "Containers[__idx__]";
    }
    @Html.Partial("_ContainerEditorPartial",
    new VCashApp.Models.ViewModels.CentroEfectivo.CefContainerProcessingViewModel(),
        vddT)
</div>

<div id="incident-template" class="d-none">
    <div class="incident-row card mt-3" data-cidx="__cidx__" data-iidx="__iidx__">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-lg-4">
                    <div class="form-floating has-validation">
                        <select name="Containers[__cidx__].Incidents[__iidx__].IncidentType" class="form-select">
                            <option value="">Seleccionar tipo...</option>
                            @foreach (var it in (IEnumerable<SelectListItem>)ViewBag.IncidentTypes ?? new List<SelectListItem>())
                                                        {
                                <option value="@it.Value">@it.Text</option>
                            }
                        </select>
                        <label>Tipo de Novedad</label>
                        <div class="invalid-feedback">⚠ Requerido</div>
                        <div class="valid-feedback">✓ Correcto</div>
                    </div>
                </div>

                <div class="col-12 col-lg-3">
                    <div class="form-floating has-validation">
                        <input type="number" step="0.01"
                               name="Containers[__cidx__].Incidents[__iidx__].AffectedAmount"
                               class="form-control" placeholder="Monto afectado" />
                        <label>Monto afectado</label>
                        <div class="invalid-feedback">⚠ Requerido</div>
                        <div class="valid-feedback">✓ Correcto</div>
                    </div>
                </div>

                <div class="col-12 col-lg-3">
                    <div class="form-floating">
                        <input type="number" step="0.01"
                               name="Containers[__cidx__].Incidents[__iidx__].AffectedDenomination"
                               class="form-control" placeholder="Denominación afectada" />
                        <label>Denominación afectada</label>
                    </div>
                </div>

                <div class="col-12 col-lg-2">
                    <div class="form-floating">
                        <input type="number"
                               name="Containers[__cidx__].Incidents[__iidx__].AffectedQuantity"
                               class="form-control" placeholder="Cantidad" />
                        <label>Cantidad</label>
                    </div>
                </div>

                <div class="col-12">
                    <div class="form-floating has-validation">
                        <textarea name="Containers[__cidx__].Incidents[__iidx__].Description"
                                  class="form-control" placeholder="Descripción"
                                  style="height: 80px;"></textarea>
                        <label>Descripción</label>
                        <div class="invalid-feedback">⚠ Requerido</div>
                        <div class="valid-feedback">✓ Correcto</div>
                    </div>
                </div>

                <div class="col-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-danger btn-sm js-remove-incident">
                        Eliminar novedad
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(function () {
          // ====== STEPPER BÁSICO ======
          let currentStep = 1;
          const totalSteps = 3;

          const $form   = $('#cefContainersForm');
          const $next   = $('button[data-step-action="next"]');
          const $prev   = $('button[data-step-action="prev"]');
          const $submit = $('button[data-step-action="submit-final"]');

          function updateStepper() {
            $('.progress-stepper .step').removeClass('active completed');
            for (let i = 1; i <= totalSteps; i++) {
              const $step = $('.step[data-step="' + i + '"]');
              if (i < currentStep) { $step.addClass('completed'); $step.find('.step-number').html('&#10003;'); }
              else if (i === currentStep) { $step.addClass('active'); $step.find('.step-number').text(i); }
              else { $step.find('.step-number').text(i); }
            }
            showCurrentStep();
          }

          function showCurrentStep() {
            $('.tab-pane[data-step]').removeClass('show active');
            $('#myTabContent div[data-step="' + currentStep + '"]').addClass('show active');
            $prev.toggle(currentStep > 1);
            $next.toggle(currentStep < totalSteps);
            $submit.toggle(currentStep === totalSteps);
          }

          function validateField($f) {
            if ($f.prop('disabled') || $f.prop('readonly')) {
              $f.removeClass('is-invalid is-valid');
              return true;
            }
            const ok = $f[0].checkValidity();
            $f.toggleClass('is-valid', ok).toggleClass('is-invalid', !ok);

            const $c = $f.closest('.has-validation');
            const $invalid = $c.find('.invalid-feedback');
            const $valid   = $c.find('.valid-feedback');
            if (ok) { $invalid.hide(); $valid.show(); } else { $invalid.text($f[0].validationMessage || '⚠ Campo inválido').show(); $valid.hide(); }
            return ok;
          }

          function validateCurrentStep() {
            let ok = true;
            $('#myTabContent .tab-pane[data-step].active :input[required]').each(function(){
              if (!$(this).is(':disabled')) ok = validateField($(this)) && ok;
            });
            return ok;
          }

          $('.progress-stepper .step').on('click', function () {
            const target = parseInt($(this).data('step'));
            if (target < currentStep || validateCurrentStep()) { currentStep = target; updateStepper(); }
          });
          $next.on('click', function () {
            if (validateCurrentStep() && currentStep < totalSteps) { currentStep++; updateStepper(); }
            else if (!validateCurrentStep()) {
              Swal.fire({ title: 'Campos incompletos', text: 'Complete los requeridos.', icon: 'warning', confirmButtonColor: '#3085d6' });
            }
          });
          $prev.on('click', function () { if (currentStep > 1) { currentStep--; updateStepper(); } });


          // ====== TABS DE CONTENEDORES ======
          // Actualiza el título del tab con el tipo seleccionado
          function refreshTabTitle(i) {
            const $pane = $('#c-tab-' + i);
            const $btn  = $('#c-tab-' + i + '-btn');
            const $sel  = $pane.find('select[name="Containers[' + i + '].ContainerType"]');
            const selectedText = ($sel.find('option:selected').text() || '').trim(); // "Bolsa" | "Sobre"
            const nicetype = selectedText || 'Sin tipo';
            $btn.text('Contenedor ' + (i + 1) + ' - ' + nicetype);
          }

          // Muestra/oculta secciones de editor según tipo (Bolsa/Sobre) y modo de sobre (Docs/Cheque)
          function toggleContainerSections($pane) {
            // Tipo de contenedor
            const idx = $pane.attr('id').split('-').pop(); // c-tab-<idx>
            const $sel = $pane.find('select[name="Containers[' + idx + '].ContainerType"]');
            const typeText = ($sel.find('option:selected').text() || '').trim().toLowerCase();
            const isBolsa = (typeText.indexOf('bolsa') === 0);

            // Secciones que deben existir en _ContainerEditorPartial:
            // .sec-bolsa
            // .sec-sobre  (wrapper general)
            //   .sec-sobre-docs
            //   .sec-sobre-cheque
            $pane.find('.sec-bolsa').toggle(isBolsa).find(':input').prop('disabled', !isBolsa);
            $pane.find('.sec-sobre').toggle(!isBolsa).find(':input').prop('disabled', isBolsa);

            if (!isBolsa) {
              // Modo del sobre (radio .js-sobre-mode con values "Docs" | "Check")
              const $mode = $pane.find('.js-sobre-mode:checked');
              const modeVal = (($mode.val() || 'Docs') + '').toLowerCase();
              const isDocs = (modeVal === 'docs');

              $pane.find('.sec-sobre-docs').toggle(isDocs).find(':input').prop('disabled', !isDocs);
              $pane.find('.sec-sobre-cheque').toggle(!isDocs).find(':input').prop('disabled', isDocs);
            }
          }

          // Enlaza eventos por contenedor
          function wireContainerEvents(i) {
            const $pane = $('#c-tab-' + i);

            // Cambio de tipo (Bolsa/Sobre)
            $pane.on('change', 'select[name="Containers[' + i + '].ContainerType"]', function () {
              toggleContainerSections($pane);
              refreshTabTitle(i);
            });

            // Cambio de modo del sobre (Docs | Cheque)
            $pane.on('change', '.js-sobre-mode', function () {
              toggleContainerSections($pane);
            });

            // Agregar/Eliminar filas de Detalles (bolsa o sobre-docs)
            $pane.on('click', '.js-add-detail', function () {
              const $tbody = $pane.find('.js-details-table tbody');
              const j = $tbody.find('tr').length;
              const row =
                '<tr>' +
                  '<td>' +
                    '<select name="Containers[' + i + '].ValueDetails[' + j + '].ValueType" class="form-select form-select-sm">' +
                      '<option value="Bill">Billete</option>' +
                      '<option value="Coin">Moneda</option>' +
                      '<option value="Document">Documento</option>' +
                    '</select>' +
                  '</td>' +
                  '<td><input name="Containers[' + i + '].ValueDetails[' + j + '].Denomination" type="number" step="1" class="form-control form-control-sm js-calc" /></td>' +
                  '<td><input name="Containers[' + i + '].ValueDetails[' + j + '].Quantity" type="number" class="form-control form-control-sm js-calc" /></td>' +
                  '<td><input name="Containers[' + i + '].ValueDetails[' + j + '].BundlesCount" type="number" class="form-control form-control-sm js-calc" /></td>' +
                  '<td><input name="Containers[' + i + '].ValueDetails[' + j + '].LoosePiecesCount" type="number" class="form-control form-control-sm js-calc" /></td>' +
                  '<td><input name="Containers[' + i + '].ValueDetails[' + j + '].UnitValue" type="number" step="1" class="form-control form-control-sm js-calc" /></td>' +
                  '<td><input name="Containers[' + i + '].ValueDetails[' + j + '].CalculatedAmount" type="number" step="1" class="form-control form-control-sm" readonly /></td>' +
                  '<td><button type="button" class="btn btn-sm btn-outline-danger js-remove-detail">×</button></td>' +
                '</tr>';
              $tbody.append(row);
            });
            $pane.on('click', '.js-remove-detail', function () { $(this).closest('tr').remove(); });

            // Cálculo por fila
            $pane.on('input', '.js-calc', function () {
              const $row  = $(this).closest('tr');
              const denom = parseFloat($row.find('input[name$=".Denomination"]').val()) || 0;
              const qty   = parseFloat($row.find('input[name$=".Quantity"]').val()) || 0;
              const unit  = parseFloat($row.find('input[name$=".UnitValue"]').val()) || 0;
              const amt   = (denom > 0 && unit > 0) ? (qty * unit) : (denom * qty);
              $row.find('input[name$=".CalculatedAmount"]').val(amt.toFixed(0));
            });

            // Agregar/Eliminar filas de Novedades (tabla local del contenedor)
            $pane.on('click', '.js-add-incident', function () {
              const $tbody = $pane.find('.js-incidents-table tbody');
              const j = $tbody.find('tr').length;
              const row =
                '<tr>' +
                  '<td>' +
                    '<select name="Containers[' + i + '].Incidents[' + j + '].IncidentType" class="form-select form-select-sm">' +
                      '<option value="Faltante">Faltante</option>' +
                      '<option value="Sobrante">Sobrante</option>' +
                      '<option value="Falso">Falso</option>' +
                      '<option value="Deteriorado">Deteriorado</option>' +
                    '</select>' +
                  '</td>' +
                  '<td><input name="Containers[' + i + '].Incidents[' + j + '].AffectedAmount" type="number" step="1" class="form-control form-control-sm" /></td>' +
                  '<td><input name="Containers[' + i + '].Incidents[' + j + '].AffectedDenomination" type="number" step="1" class="form-control form-control-sm" /></td>' +
                  '<td><input name="Containers[' + i + '].Incidents[' + j + '].AffectedQuantity" type="number" class="form-control form-control-sm" /></td>' +
                  '<td><input name="Containers[' + i + '].Incidents[' + j + '].Description" class="form-control form-control-sm" /></td>' +
                  '<td><button type="button" class="btn btn-sm btn-outline-danger js-remove-incident">×</button></td>' +
                '</tr>';
              $tbody.append(row);
            });
            $pane.on('click', '.js-remove-incident', function () { $(this).closest('tr').remove(); });

            // Estado inicial
            toggleContainerSections($pane);
            refreshTabTitle(i);
          }

          // Agregar un contenedor genérico (usuario elige Bolsa/Sobre en el editor)
          $('#btnAddContainer').on('click', function () {
            const $tablist    = $('#containersTabs');
            const $tabcontent = $('#containersTabContent');
            const nextIndex   = $tabcontent.children('.tab-pane').length;
            const newId       = 'c-tab-' + nextIndex;

            // Botón del tab
            const $btn = $(
              '<li class="nav-item" role="presentation">' +
                '<button class="nav-link" id="' + newId + '-btn" data-bs-toggle="tab" data-bs-target="#' + newId + '" type="button" role="tab">' +
                  'Contenedor ' + (nextIndex + 1) + ' - Sin tipo' +
                '</button>' +
              '</li>');
            $tablist.append($btn);

            // Contenido desde el template oculto
            let html = $('#container-template').html();
            // reemplazo seguro del placeholder __idx__
            while (html.indexOf('__idx__') !== -1) html = html.replace('__idx__', nextIndex);
            const $pane = $('<div class="tab-pane fade" id="' + newId + '" role="tabpanel">' + html + '</div>');
            $tabcontent.append($pane);

            // Activar el tab recién creado
            $tablist.find('button.nav-link').removeClass('active');
            $tabcontent.find('.tab-pane').removeClass('show active');
            $btn.addClass('active');
            $pane.addClass('show active');

            // Enlazar eventos y ajustar estado inicial
            wireContainerEvents(nextIndex);
          });

          // Inicializa eventos para contenedores que ya vienen en el modelo.
          (function initExistingContainers(){
            const count = $('#containersTabContent .tab-pane').length;
            for (let i = 0; i < count; i++) wireContainerEvents(i);

            // Si no hay ninguno, crea el primero automáticamente
            if (count === 0) $('#btnAddContainer').trigger('click');
          })();


          // ====== SUBMIT (dejamos postback normal; si quieres AJAX, copia tu bloque SweetAlert del Checkin) ======
          $('button[data-step-action="submit-final"]').on('click', function (e) {
            if (!validateCurrentStep()) {
              e.preventDefault();
              Swal.fire({ title: 'Campos incompletos', text: 'Revise los campos requeridos.', icon: 'warning', confirmButtonColor: '#3085d6' });
            }
          });

          // Start UI
          updateStepper();
        });
    </script>
}