@model VCashApp.Models.ViewModels.CentroEfectivo.CefProcessContainersPageViewModel
@{
    ViewData["Title"] = "Procesar Contenedores";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="form-container">
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Procesamiento de Contenedores</h4>
        </div>
        <div class="card-body">
            <form id="cefContainersForm" asp-action="ProcessContainers" asp-controller="Cef" method="post" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="CefTransactionId" />

                <!-- Stepper principal -->
                <div class="progress-stepper" id="progressStepper">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Información General</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Conteo y Detalles</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Resumen</div>
                    </div>
                </div>

                <div class="tab-content" id="myTabContent">

                    <!-- PASO 1: info general (solo lectura) -->
                    <div class="tab-pane fade show active" role="tabpanel" data-step="1">
                        <div class="step-content">
                            <div class="card mb-4">
                                <div class="card-header"><h5>📋 Cabecera del Servicio</h5></div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Transaction.SlipNumber" readonly />
                                                <label>Número de Planilla</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.ServiceOrderId" readonly />
                                                <label>Orden de Servicio</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.BranchName" readonly />
                                                <label>Sucursal</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input class="form-control" value="@(Model.Service.ServiceDate?.ToString("yyyy-MM-dd") ?? "N/A")" readonly />
                                                <label>Fecha de Servicio</label>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.ClientName" readonly />
                                                <label>Cliente</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.ConceptName" readonly />
                                                <label>Concepto</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Transaction.Currency" readonly />
                                                <label>Divisa</label>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.OriginName" readonly />
                                                <label>Origen</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Service.DestinationName" readonly />
                                                <label>Destino</label>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Transaction.TransactionType" readonly />
                                                <label>Tipo de Transacción</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Transaction.Status" readonly />
                                                <label>Estado</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="@Model.Transaction.RegistrationDate.ToString("yyyy-MM-dd HH:mm")" readonly />
                                                <label>Fecha Registro Transacción</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>                            
                        </div>
                    </div>

                    <!-- PASO 2: pestañas de contenedores -->
                    <div class="tab-pane fade" role="tabpanel" data-step="2">
                        <div class="step-content">
                            <div class="card mb-3">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <h5 class="mb-0">🧰 Contenedores (Bolsas / Sobres)</h5>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-primary" id="btnAddBolsa">+ Agregar Bolsa</button>
                                        <button type="button" class="btn btn-outline-secondary" id="btnAddSobre">+ Agregar Sobre</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <ul class="nav nav-tabs" id="containersTabs" role="tablist">
                                        @for (var i = 0; i < Model.Containers.Count; i++)
                                        {
                                            var tabId = $"c-tab-{i}";
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link @(i==0?"active":"")" id="@($"{tabId}-btn")"
                                                        data-bs-toggle="tab" data-bs-target="@($"#{tabId}")" type="button" role="tab">
                                                    @(Model.Containers[i].ContainerType) @(" ") @(i+1)
                                                </button>
                                            </li>
                                        }
                                    </ul>

                                    <div class="tab-content mt-3" id="containersTabContent">
                                        @for (var i = 0; i < Model.Containers.Count; i++)
                                        {
                                            var tabId = $"c-tab-{i}";
                                            <div class="tab-pane fade @(i==0?"show active":"")" id="@tabId" role="tabpanel">
                                                @{
                                                    var vdd = new ViewDataDictionary(ViewData);
                                                    vdd.TemplateInfo.HtmlFieldPrefix = $"Containers[{i}]";
                                                }
                                                @Html.Partial("_ContainerEditorPartial", Model.Containers[i], vdd)
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="card mt-4">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <h5 class="mb-0">🧾 Novedades (Opcional)</h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="toggleIncidents">
                                        <label class="form-check-label" for="toggleIncidents">Reportar novedades</label>
                                    </div>
                                </div>

                                <div class="card-body" id="incidentsPanel" style="display:none;">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating has-validation">
                                                <select id="incidentContainerSelector" class="form-select">
                                                    <option value="">Seleccionar bolsa/sobre...</option>
                                                    @for (var i = 0; i < Model.Containers.Count; i++)
                                                    {
                                                        var label = $"#{i + 1} - {Model.Containers[i].ContainerType} - {Model.Containers[i].ContainerCode}";
                                                        <option value="@i">@label</option>
                                                    }
                                                </select>
                                                <label for="incidentContainerSelector">Aplicar a</label>
                                                <div class="invalid-feedback">⚠ Seleccione un contenedor</div>
                                                <div class="valid-feedback">✓ Correcto</div>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-6 d-flex align-items-end">
                                            <button type="button" id="btnAddIncident" class="btn btn-outline-primary">
                                                + Agregar novedad
                                            </button>
                                        </div>
                                    </div>

                                    @for (var i = 0; i < Model.Containers.Count; i++)
                                    {
                                        <div id="inc-list-c@i" class="mt-3"></div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 3: Resumen -->
                    <div class="tab-pane fade" role="tabpanel" data-step="3">
                        <div class="step-content">
                            <div class="card">
                                <div class="card-header"><h5>📊 Resumen</h5></div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" id="sumDeclaredAll" value="@Model.TotalDeclaredAll.ToString("N0")" readonly />
                                                <label>Total Declarado</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" id="sumCountedAll" value="@Model.TotalCountedAll.ToString("N0")" readonly />
                                                <label>Total Contado</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input class="form-control" id="sumDiffAll" value="@Model.DifferenceAll.ToString("N0")" readonly />
                                                <label>Diferencia</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-info mt-3">
                                        Este resumen se recalcula al guardar los contenedores (veremos el multipost luego).
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Botonera -->
                <div class="submit-container form-group col-12 mt-4">
                    <button type="button" class="btn btn-secondary" data-step-action="prev" style="display:none;">Anterior</button>
                    <button type="button" class="btn btn-primary" data-step-action="next">Continuar</button>
                    <button type="submit" class="btn btn-primary" data-step-action="submit-final" style="display:none;">Guardar</button>
                    <a asp-action="Index" class="btn btn-danger">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="container-template" class="d-none">
    @{
        var vddT = new ViewDataDictionary(ViewData);
        vddT.TemplateInfo.HtmlFieldPrefix = "Containers[__idx__]";
    }
    @Html.Partial(
    "_ContainerEditorPartial",
        new VCashApp.Models.ViewModels.CentroEfectivo.CefContainerProcessingViewModel(),
        vddT
        )
</div>

<div id="incident-template" class="d-none">
    <div class="incident-row card mt-3" data-cidx="__cidx__" data-iidx="__iidx__">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-lg-4">
                    <div class="form-floating has-validation">
                        <select name="Containers[__cidx__].Incidents[__iidx__].IncidentType" class="form-select">
                            <option value="">Seleccionar tipo...</option>
                            @foreach (var it in (IEnumerable<SelectListItem>)ViewBag.IncidentTypes ?? new List<SelectListItem>())
                                                        {
                                <option value="@it.Value">@it.Text</option>
                            }
                        </select>
                        <label>Tipo de Novedad</label>
                        <div class="invalid-feedback">⚠ Requerido</div>
                        <div class="valid-feedback">✓ Correcto</div>
                    </div>
                </div>

                <div class="col-12 col-lg-3">
                    <div class="form-floating has-validation">
                        <input type="number" step="0.01"
                               name="Containers[__cidx__].Incidents[__iidx__].AffectedAmount"
                               class="form-control" placeholder="Monto afectado" />
                        <label>Monto afectado</label>
                        <div class="invalid-feedback">⚠ Requerido</div>
                        <div class="valid-feedback">✓ Correcto</div>
                    </div>
                </div>

                <div class="col-12 col-lg-3">
                    <div class="form-floating">
                        <input type="number" step="0.01"
                               name="Containers[__cidx__].Incidents[__iidx__].AffectedDenomination"
                               class="form-control" placeholder="Denominación afectada" />
                        <label>Denominación afectada</label>
                    </div>
                </div>

                <div class="col-12 col-lg-2">
                    <div class="form-floating">
                        <input type="number"
                               name="Containers[__cidx__].Incidents[__iidx__].AffectedQuantity"
                               class="form-control" placeholder="Cantidad" />
                        <label>Cantidad</label>
                    </div>
                </div>

                <div class="col-12">
                    <div class="form-floating has-validation">
                        <textarea name="Containers[__cidx__].Incidents[__iidx__].Description"
                                  class="form-control" placeholder="Descripción"
                                  style="height: 80px;"></textarea>
                        <label>Descripción</label>
                        <div class="invalid-feedback">⚠ Requerido</div>
                        <div class="valid-feedback">✓ Correcto</div>
                    </div>
                </div>

                <div class="col-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-danger btn-sm js-remove-incident">
                        Eliminar novedad
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }

    <script>
        $(function () {
            let currentStep = 1;
            const totalSteps = 3;
            const $form = $('#cefContainersForm');
            const $next = $('button[data-step-action="next"]');
            const $prev = $('button[data-step-action="prev"]');
            const $submit = $('button[data-step-action="submit-final"]');
            const $panelInc = $('#incidentsPanel');
            const $toggleInc = $('#toggleIncidents');
            const $selCont = $('#incidentContainerSelector');

            // límites
            const MAX_BOLSAS = 7, MAX_SOBRES = 10;

            function countByType(typeText) {
                // Cuenta pestañas por texto actual (Bolsa/Sobre)
                return $('#containersTabs .nav-link').filter(function(){ return $(this).text().trim().startsWith(typeText); }).length;
            }

            function updateStepper() {
                $('.progress-stepper .step').removeClass('active completed');
                for (let i = 1; i <= totalSteps; i++) {
                    const $step = $('.step[data-step="' + i + '"]');
                    if (i < currentStep) { $step.addClass('completed'); $step.find('.step-number').html('&#10003;'); }
                    else if (i === currentStep) { $step.addClass('active'); $step.find('.step-number').text(i); }
                    else { $step.find('.step-number').text(i); }
                }
                showCurrentStep();
            }
            function showCurrentStep() {
                $('.tab-pane[data-step]').removeClass('show active');
                $('#myTabContent div[data-step="' + currentStep + '"]').addClass('show active');
                $prev.toggle(currentStep > 1);
                $next.toggle(currentStep < totalSteps);
                $submit.toggle(currentStep === totalSteps);
            }

            function validateField($f) {
                if ($f.prop('disabled')) { $f.removeClass('is-invalid is-valid'); return true; }
                const ok = $f[0].checkValidity();
                $f.toggleClass('is-valid', ok).toggleClass('is-invalid', !ok);
                const $c = $f.closest('.has-validation');
                $c.find('.invalid-feedback')[ok?'hide':'show']();
                $c.find('.valid-feedback')[ok?'show':'hide']();
                return ok;
            }
            function validateCurrentStep() {
                let ok = true;
                $('#myTabContent .tab-pane[data-step].active :input[required]').each(function(){
                    if (!$(this).is(':disabled')) ok = validateField($(this)) && ok;
                });
                return ok;
            }

            // Navegación stepper
            $('.progress-stepper .step').on('click', function () {
                const target = parseInt($(this).data('step'));
                if (target < currentStep || validateCurrentStep()) { currentStep = target; updateStepper(); }
            });
            $next.on('click', function () {
              const okBasics = validateCurrentStep();
              const okInc = (currentStep !== 2) ? true : validateIncidentsPanel();
              if (okBasics && okInc && currentStep < totalSteps) { currentStep++; updateStepper(); }
              else if (!okInc) {
                Swal.fire('Campos incompletos', 'Revisa las novedades del paso 2 o desactívalas.', 'warning');
              }
            });
            $prev.on('click', function () { if (currentStep > 1) { currentStep--; updateStepper(); } });

            // Agregar contenedor (tab)
            function addContainer(typeText) {
                const max = typeText === 'Bolsa' ? MAX_BOLSAS : MAX_SOBRES;
                if (countByType(typeText) >= max) {
                    Swal.fire('Límite alcanzado', `Máximo ${max} ${typeText === 'Bolsa' ? 'bolsas' : 'sobres'} por transacción.`, 'info');
                    return;
                }

                const $tablist = $('#containersTabs');
                const $tabcontent = $('#containersTabContent');
                const nextIndex = $tabcontent.children('.tab-pane').length;
                const newId = 'c-tab-' + nextIndex;

                // Botón tab
                const $btn = $(`
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="${newId}-btn" data-bs-toggle="tab" data-bs-target="#${newId}" type="button" role="tab">
                        ${typeText} ${nextIndex + 1}
                      </button>
                    </li>`);
                $tablist.append($btn);

                // Contenido tab desde template
                const html = $('#container-template').html().replaceAll('__idx__', nextIndex);
                const $pane = $(`<div class="tab-pane fade" id="${newId}" role="tabpanel">${html}</div>`);
                $tabcontent.append($pane);

                // Seleccionar tipo correcto en el select enum
                const $selectType = $pane.find(`select[name="Containers[${nextIndex}].ContainerType"]`);
                $selectType.val(typeText); // si enum names coinciden (Bolsa/Sobre)

                // Activar pestaña recién creada
                $tablist.find('button.nav-link').removeClass('active');
                $tabcontent.find('.tab-pane').removeClass('show active');
                $btn.addClass('active');
                $pane.addClass('show active');
                addContainerOption(nextIndex, `${typeText} ${nextIndex + 1}`);
            }

            $('#btnAddBolsa').on('click', () => addContainer('Bolsa'));
            $('#btnAddSobre').on('click', () => addContainer('Sobre'));

            // oculto+disabled por defecto
            function setIncidentsEnabled(on) {
              $panelInc.toggle(on);
              $panelInc.find(':input').prop('disabled', !on);
            }
            setIncidentsEnabled(false);

            $toggleInc.on('change', function(){
              setIncidentsEnabled(this.checked);
            });

            // permite registrar una opción nueva cuando se agrega una bolsa/sobre por JS
            window.addContainerOption = function (idx, label) {
              if ($selCont.find('option[value="' + idx + '"]').length === 0) {
                $selCont.append(new Option(label || ('#' + (idx+1)), idx));
              }
              if ($('#inc-list-c' + idx).length === 0) {
                $('<div/>', { id: 'inc-list-c' + idx, class: 'mt-3' }).appendTo($panelInc);
              }
            };

            // Agregar novedad al contenedor seleccionado
            $('#btnAddIncident').on('click', function () {
              const cidx = $selCont.val();
              if (!cidx) {
                const $wrap = $selCont.closest('.has-validation');
                $wrap.find('.invalid-feedback').show();
                $selCont.addClass('is-invalid');
                return;
              }
              $selCont.removeClass('is-invalid');

              const $host = $('#inc-list-c' + cidx);
              const next = $host.children('.incident-row').length;

              let html = $('#incident-template').html();
              html = html.replaceAll('__cidx__', cidx).replaceAll('__iidx__', next);
              $host.append($(html));
            });

            // Eliminar novedad
            $(document).on('click', '.js-remove-incident', function () {
              $(this).closest('.incident-row').remove();
            });

            // Valida SOLO si toggle ON
            function validateIncidentsPanel() {
              if (!$toggleInc.is(':checked')) return true;

              let ok = true;
              $('#incidentsPanel .incident-row').each(function () {
                const $row = $(this);
                const $type = $row.find('select[name$=".IncidentType"]');
                const $amt  = $row.find('input[name$=".AffectedAmount"]');
                const $desc = $row.find('textarea[name$=".Description"]');

                const typeValid = !!(($type.val() || '').toString().trim());
                const amtVal = parseFloat(($amt.val() || '0'));
                const amtValid = !isNaN(amtVal) && amtVal > 0;
                const descValid = !!(($desc.val() || '').toString().trim());

                $type.toggleClass('is-invalid', !typeValid).toggleClass('is-valid', typeValid);
                $amt.toggleClass('is-invalid', !amtValid).toggleClass('is-valid', amtValid);
                $desc.toggleClass('is-invalid', !descValid).toggleClass('is-valid', descValid);

                if (!typeValid || !amtValid || !descValid) ok = false;
              });
              return ok;
            }

            // Tabla detalles (dinámica)
            $(document).on('click', '.js-add-detail', function () {
                const $pane = $(this).closest('[id^="c-tab-"]');
                const paneId = $pane.attr('id');
                const i = parseInt(paneId.split('-').pop());

                const $tbody = $pane.find('.js-details-table tbody');
                const j = $tbody.find('tr').length;

                const row = `
                  <tr>
                    <td>
                      <select name="Containers[${i}].ValueDetails[${j}].ValueType" class="form-select form-select-sm">
                        <option value="Billete">Billete</option>
                        <option value="Moneda">Moneda</option>
                        <option value="Cheque">Cheque</option>
                        <option value="Documento">Documento</option>
                      </select>
                    </td>
                    <td><input name="Containers[${i}].ValueDetails[${j}].Denomination" type="number" step="1" class="form-control form-control-sm js-calc" /></td>
                    <td><input name="Containers[${i}].ValueDetails[${j}].Quantity" type="number" class="form-control form-control-sm js-calc" /></td>
                    <td><input name="Containers[${i}].ValueDetails[${j}].BundlesCount" type="number" class="form-control form-control-sm js-calc" /></td>
                    <td><input name="Containers[${i}].ValueDetails[${j}].LoosePiecesCount" type="number" class="form-control form-control-sm js-calc" /></td>
                    <td><input name="Containers[${i}].ValueDetails[${j}].UnitValue" type="number" step="1" class="form-control form-control-sm js-calc" /></td>
                    <td><input name="Containers[${i}].ValueDetails[${j}].CalculatedAmount" type="number" step="1" class="form-control form-control-sm" readonly /></td>
                    <td><button type="button" class="btn btn-sm btn-outline-danger js-remove-detail">×</button></td>
                  </tr>`;
                $tbody.append(row);
            });
            $(document).on('click', '.js-remove-detail', function () { $(this).closest('tr').remove(); });

            $(document).on('input', '.js-calc', function () {
                const $row = $(this).closest('tr');
                const denom = parseFloat($row.find('input[name$=".Denomination"]').val()) || 0;
                const qty   = parseFloat($row.find('input[name$=".Quantity"]').val()) || 0;
                const unit  = parseFloat($row.find('input[name$=".UnitValue"]').val()) || 0;
                const amt = (denom > 0 && unit > 0) ? (qty * unit) : (denom * qty);
                $row.find('input[name$=".CalculatedAmount"]').val(amt.toFixed(0));
            });

            // Incidencias (dinámica)
            $(document).on('click', '.js-add-incident', function () {
                const $pane = $(this).closest('[id^="c-tab-"]');
                const i = parseInt($pane.attr('id').split('-').pop());
                const $tbody = $pane.find('.js-incidents-table tbody');
                const j = $tbody.find('tr').length;

                const row = `
                  <tr>
                    <td>
                      <select name="Containers[${i}].Incidents[${j}].IncidentType" class="form-select form-select-sm">
                        <option value="Faltante">Faltante</option>
                        <option value="Sobrante">Sobrante</option>
                        <option value="Falso">Falso</option>
                        <option value="Deteriorado">Deteriorado</option>
                      </select>
                    </td>
                    <td><input name="Containers[${i}].Incidents[${j}].AffectedAmount" type="number" step="1" class="form-control form-control-sm" /></td>
                    <td><input name="Containers[${i}].Incidents[${j}].AffectedDenomination" type="number" step="1" class="form-control form-control-sm" /></td>
                    <td><input name="Containers[${i}].Incidents[${j}].AffectedQuantity" type="number" class="form-control form-control-sm" /></td>
                    <td><input name="Containers[${i}].Incidents[${j}].Description" class="form-control form-control-sm" /></td>
                    <td><button type="button" class="btn btn-sm btn-outline-danger js-remove-incident">×</button></td>
                  </tr>`;
                $tbody.append(row);
            });
            $(document).on('click', '.js-remove-incident', function () { $(this).closest('tr').remove(); });

            $('button[data-step-action="submit-final"]').on('click', function (e) {
              if (!(validateCurrentStep() && validateIncidentsPanel())) {
                e.preventDefault();
                Swal.fire({ title: 'Campos incompletos', text: 'Revise los campos requeridos y las novedades (si están activas).', icon: 'warning', confirmButtonColor: '#3085d6' });
              }
            });

            updateStepper();
        });
    </script>
}