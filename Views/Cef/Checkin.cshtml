@model VCashApp.Models.ViewModels.CentroEfectivo.CefTransactionCheckinViewModel
@{
    ViewData["Title"] = "Tesorer√≠a";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="form-container">
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Orden: @Model.ServiceOrderId<span id="displaySlipNumber"></span>)</h4>
        </div>

        <div class="card-body">
            <form id="cefCheckinForm" asp-action="Checkin" asp-controller="Cef" method="post" novalidate>
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="progress-stepper" id="progressStepper">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Resumen del Servicio</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Declarados (Cantidades / Valores)</div>
                    </div>
                </div>

                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="resumen-servicio" role="tabpanel" data-step="1">
                        <div class="step-content">

                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>üìã Datos del Servicio</h5>
                                </div>
                                <div class="card-body">
                                    <input type="hidden" asp-for="ServiceOrderId" />
                                    <input type="hidden" asp-for="RouteId" />

                                    <div class="row g-3">
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="ServiceOrderId" class="form-control" readonly />
                                                <label asp-for="ServiceOrderId">Orden de Servicio</label>
                                            </div>
                                            <span asp-validation-for="ServiceOrderId" class="text-danger"></span>
                                        </div>

                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="ClientName" class="form-control" readonly />
                                                <label asp-for="ClientName">Cliente</label>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="BranchName" class="form-control" readonly />
                                                <label asp-for="BranchName">Sucursal</label>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating">
                                                <input asp-for="HeadOfShiftName" class="form-control" readonly />
                                                <label asp-for="HeadOfShiftName">Jefe de Turno</label>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating">
                                                <input asp-for="OriginLocationName" class="form-control" readonly />
                                                <label asp-for="OriginLocationName">Origen</label>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-6">
                                            <div class="form-floating">
                                                <input asp-for="DestinationLocationName" class="form-control" readonly />
                                                <label asp-for="DestinationLocationName">Destino</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>‚öôÔ∏è Informaci√≥n General del Check-in</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating has-validation">
                                                <input asp-for="SlipNumber" class="form-control" placeholder="N√∫mero de planilla" type="number" min="1" required />
                                                <label for="SlipNumber" class="required">N√∫mero de planilla</label>
                                                <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                                <div class="valid-feedback">‚úì Correcto</div>
                                            </div>
                                            <span asp-validation-for="SlipNumber" class="text-danger"></span>
                                        </div>

                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating has-validation">
                                                <select asp-for="Currency" asp-items="Model.Currencies" class="form-select" required aria-required="true">
                                                    <option value="">Seleccionar divisa...</option>
                                                </select>
                                                <label asp-for="Currency" class="required">Divisa</label>
                                                <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                            </div>
                                            <span asp-validation-for="Currency" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div class="form-floating">
                                                <input asp-for="TransactionType" class="form-control" readonly />
                                                <label asp-for="TransactionType">Tipo de Transacci√≥n</label>
                                            </div>
                                            <span asp-validation-for="TransactionType" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="declarados" role="tabpanel" data-step="2">
                        <div class="step-content">

                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>üì¶ Cantidades Declaradas</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating has-validation">
                                                <input asp-for="DeclaredBagCount" type="number" min="0" class="form-control" required />
                                                <label asp-for="DeclaredBagCount" class="required">Bolsas</label>
                                                <div class="invalid-feedback">‚ö† Requerido</div>
                                            </div>
                                            <span asp-validation-for="DeclaredBagCount" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-3" style="display: none;">
                                            <div class="form-floating has-validation">
                                                <input asp-for="DeclaredEnvelopeCount" type="number" min="0" class="form-control" required />
                                                <label asp-for="DeclaredEnvelopeCount" class="required">Sobres</label>
                                                <div class="invalid-feedback">‚ö† Requerido</div>
                                            </div>
                                            <span asp-validation-for="DeclaredEnvelopeCount" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-3" style="display: none;">
                                            <div class="form-floating has-validation">
                                                <input asp-for="DeclaredCheckCount" type="number" min="0" class="form-control" required />
                                                <label asp-for="DeclaredCheckCount" class="required">Cheques</label>
                                                <div class="invalid-feedback">‚ö† Requerido</div>
                                            </div>
                                            <span asp-validation-for="DeclaredCheckCount" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-3" style="display: none;">
                                            <div class="form-floating has-validation">
                                                <input asp-for="DeclaredDocumentCount" type="number" min="0" class="form-control" required />
                                                <label asp-for="DeclaredDocumentCount" class="required">Docs</label>
                                                <div class="invalid-feedback">‚ö† Requerido</div>
                                            </div>
                                            <span asp-validation-for="DeclaredDocumentCount" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-3">
                                            <div class="form-floating has-validation">
                                                <input asp-for="TotalDeclaredValue" type="number" min="1" class="form-control js-calc-total" required/>
                                                <label asp-for="TotalDeclaredValue" class="required">Total Declarado</label>
                                                <div class="invalid-feedback">‚ö† Requerido</div>
                                            </div>
                                            <span asp-validation-for="TotalDeclaredValue" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>üí∞ Valores Declarados</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-4" style="display: none;">
                                            <div class="form-floating">
                                                <input asp-for="DeclaredBillValue" type="number" step="1" class="form-control js-calc-total" />
                                                <label asp-for="DeclaredBillValue">Billetes</label>
                                            </div>
                                            <span asp-validation-for="DeclaredBillValue" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4" style="display: none;">
                                            <div class="form-floating">
                                                <input asp-for="DeclaredCoinValue" type="number" step="1" class="form-control js-calc-total" />
                                                <label asp-for="DeclaredCoinValue">Monedas</label>
                                            </div>
                                            <span asp-validation-for="DeclaredCoinValue" class="text-danger"></span>
                                        </div>
                                        <div class="col-12 col-lg-4" style="display: none;">
                                            <div class="form-floating">
                                                <input asp-for="DeclaredDocumentValue" type="number" step="1" class="form-control js-calc-total" />
                                                <label asp-for="DeclaredDocumentValue">Documentos</label>
                                            </div>
                                            <span asp-validation-for="DeclaredDocumentValue" class="text-danger"></span>
                                        </div>

                                        <div class="col-12">
                                            <div class="calculation-panel mt-3">
                                                <h6>üí∞ Resumen</h6>
                                                <div class="calculation-total">
                                                    <span>Total Declarado:</span>
                                                    <span class="total-value" id="sumTotal">$0</span>
                                                </div>
                                            </div>
                                            <div class="form-text">
                                                <small id="declaredWordsText"></small>
                                            </div>
                                        </div>

                                        <div class="col-12 col-lg-6">
                                            <div class="form-check form-switch">
                                                <input asp-for="IsCustody" class="form-check-input" type="checkbox" id="isCustodySwitch" />
                                                <label class="form-check-label" for="isCustodySwitch">Servicio de Custodia</label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-6">
                                            <div class="form-check form-switch">
                                                <input asp-for="IsPointToPoint" class="form-check-input" type="checkbox" id="isPointToPointSwitch" />
                                                <label class="form-check-label" for="isPointToPointSwitch">Punto a Punto</label>
                                            </div>
                                        </div>

                                        <div class="col-12">
                                            <div class="form-floating">
                                                <textarea asp-for="InformativeIncident" class="form-control" placeholder="Novedad Informativa" style="height: 100px;"></textarea>
                                                <label asp-for="InformativeIncident">Novedad Informativa</label>
                                            </div>
                                            <span asp-validation-for="InformativeIncident" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>‚öôÔ∏è Datos del Operador</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12 col-lg-4">
                                    <div class="form-floating">
                                        <input asp-for="RegistrationDate" type="datetime-local" class="form-control" readonly />
                                        <label asp-for="RegistrationDate">Fecha de Registro</label>
                                    </div>
                                </div>
                                <div class="col-12 col-lg-4">
                                    <div class="form-floating">
                                        <input asp-for="RegistrationUserName" class="form-control" readonly />
                                        <label asp-for="RegistrationUserName">Usuario</label>
                                    </div>
                                </div>
                                <div class="col-12 col-lg-4">
                                    <div class="form-floating">
                                        <input asp-for="IPAddress" class="form-control" readonly />
                                        <label asp-for="IPAddress">IP</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="submit-container form-group col-12 mt-4">
                    <button type="button" class="btn btn-secondary" data-step-action="prev" style="display:none;">Anterior</button>
                    <button type="button" class="btn btn-primary" data-step-action="next">Continuar</button>
                    <button type="submit" class="btn btn-primary" data-step-action="submit-final" style="display:none;">Guardar</button>
                    <a asp-action="Index" class="btn btn-danger">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(function () {
            let currentStep = 1;
            const totalSteps = 2;
            const $form   = $('#cefCheckinForm');
            const $next   = $('button[data-step-action="next"]');
            const $prev   = $('button[data-step-action="prev"]');
            const $submit = $('button[data-step-action="submit-final"]');

            // Fallback: asegurar restricciones en SlipNumber (por si no est√°n en el Razor)
            $('#SlipNumber').attr({ type: 'number', min: 1, required: true });

            function updateStepper() {
                $('.progress-stepper .step').removeClass('active completed');
                for (let i = 1; i <= totalSteps; i++) {
                    const $step = $('.step[data-step="' + i + '"]');
                    if (i < currentStep) { $step.addClass('completed'); $step.find('.step-number').html('&#10003;'); }
                    else if (i === currentStep) { $step.addClass('active'); $step.find('.step-number').text(i); }
                    else { $step.find('.step-number').text(i); }
                }
                showCurrentStep();
            }

            function showCurrentStep() {
                $('.tab-pane').removeClass('show active');
                $('#myTabContent div[data-step="' + currentStep + '"]').addClass('show active');

                $prev.toggle(currentStep > 1);
                $next.toggle(currentStep < totalSteps);
                $submit.toggle(currentStep === totalSteps);
            }

            function validateField($f) {
                if ($f.prop('disabled') || $f.prop('readonly')) {
                    $f.removeClass('is-invalid is-valid');
                    return true;
                }
                const ok = $f[0].checkValidity();

                $f.toggleClass('is-valid', ok)
                  .toggleClass('is-invalid', !ok);

                const $container = $f.closest('.has-validation');
                const $invalid = $container.find('.invalid-feedback');
                const $valid   = $container.find('.valid-feedback');

                if (ok) {
                    $invalid.hide();
                    $valid.show();
                } else {
                    $invalid.text($f[0].validationMessage || '‚ö† Campo inv√°lido').show();
                    $valid.hide();
                }
                return ok;
            }

            function scrollToFirstError() {
                const $err = $('#myTabContent .is-invalid:visible, #myTabContent .field-validation-error:visible').first();
                if ($err.length) {
                    const top = $err.offset().top - 120;
                    $('html,body').animate({ scrollTop: top }, 250);
                }
            }

            function validateStep() {
                let ok = true;
                const $pane = $('#myTabContent .tab-pane.active');
                $pane.find(':input:enabled:visible').each(function () {
                    if (!validateField($(this))) ok = false;
                });
                if (!ok) scrollToFirstError();
                return ok;
            }

            $('.progress-stepper .step').on('click', function () {
                const target = parseInt($(this).data('step'));
                if (target < currentStep || validateStep()) { currentStep = target; updateStepper(); }
            });
            $next.on('click', function () { if (validateStep() && currentStep < totalSteps) { currentStep++; updateStepper(); } });
            $prev.on('click', function () { if (currentStep > 1) { currentStep--; updateStepper(); } });

            // Validaci√≥n en vivo
            $form.on('blur change input', ':input', function () {
                const $f = $(this);
                if ($f.is(':visible:enabled')) validateField($f);
            });

            async function updateDeclaredWords(total) {
                try {
                    const currency = $('#Currency').val() || 'COP';
                    const res = await $.get('@Url.Action("AmountInWords", "Cef")', { value: total, currency, includeCents: false });
                    $('#declaredWordsText').text(res.words || '');
                } catch { $('#declaredWordsText').text(''); }
            }

            function updateSlipNumberDisplay() {
                const slipNumber = $('#SlipNumber').val();
                const displayText = slipNumber ? ` | Planilla: ${slipNumber}` : '';
                $('#displaySlipNumber').text(displayText);
            }
            $('#SlipNumber').on('input', updateSlipNumberDisplay);
            updateSlipNumberDisplay();

            function format(n){ return '$' + (n||0).toLocaleString('es-CO'); }
            function recalc() {
                const totalValue = parseFloat($('#TotalDeclaredValue').val()) || 0;
                $('#sumTotal').text(format(totalValue));
                $('#TotalDeclaredValue').val(totalValue.toFixed(0));
                updateDeclaredWords(totalValue);
            }
            $('.js-calc-total').on('input', recalc);
            recalc();

            /*function format(n){ return '$' + (n||0).toLocaleString('es-CO'); }
            function recalc() {
                const bills = parseFloat($('#DeclaredBillValue').val()) || 0;
                const coins = parseFloat($('#DeclaredCoinValue').val()) || 0;
                const docs  = parseFloat($('#DeclaredDocumentValue').val()) || 0;
                const total = bills + coins + docs;
                $('#sumBills').text(format(bills));
                $('#sumCoins').text(format(coins));
                $('#sumDocs').text(format(docs));
                $('#sumTotal').text(format(total));
                $('#TotalDeclaredValue').val(total.toFixed(0));
                updateDeclaredWords(total);
            }
            $('.js-calc-total').on('input', recalc);
            recalc();*/

            // ===== Env√≠o con SweetAlert + AJAX =====
            $('button[data-step-action="submit-final"]').on('click', function (e) {
                e.preventDefault();

                const isValidStep = (typeof validateCurrentStep === 'function')
                    ? validateCurrentStep()
                    : (typeof validateStep === 'function' ? validateStep() : true);

                if (!isValidStep) {
                    Swal.fire({
                        title: 'Campos incompletos',
                        text: 'Por favor, complete los campos requeridos antes de continuar.',
                        icon: 'warning',
                        confirmButtonColor: '#3085d6'
                    });
                    return;
                }

                Swal.fire({
                    title: '¬øEst√° seguro?',
                    text: '¬øDesea registrar el check-in de esta transacci√≥n?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'S√≠, registrar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (!result.isConfirmed) return;

                    Swal.fire({
                        title: 'Registrando check-in...',
                        text: 'Por favor, espere.',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    const $btnSubmit = $('button[data-step-action="submit-final"]');
                    $btnSubmit.prop('disabled', true);

                    const url = $form.attr('action');
                    const formData = $form.serialize();
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: formData,
                        headers: {
                            'RequestVerificationToken': token,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        success: function (response) {
                            Swal.close();
                            $btnSubmit.prop('disabled', false);

                            if (typeof response !== 'object') {
                                Swal.fire('Error', 'Respuesta inesperada del servidor.', 'error');
                                return;
                            }

                            if (response.success) {
                                Swal.fire({
                                    title: '¬°√âxito!',
                                    text: response.message,
                                    icon: 'success'
                                }).then(() => {
                                    window.location.href = response.data.url;
                                });
                            }
                             else {
                                let errorText = response.message || 'Por favor, corrija los errores en el formulario.';
                                if (response.errors) {
                                    // Limpia estados previos
                                    $('.field-validation-error').text('');
                                    $('input, select, textarea').removeClass('is-invalid is-valid');
                                    $('.invalid-feedback, .valid-feedback').hide();

                                    $.each(response.errors, function (key, value) {
                                        const $field = $('[name="' + key + '"]');
                                        if ($field.length) {
                                            $field.addClass('is-invalid');

                                            // span MVC
                                            let $span = $field.siblings('[data-valmsg-for="' + key + '"]');
                                            if ($span.length === 0) {
                                                $span = $('<span>').addClass('text-danger field-validation-error')
                                                    .attr('data-valmsg-for', key);
                                                $field.after($span);
                                            }
                                            $span.text(value.join(', ')).show();

                                            // feedback Bootstrap dentro de .has-validation
                                            const $container = $field.closest('.has-validation');
                                            const $invalid = $container.find('.invalid-feedback');
                                            if ($invalid.length) {
                                                $invalid.text(value.join(', ')).show();
                                            }
                                        }
                                    });

                                    errorText = 'Se encontraron errores. Por favor, revise los campos marcados.';
                                    scrollToFirstError();
                                }

                                Swal.fire('Error', errorText, 'error');
                            }
                        },
                        error: function (xhr, status, error) {
                            Swal.close();
                            $btnSubmit.prop('disabled', false);
                            console.error('Error al enviar formulario:', xhr.responseText);
                            Swal.fire(
                                'Error',
                                `Ocurri√≥ un error al intentar registrar el check-in: ${xhr.statusText || error}.`,
                                'error'
                            );
                        }
                    });
                });
            });
            updateStepper();
        });
    </script>
}