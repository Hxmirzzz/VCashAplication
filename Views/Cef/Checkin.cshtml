@model VCashApp.Models.ViewModels.CentroEfectivo.CefTransactionCheckinViewModel
@{
    ViewData["Title"] = "Tesoreria";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="form-container">
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Nuevo</h4>
        </div>
        <div class="card-body">
            <form id="checkinForm" asp-action="Checkin" asp-controller="Cef" method="post" novalidate>
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>üìã Datos Generales de la Transacci√≥n</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12 col-lg-6">
                                <div class="form-floating has-validation">
                                    <input asp-for="ServiceOrderId" class="form-control" placeholder="Orden de Servicio" required aria-required="true" />
                                    <label for="ServiceOrderId" class="required">Orden de Servicio</label>
                                    <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                    <div class="valid-feedback">‚úì Correcto</div>
                                </div>
                                <span asp-validation-for="ServiceOrderId" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="form-floating">
                                    <input asp-for="RouteId" class="form-control" placeholder="ID de Ruta Diaria" />
                                    <label for="RouteId">ID de Ruta Diaria</label>
                                </div>
                                <span asp-validation-for="RouteId" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="form-floating has-validation">
                                    <select asp-for="Currency" asp-items="Model.Currencies" class="form-select" required aria-required="true">
                                        <option value="">-- Seleccionar --</option>
                                    </select>
                                    <label for="Currency" class="required">Divisa</label>
                                    <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                    <div class="valid-feedback">‚úì Correcto</div>
                                </div>
                                <span asp-validation-for="Currency" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="form-floating has-validation">
                                    <select asp-for="TransactionType" asp-items="Html.GetEnumSelectList<VCashApp.Enums.CefTransactionTypeEnum>()" class="form-select" required aria-required="true">
                                        <option value="">-- Seleccionar --</option>
                                    </select>
                                    <label for="TransactionType" class="required">Tipo de Transacci√≥n</label>
                                    <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                    <div class="valid-feedback">‚úì Correcto</div>
                                </div>
                                <span asp-validation-for="TransactionType" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="form-floating">
                                    <input asp-for="ClientName" class="form-control" placeholder="Cliente" readonly />
                                    <label for="ClientName">Cliente</label>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="form-floating">
                                    <input asp-for="BranchName" class="form-control" placeholder="Sucursal" readonly />
                                    <label for="BranchName">Sucursal</label>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="form-floating">
                                    <input asp-for="OriginLocationName" class="form-control" placeholder="Origen" readonly />
                                    <label for="OriginLocationName">Origen</label>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="form-floating">
                                    <input asp-for="DestinationLocationName" class="form-control" placeholder="Destino" readonly />
                                    <label for="DestinationLocationName">Destino</label>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="form-check form-switch">
                                    <input asp-for="IsCustody" class="form-check-input" type="checkbox" id="isCustodySwitch" />
                                    <label class="form-check-label" for="isCustodySwitch">¬øEs Custodia?</label>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="form-check form-switch">
                                    <input asp-for="IsPointToPoint" class="form-check-input" type="checkbox" id="isPointToPointSwitch" />
                                    <label class="form-check-label" for="isPointToPointSwitch">¬øEs Punto a Punto?</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>üí∞ Cantidades y Valores Declarados</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12 col-lg-3">
                                <div class="form-floating has-validation">
                                    <input asp-for="DeclaredBagCount" type="number" class="form-control" placeholder="Cantidad de Bolsas Declaradas" required aria-required="true" />
                                    <label for="DeclaredBagCount" class="required">Cantidad de Bolsas Declaradas</label>
                                    <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                    <div class="valid-feedback">‚úì Correcto</div>
                                </div>
                                <span asp-validation-for="DeclaredBagCount" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-3">
                                <div class="form-floating has-validation">
                                    <input asp-for="DeclaredEnvelopeCount" type="number" class="form-control" placeholder="Cantidad de Sobres Declarados" required aria-required="true" />
                                    <label for="DeclaredEnvelopeCount" class="required">Cantidad de Sobres Declarados</label>
                                    <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                    <div class="valid-feedback">‚úì Correcto</div>
                                </div>
                                <span asp-validation-for="DeclaredEnvelopeCount" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-3">
                                <div class="form-floating has-validation">
                                    <input asp-for="DeclaredCheckCount" type="number" class="form-control" placeholder="Cantidad de Cheques Declarados" required aria-required="true" />
                                    <label for="DeclaredCheckCount" class="required">Cantidad de Cheques Declarados</label>
                                    <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                    <div class="valid-feedback">‚úì Correcto</div>
                                </div>
                                <span asp-validation-for="DeclaredCheckCount" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-3">
                                <div class="form-floating has-validation">
                                    <input asp-for="DeclaredDocumentCount" type="number" class="form-control" placeholder="Cantidad de Documentos Declarados" required aria-required="true" />
                                    <label for="DeclaredDocumentCount" class="required">Cantidad de Documentos Declarados</label>
                                    <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                    <div class="valid-feedback">‚úì Correcto</div>
                                </div>
                                <span asp-validation-for="DeclaredDocumentCount" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="form-floating has-validation">
                                    <input asp-for="DeclaredBillValue" type="number" step="1" class="form-control calculate-total-declared" placeholder="Valor en Billetes Declarado" required aria-required="true" />
                                    <label for="DeclaredBillValue" class="required">Valor en Billetes Declarado</label>
                                    <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                    <div class="valid-feedback">‚úì Correcto</div>
                                </div>
                                <span asp-validation-for="DeclaredBillValue" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="form-floating has-validation">
                                    <input asp-for="DeclaredCoinValue" type="number" step="1" class="form-control calculate-total-declared" placeholder="Valor en Monedas Declarado" required aria-required="true" />
                                    <label for="DeclaredCoinValue" class="required">Valor en Monedas Declarado</label>
                                    <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                    <div class="valid-feedback">‚úì Correcto</div>
                                </div>
                                <span asp-validation-for="DeclaredCoinValue" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="form-floating has-validation">
                                    <input asp-for="DeclaredDocumentValue" type="number" step="1" class="form-control calculate-total-declared" placeholder="Valor de Documentos Declarado" required aria-required="true" />
                                    <label for="DeclaredDocumentValue" class="required">Valor de Documentos Declarado</label>
                                    <div class="invalid-feedback">‚ö† Este campo es requerido</div>
                                    <div class="valid-feedback">‚úì Correcto</div>
                                </div>
                                <span asp-validation-for="DeclaredDocumentValue" class="text-danger"></span>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="form-floating">
                                    <input asp-for="TotalDeclaredValue" type="number" step="1" class="form-control" placeholder="Valor Total Declarado" readonly />
                                    <label for="TotalDeclaredValue">Valor Total Declarado</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea asp-for="InformativeIncident" class="form-control" placeholder="Novedad Informativa" style="height: 100px;"></textarea>
                                    <label for="InformativeIncident">Novedad Informativa</label>
                                </div>
                                <span asp-validation-for="InformativeIncident" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>‚öôÔ∏è Datos del Operador</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12 col-lg-4">
                                <div class="form-floating">
                                    <input asp-for="RegistrationDate" type="datetime-local" class="form-control" readonly />
                                    <label for="RegistrationDate">Fecha de Registro</label>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="form-floating">
                                    <input asp-for="RegistrationUserName" class="form-control" readonly />
                                    <label for="RegistrationUserName">Usuario de Registro</label>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="form-floating">
                                    <input asp-for="IPAddress" class="form-control" readonly />
                                    <label for="IPAddress">IP de Registro</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="submit-container form-group col-12 mt-4">
                    <button type="submit" class="btn btn-primary">Registrar</button>
                    <a asp-action="Index" class="btn btn-danger">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            $('#ServiceOrderId').on('change', function () {
                var serviceOrderId = $(this).val();
                if (serviceOrderId) {
                    $.ajax({
                        url: '@Url.Action("GetServiceDetails", "Cef")',
                        type: 'GET',
                        data: { serviceOrderId: serviceOrderId },
                        success: function (response) {
                            if (response && response.success) {
                                $('#ClientName').val(response.data.nombreCliente);
                                $('#BranchName').val(response.data.nombreSucursal);
                                $('#OriginLocationName').val(response.data.nombreUbicacionOrigen);
                                $('#DestinationLocationName').val(response.data.nombreUbicacionDestino);

                                $('#Currency').val(response.data.divisa);
                                $('#TransactionType').val(response.data.tipoTransaccion);

                                $('#DeclaredBillValue').val(response.data.valorBilletesDeclarado);
                                $('#DeclaredCoinValue').val(response.data.valorMonedasDeclarado);
                                $('#DeclaredDocumentValue').val(response.data.valorDocumentosDeclarado);

                                $('.calculate-total-declared').trigger('input');
                            } else if (response && response.message) {
                                alert('Error al cargar datos del servicio: ' + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            alert('Error al obtener detalles del servicio: ' + error);
                            console.error(xhr.responseText);
                        }
                    });
                } else {
                    $('#ClientName').val('');
                    $('#BranchName').val('');
                    $('#OriginLocationName').val('');
                    $('#DestinationLocationName').val('');
                    $('#DeclaredBillValue').val(0);
                    $('#DeclaredCoinValue').val(0);
                    $('#DeclaredDocumentValue').val(0);
                    $('.calculate-total-declared').trigger('input');
                }
            });

            $('#checkinForm').on('submit', function (e) {
                e.preventDefault();

                if (!$(this).valid()) {
                    return;
                }

                var formData = $(this).serialize();

                $.ajax({
                    url: '@Url.Action("Checkin", "Cef")',
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            window.location.href = '@Url.Action("ProcessContainers", "Cef")?transactionId=' + response.data;
                        } else {
                            alert('Error: ' + response.message);
                            if (response.errors) {
                                $('.field-validation-error').text('').hide();
                                $.each(response.errors, function (key, value) {
                                    var errorSpan = $('[data-valmsg-for="' + key + '"]');
                                    if (errorSpan.length === 0) {
                                        errorSpan = $('<span>').addClass('text-danger field-validation-error').attr('data-valmsg-for', key);
                                        $('[name="' + key + '"]').after(errorSpan);
                                    }
                                    errorSpan.text(value.join(' ')).show();
                                });
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Error al conectar con el servidor: ' + error);
                        console.error(xhr.responseText);
                    }
                });
            });

            function calculateTotalDeclared() {
                var total = 0;
                $('.calculate-total-declared').each(function () {
                    total += parseFloat($(this).val()) || 0;
                });
                $('#TotalDeclaredValue').val(total.toFixed(0));
            }

            $('.calculate-total-declared').on('input', calculateTotalDeclared);
            calculateTotalDeclared();
        });
    </script>
}

