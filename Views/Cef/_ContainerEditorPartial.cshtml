@model VCashApp.Models.ViewModels.CentroEfectivo.CefContainerProcessingViewModel
@using VCashApp.Enums;
@{
    var prefix = ViewData.TemplateInfo.HtmlFieldPrefix;
    bool esSobre = Model.ContainerType.ToString() == "Sobre";
}

<div class="container-editor border rounded p-3" data-prefix="@prefix">
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="CefTransactionId" />

    <div class="row g-3">
        <div class="col-12 col-lg-4">
            <div class="form-floating has-validation">
                <select class="form-select js-container-type" disabled>
                    @if (esSobre)
                    {
                        <option value="Sobre" selected>Sobre</option>
                    }
                    else
                    {
                        <option value="Bolsa" selected>Bolsa</option>
                    }
                </select>
                <label class="required">Tipo de contenedor</label>
                <div class="invalid-feedback">⚠ Este campo es requerido</div>
                <div class="valid-feedback">✓ Correcto</div>
            </div>
            <input type="hidden" name="@($"{prefix}.ContainerType")" value="@(esSobre ? "Sobre" : "Bolsa")" />
        </div>

        <div class="col-12 col-lg-3">
            <div class="form-floating has-validation">
                <input asp-for="ContainerCode" class="form-control" placeholder="Código" required aria-required="true" />
                <label class="required">Código del Contenedor</label>
                <div class="invalid-feedback">⚠ Requerido</div>
                <div class="valid-feedback">✓ Correcto</div>
            </div>
        </div>

        <!-- Sólo para SOBRES: selección de bolsa padre -->
        <div class="col-12 col-lg-3 js-parent-bag-block" style="display:@(esSobre ? "block" : "none")">
            <div class="form-floating has-validation">
                <select asp-for="ParentContainerId" class="form-select">
                    <option value="">-- Seleccione bolsa --</option>
                    @* (JS rellena las opciones) *@
                </select>
                <label>Bolsa asociada</label>
                <div class="invalid-feedback">⚠ Requerido</div>
                <div class="valid-feedback">✓ Correcto</div>
            </div>
        </div>

        <div class="col-12 col-lg-3">
            <div class="form-floating">
                <input asp-for="DeclaredValue" type="number" step="1" class="form-control" placeholder="Valor declarado" />
                <label>Valor declarado (opcional)</label>
            </div>
        </div>
    </div>

    <!-- ====== Sección BOLSA ====== -->
    <div class="sec-bolsa mt-3" style="display:@(!esSobre ? "block" : "none")">
        <div class="card">
            <div class="card-header"><h6 class="mb-0">💰 Bolsa — Detalle (Billetes/Monedas)</h6></div>
            <div class="card-body">
                <table class="table table-responsive table-sm align-middle js-details-table" data-detail-scope="bolsa">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Denominación</th>
                            <th class="col-calidad">Calidad</th>
                            <th>Cantidad</th>
                            <th>Fajos</th>
                            <th>Picos</th>
                            <th>Valor Unit.</th>
                            <th>Monto</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in Model.ValueDetails.Where(v => v.ValueType == VCashApp.Enums.CefValueTypeEnum.Billete || v.ValueType == VCashApp.Enums.CefValueTypeEnum.Moneda))
                        {
                            var idx = Model.ValueDetails.IndexOf(d);
                            var prefixDetail = $"{prefix}.ValueDetails[{idx}]";
                            <tr>
                                <input type="text" name="@($"{prefixDetail}.Id")" value="@d.Id" />
                                <td>
                                    <select name="@($"{prefixDetail}.ValueType")" class="form-select form-select-sm js-vtype">
                                        @Html.Raw($"<option value=\"Billete\" {(d.ValueType == CefValueTypeEnum.Billete ? "selected" : "")}>Billete</option>")
                                        @Html.Raw($"<option value=\"Moneda\" {(d.ValueType == CefValueTypeEnum.Moneda ? "selected" : "")}>Moneda</option>")
                                    </select>
                                </td>
                                <td>
                                    <select name="@($"{prefixDetail}.DenominationId")"
                                            class="form-select form-select-sm js-denom"
                                            data-selected="@d.DenominationId">
                                    </select>
                                </td>
                                <td>
                                    <select name="@($"{prefixDetail}.QualityId")"
                                            class="form-select form-select-sm js-quality"
                                            data-selected="@d.QualityId">
                                    </select>
                                </td>
                                <td><input name="@($"{prefixDetail}.Quantity")" type="number" class="form-control form-control-sm js-calc" value="@d.Quantity" /></td>
                                <td><input name="@($"{prefixDetail}.BundlesCount")" type="number" class="form-control form-control-sm js-calc" value="@d.BundlesCount" readonly /></td>
                                <td><input name="@($"{prefixDetail}.LoosePiecesCount")" type="number" class="form-control form-control-sm js-calc" value="@d.LoosePiecesCount" readonly /></td>
                                <td><input name="@($"{prefixDetail}.UnitValue")" type="number" step="1" class="form-control form-control-sm js-calc" value="@d.UnitValue" readonly /></td>
                                <td><input name="@($"{prefixDetail}.CalculatedAmount")" type="number" step="1" class="form-control form-control-sm" value="@d.CalculatedAmount" readonly /></td>
                                <td><button type="button" class="btn btn-sm btn-outline-danger js-remove-detail">×</button></td>
                            </tr>
                        }
                    </tbody>
                </table>
                <button type="button" class="btn btn-outline-primary btn-sm js-add-detail" data-detail-scope="bolsa">
                    + Agregar detalle
                </button>
            </div>
        </div>
    </div>

    <!-- ====== Sección SOBRE ====== -->
    <div class="sec-sobre mt-3" style="display:@(esSobre ? "block" : "none")">
        <div class="mb-2">
            <div class="form-check form-check-inline">
                <input class="form-check-input js-sobre-mode"
                       type="radio"
                       name="@($"{ViewData.TemplateInfo.HtmlFieldPrefix}.EnvelopeSubType")"
                       value="Efectivo" checked>
                <label class="form-check-label">Efectivo</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input js-sobre-mode"
                       type="radio"
                       name="@($"{ViewData.TemplateInfo.HtmlFieldPrefix}.EnvelopeSubType")"
                       value="Documento">
                <label class="form-check-label">Documentos/Voucher</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input js-sobre-mode"
                       type="radio"
                       name="@($"{ViewData.TemplateInfo.HtmlFieldPrefix}.EnvelopeSubType")"
                       value="Cheque">
                <label class="form-check-label">Cheques</label>
            </div>
        </div>

        <!-- Sobre: EFECTIVO -->
        <div class="sec-sobre-cash" style="display:@(Model.SobreMode == null || Model.SobreMode.ToString() == "Efectivo" ? "block" : "none")">
            <div class="card">
                <div class="card-header"><h6 class="mb-0">💵 Sobre — Efectivo (Billetes/Monedas)</h6></div>
                <div class="card-body">
                    <table class="table table-sm align-middle js-details-table" data-detail-scope="sobre-cash">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Denominación</th>
                                <th class="col-calidad">Calidad</th>
                                <th>Cantidad</th>
                                <th>Fajos</th>
                                <th>Picos</th>
                                <th>Valor Unit.</th>
                                <th>Monto</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" class="btn btn-outline-primary btn-sm js-add-detail" data-detail-scope="sobre-cash">
                        + Agregar detalle
                    </button>
                </div>
            </div>
        </div>

        <!-- Sobre: DOCUMENTOS/VOUCHERS -->
        <div class="sec-sobre-docs" style="display:@(Model.SobreMode?.ToString() == "Documento" ? "block" : "none")">
            <div class="card">
                <div class="card-header"><h6 class="mb-0">📄 Sobre — Documentos/Vouchers</h6></div>
                <div class="card-body">
                    <table class="table table-sm align-middle js-details-table" data-detail-scope="sobre-docs">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Denominación</th>
                                <th>Cantidad</th>
                                <th>Fajos</th>
                                <th>Picos</th>
                                <th>Valor Unit.</th>
                                <th>Monto</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" class="btn btn-outline-primary btn-sm js-add-detail" data-detail-scope="sobre-docs">
                        + Agregar documento
                    </button>
                </div>
            </div>
        </div>

        <!-- Sobre: CHEQUES -->
        <div class="sec-sobre-cheque" style="display:@(Model.SobreMode?.ToString() == "Cheque" ? "block" : "none")">
            <div class="card">
                <div class="card-header"><h6 class="mb-0">🏦 Sobre — Cheques</h6></div>
                <div class="card-body">
                    <table class="table table-sm align-middle js-cheques-table">
                        <thead>
                            <tr>
                                <th>Banco</th>
                                <th>Número</th>
                                <th>Fecha</th>
                                <th>Valor</th>
                                <th>Cantidad</th>
                                <th>Monto</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" class="btn btn-outline-primary btn-sm js-add-cheque">
                        + Agregar cheque
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Observaciones (común) -->
    <div class="mt-3">
        <div class="form-floating">
            <textarea asp-for="Observations" class="form-control" style="height:80px" placeholder="Observaciones"></textarea>
            <label>Observaciones</label>
        </div>
    </div>
</div>
