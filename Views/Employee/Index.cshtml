@model IEnumerable<VCashApp.Models.DTOs.EmpleadoListadoDto>

@{
    Layout = "_Layout";
    ViewData["Title"] = "Empleados";

    string currentSearchTerm = ViewBag.SearchTerm ?? "";
    int currentPage = ViewBag.CurrentPage ?? 1;
    int pageSize = ViewBag.PageSize ?? 15;

    bool canCreate = ViewBag.HasCreatePermission ?? false;
}

<div class="search-container">
    <div class="table-controls">
        <input type="text" id="tableSearch" placeholder="Buscar...">
        <div class="table-buttons">
            @if (canCreate)
            {
                <div class="control-button-wrapper">
                    <a href="@Url.Action("Create", "Employee")" class="control-button-icon" id="addEmployeeButton" title="Crear Empleado" data-loading>
                        <img src="/assets/icon-img/add.png" alt="Add Employee" loading="lazy">
                    </a>
                </div>
            }
            <div class="control-button-wrapper">
              <img src="/assets/icon-img/download.png" alt="Download" class="control-button-icon" id="downloadButton">
            </div>
            <div class="control-button-wrapper">
                <img src="/assets/icon-img/filter-on.png" alt="Filter" class="control-button-icon" id="filterButton">
            </div>
        </div>
    </div>
</div>

<div class="filter-sidebar" id="filterSidebar">
    <div class="filter-sidebar-content">
        <h3>Filtros Avanzados</h3>

        <div class="form-group">
            <label for="filterCargoId">Cargo:</label>
            @Html.DropDownList("cargoId", new SelectList(ViewBag.Cargos, "Value", "Text", ViewBag.CurrentCargoId), "Seleccione un Cargo", new { @class = "form-control", @id = "filterCargoId" })
        </div>

        <div class="form-group">
            <label for="filterBranchId">Sucursal:</label>
            @Html.DropDownList("branchId", new SelectList(ViewBag.Sucursales, "Value", "Text", ViewBag.CurrentBranchId), "Seleccione una Sucursal", new { @class = "form-control", @id = "filterBranchId" })
        </div>

        <div class="form-group">
            <label for="filterGender">Genero:</label>
            <select id="filterGender" name="gender" class="form-control form-control-sm">
                <option value="">Selecciona</option>
                <option value="M" selected="@(ViewBag.CurrentGender == "M")">MASCULINO</option>
                <option value="F" selected="@(ViewBag.CurrentGender == "F")">FEMENINO</option>
            </select>
        </div>

        <div class="form-group">
            <label for="filterEmployeeStatus">Estado:</label>
            @Html.DropDownList(
                "employeeStatus", 
                new SelectList(
                    Enum.GetValues(typeof(VCashApp.Enums.EstadoEmpleado)).Cast<VCashApp.Enums.EstadoEmpleado>()
                        .Select(e => new SelectListItem { 
                            Value = ((int)e).ToString(),
                            Text = e.ToString() 
                        }),
                    "Value", 
                    "Text",
                    ViewBag.CurrentEmployeeStatus
                ), 
                "Seleccione un Estado", 
                new { @class = "form-control", @id = "filterEmployeeStatus" }
            )
        </div>

        <div class="filter-buttons">
            <div class="cancel-filter-btn" id="clearFilters">
                <img src="~/assets/icon-img/filter-off.png" alt="OffFilterImage" title="Limpiar Filtros" id="clearFilters" />
            </div>
        </div>
    </div>
</div>

<div id="dataTablePartial">
    @Html.Partial("~/Views/Employee/_EmployeeTablePartial.cshtml", Model)
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="/js/main-control/employee.js"></script>
    <script>
        $(document).ready(function () {
            setupTablePaginationAndFilters({
                tableContainerId: 'dataTablePartial',
                controllerName: 'Employee',
                actionName: 'Index',
                searchInputId: 'tableSearch',
                filterInputsSelector: '#filterCargoId, #filterBranchId, #filterGender, #filterEmployeeStatus',
                clearFiltersButtonId: 'clearFilters',
                defaultPageSize: @pageSize
            });

            $('#downloadButton').on('click', function () {
                showConfirmationModal(
                    "Seleccione el formato de exportación deseado:",
                    async function (format) {
                        if (!format) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Sin selección',
                                text: 'No se seleccionó un formato de exportación.',
                                confirmButtonText: 'Entendido'
                            });
                            return;
                        }

                        AppLoading.show('Preparando archivo...', 'Esto puede tardar unos segundos.');

                        try {
                            const params = new URLSearchParams({
                                exportFormat: format,
                                search: $("#tableSearch").val() || '',
                                cargoId: $("#filterCargoId").val() || '',
                                branchId: $("#filterBranchId").val() || '',
                                gender: $("#filterGender").val() || '',
                                employeeStatus: $("#filterEmployeeStatus").val() || ''
                            });

                            const response = await fetch(`@Url.Action("ExportEmployee", "Employee")?${params.toString()}`, {
                                method: 'GET',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });

                            if (!response.ok) {
                                const contentType = response.headers.get('content-type');
                                let errorMessage = 'Ocurrió un error al exportar los datos.';
                    
                                if (contentType && contentType.includes('application/json')) {
                                    const errorData = await response.json();
                                    errorMessage = errorData.message || errorData || errorMessage;
                                } else {
                                    errorMessage = await response.text();
                                }

                                throw new Error(errorMessage);
                            }

                            const contentType = response.headers.get('content-type');
                
                            if (contentType && contentType.includes('application/json')) {
                                const data = await response.json();
                                throw new Error(data.message || 'Error desconocido al exportar.');
                            }

                            const blob = await response.blob();
                
                            const disposition = response.headers.get('Content-Disposition');
                            let filename = 'EMPLEADOS.' + format.toLowerCase();
                
                            if (disposition && disposition.includes('filename=')) {
                                const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(disposition);
                                if (matches != null && matches[1]) {
                                    filename = matches[1].replace(/['"]/g, '');
                                }
                            }

                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);

                            AppLoading.hide();

                            Swal.fire({
                                icon: 'success',
                                title: '¡Descarga exitosa!',
                                text: `El archivo se ha descargado correctamente.`,
                                timer: 3000,
                                showConfirmButton: false
                            });

                        } catch (error) {
                            AppLoading.hide();
                            Swal.fire({
                                icon: 'error',
                                title: 'Error en la exportación',
                                text: error.message || 'No se pudo completar la exportación.',
                                confirmButtonText: 'Entendido'
                            });
                
                            console.error('Error al exportar:', error);
                        }
                    },
                    "Exportar Datos",
                    null,
                    "btn-primary",
                    true
                );
            });
        });
    </script>
}